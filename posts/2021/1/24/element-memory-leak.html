<!DOCTYPE HTML>
<html lang="zh-cmn-Hans" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹ - hamflx&#x27;s blog</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="../../../../favicon.png">
        <link rel="stylesheet" href="../../../../css/variables.css">
        <link rel="stylesheet" href="../../../../css/general.css">
        <link rel="stylesheet" href="../../../../css/chrome.css">
        <link rel="stylesheet" href="../../../../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../../../../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../../../../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../../../../highlight.css">
        <link rel="stylesheet" href="../../../../tomorrow-night.css">
        <link rel="stylesheet" href="../../../../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../../../../css/custom.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../../../../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../../../index.html">ä¸ªäººå­¦ä¹ åˆ†äº«</a></li><li class="chapter-item expanded affix "><li class="part-title">æ–‡ç« æ¸…å•</li><li class="chapter-item expanded "><a href="../../../../posts/2023/2/28/call-net-from-rust-statically.html"><strong aria-hidden="true">1.</strong> é™æ€é“¾æ¥ C# åˆ° Rust</a></li><li class="chapter-item expanded "><a href="../../../../posts/2022/4/26/forward-dll.html"><strong aria-hidden="true">2.</strong> ä½¿ç”¨ Rust ç¼–å†™è½¬å‘ DLL</a></li><li class="chapter-item expanded "><a href="../../../../posts/2021/11/23/vite-compatibility.html"><strong aria-hidden="true">3.</strong> vite å…¼å®¹æ€§è¸©å‘è®°å½•</a></li><li class="chapter-item expanded "><a href="../../../../posts/2021/10/14/fe-ffmpeg.html"><strong aria-hidden="true">4.</strong> å‰ç«¯é€šè¿‡ ffmpeg åº“æ’­æ”¾è§†é¢‘</a></li><li class="chapter-item expanded "><a href="../../../../posts/2021/5/15/my-wordpress-config.html"><strong aria-hidden="true">5.</strong> åˆä¸€ä¸ª WordPress åšå®¢çš„åˆå§‹é…ç½®</a></li><li class="chapter-item expanded "><a href="../../../../posts/2021/1/24/element-memory-leak.html" class="active"><strong aria-hidden="true">6.</strong> è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹</a></li><li class="chapter-item expanded "><a href="../../../../posts/2020/11/13/vsc-vue-intelli-sense.html"><strong aria-hidden="true">7.</strong> å¢å¼º Vue é¡¹ç›®çš„æ™ºèƒ½æ„ŸçŸ¥</a></li><li class="chapter-item expanded "><a href="../../../../posts/2020/11/13/vuedraggable-usage.html"><strong aria-hidden="true">8.</strong> vuedraggable ä½¿ç”¨é—®é¢˜è®°å½•</a></li><li class="chapter-item expanded "><a href="../../../../posts/2019/3/22/dst-server.html"><strong aria-hidden="true">9.</strong> ç©é¥¥è’è”æœºç‰ˆæ—¥å¿—</a></li><li class="chapter-item expanded "><a href="../../../../posts/2023/2/11/fetch-browser.html"><strong aria-hidden="true">10.</strong> Chrome æ—¶ä»£çš„æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">hamflx&#x27;s blog</h1>

                    <div class="right-buttons">
                        <a href="../../../../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹"><a class="header" href="#è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹">è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹</a></h1>
<p><code>JavaScript</code> æ˜¯æœ‰åƒåœ¾å›æ”¶æœºåˆ¶çš„ï¼Œä¸€èˆ¬ä¸å¤ªéœ€è¦è€ƒè™‘èµ„æºé‡Šæ”¾çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œå³ä½¿æœ‰åƒåœ¾å›æ”¶å…œåº•ï¼Œä½†æ˜¯ä»£ç å†™çš„å¤ªè¿‡äºå¥”æ”¾ï¼Œä»ç„¶å­˜åœ¨ä¸å°çš„é—®é¢˜ã€‚è¿™ç¯‡æ–‡ç« å°±ä»¥ <code>********</code> æ’æŸ¥å‡ºçš„é—®é¢˜åšä¸ªç®€å•ä»‹ç»ï¼ˆæ³¨ï¼š<code>********</code> ä¸ºå†…éƒ¨é¡¹ç›®åç§°ï¼Œä¸‹åŒï¼‰ã€‚</p>
<h2 id="æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼"><a class="header" href="#æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼">æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼</a></h2>
<p>æœ‰ç”¨æˆ·åé¦ˆåœ¨ <code>********</code> ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¶å°”ä¼šå‡ºç°æµè§ˆå™¨å´©æºƒçš„é—®é¢˜ï¼Œç„¶ååœ¨ä¸€æ¬¡å‘ç‰ˆæœ¬çš„è¿‡ç¨‹ä¸­ï¼Œ<code>****</code> å‘ç°äº†å†…å­˜å ç”¨è¾¾åˆ°äº† <code>1GB</code> ç¨‹åº¦ï¼Œå¦‚ä¸‹å›¾ï¼ˆæˆªå›¾æ˜¯åæ¥æˆªçš„ï¼Œå«Œéº»çƒ¦å°±ç‚¹åˆ° <code>579MB</code>ï¼Œå¤šç‚¹å‡ æ¬¡æ€»æ˜¯èƒ½åˆ° <code>1GB</code> çš„ ğŸ˜ï¼‰ï¼š</p>
<p><img src="./assets/large-memory.png" alt="å†…å­˜å ç”¨" title="å†…å­˜å ç”¨" /></p>
<p>ä¸è¿‡è¿™ <code>579MB</code> æ˜¯æ­£å¸¸å†…å­˜å ç”¨ï¼Œè¿˜æ˜¯å†…å­˜æ³„æ¼äº†å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œå¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå†…å­˜å ç”¨æœªå¢åŠ ï¼Œæˆ–å¢åŠ çš„éƒ½èƒ½åœ¨ä¸€æ®µæ—¶é—´åï¼ˆ<code>GC</code> æ‰§è¡Œäº†ä¹‹åï¼‰æ­£å¸¸é‡Šæ”¾æ‰ï¼Œéƒ½æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå†…å­˜ä¸€ç›´å¢é•¿è€Œä»æœªå‡å°‘ï¼Œå³å­˜åœ¨å†…å­˜æ³„æ¼ã€‚</p>
<p>é€šè¿‡å¼€å‘è€…å·¥å…·é‡Œé¢çš„ <code>Memory</code> é¢æ¿ï¼Œå³å¯çœ‹åˆ°å†…å­˜å ç”¨ï¼Œä½¿ç”¨ <code>Heap snapshot</code> å·¥å…·å¯¹å†…å­˜å ç”¨åšå¿«ç…§ï¼Œåœ¨ä¸€é¡¿çŒ›çƒˆçš„æ“ä½œä¹‹å‰ä»¥åŠä¹‹åï¼Œåˆ†åˆ«åšå¿«ç…§ï¼Œç„¶åå¯¹æ¯”ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“æœ‰æ²¡æœ‰å†…å­˜æ³„æ¼äº†ã€‚</p>
<p>ä»¥ <code>********</code> ä¸¾ä¾‹è¯¦ç»†è¯´ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>å¼„æ¸…æ¥šä½ è¦æ’æŸ¥å“ªä¸€æ­¥å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œæ¯”å¦‚æˆ‘éœ€è¦æ’æŸ¥ <code>A</code> ä¸ <code>B</code> é¡µé¢<strong>æ¥å›åˆ‡æ¢æ—¶</strong>ï¼Œæ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ï¼›</li>
<li>å…ˆæ‰“å¼€ <code>********</code> çš„ B é¡µé¢<strong>ç­‰å¾…åŠ è½½å®Œæ¯•</strong>ï¼Œå› ä¸ºå¦‚æœä½ åˆ‡æ¢å¿«äº†ï¼Œå¯èƒ½ä¹Ÿä¼šé€ æˆå†…å­˜æ³„æ¼ï¼ˆæ¯”æ–¹è¯´ï¼Œåœ¨æ¥å£è¿”å›åæ·»åŠ äº‹ä»¶ï¼‰ï¼Œè¿™é‡Œè¦<strong>ä¸€æ­¥æ­¥</strong>æ’æŸ¥ï¼Œå°±æ˜¯æ§åˆ¶å˜é‡æ³•ï¼‰ï¼›</li>
<li>ç„¶å<strong>åˆ‡æ¢åˆ° A é¡µé¢</strong>ï¼Œåšå¿«ç…§ä¹‹å‰è¦<strong>å…ˆ</strong>æŠŠç›®æ ‡é¡µé¢<strong>åŠ è½½ä¸€æ¬¡</strong>ï¼Œå› ä¸ºâ€œå†·å¯åŠ¨â€ä¹Ÿæ˜¯è¦æ¶ˆè€—èµ„æºçš„ï¼›</li>
<li>å†åˆ‡æ¢å› B é¡µé¢ï¼Œåœ¨ <code>Memory</code> é¢æ¿ä¸­é€‰æ‹© <code>Heap snapshot</code> ç„¶åç‚¹ <code>Take snapshot</code> åšåˆå§‹çš„å¿«ç…§ï¼ˆåšå¿«ç…§ä¹‹å‰è¦ç‚¹å‡»ä¸€æ¬¡ <code>GC</code> æŒ‰é’®ï¼Œå‚ç…§ä¸‹å›¾ï¼‰ï¼›</li>
<li>ç‚¹å‡» A é¡µé¢ =&gt; ç‚¹å‡» B é¡µé¢ =&gt; ç‚¹å‡» A é¡µé¢ =&gt; ç‚¹å‡» B é¡µé¢ï¼Œåæ­£å°±æ˜¯ä¸€é¡¿æ“ä½œå°±æ˜¯äº†ï¼Œæ³¨æ„<strong>æ‰‹é€Ÿ</strong>ï¼Œ<strong>ä¸è¦</strong>æŠŠå…¶ä»–<strong>ä¸ç¡®å®šå› ç´ </strong>å¼•å…¥è¿›æ¥ï¼›</li>
<li>æœ€ååœç•™åœ¨åš<strong>åˆå§‹å†…å­˜å¿«ç…§</strong>çš„é¡µé¢ï¼Œè¿™é‡Œæ˜¯ B é¡µé¢ï¼Œç„¶åå†åšä¸€ä¸ªå†…å­˜å¿«ç…§ï¼ˆåˆ«å¿˜äº†å…ˆç‚¹ <code>GC</code> æŒ‰é’®ï¼‰ï¼›</li>
<li>å¯¹æ¯”ä¸€ä¸‹ä¸¤ä¸ªæ•°å­—å°±å¥½äº†ï¼Œå¦‚æœæ²¡æœ‰å¤ªå¤§å·®è·çš„è¯ï¼Œæ˜¾ç„¶æ˜¯æ²¡æœ‰å†…å­˜æ³„æ¼çš„ï¼ˆå½“ç„¶ï¼Œä¸ºäº†é¿å…è¯¯åˆ¤ï¼Œä½ å¯ä»¥å¤šé‡å¤å‡ æ¬¡ç¬¬ <code>5</code> æ­¥çš„æ“ä½œï¼‰ï¼Œå¦åˆ™ï¼Œå­˜åœ¨å†…å­˜æ³„æ¼ã€‚</li>
</ol>
<p><img src="./assets/devtools-memory-panel.png" alt="Memory é¢æ¿" title="Memory é¢æ¿" /></p>
<p>ä¸‹é¢æ˜¯ <code>********</code> çš„ï¼ˆå½“ç„¶æ˜¯ç‚¹äº†å¾ˆå¤šå¾ˆå¤šæ¬¡æ‰ä¼šæœ‰è¿™ä¸ªæ•°æ®çš„ ğŸ¤£ï¼‰ï¼š</p>
<p><img src="./assets/memory-snapshots.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<h2 id="æ’æŸ¥é—®é¢˜æ ¹æº"><a class="header" href="#æ’æŸ¥é—®é¢˜æ ¹æº">æ’æŸ¥é—®é¢˜æ ¹æº</a></h2>
<p><img src="./assets/memory-snapshot-summary.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>æ‹¿å‡ºä¸Šé¢æ­¥éª¤çš„ç¬¬äºŒä¸ªå¿«ç…§ï¼ˆå›¾ç‰‡é‡Œåªæœ‰ä¸€ä¸ªæ˜¯å› ä¸ºæˆ‘æŠŠç¬¬ä¸€ä¸ªåˆ äº†ï¼‰ï¼Œå±•å¼€ <code>a</code>ï¼ˆå°±æ˜¯ <code>VueComponent</code>ï¼Œç»éªŒï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ª <code>a</code> çš„â€œä¸‰å›´â€ï¼š</p>
<ul>
<li><code>Distance</code> 14 è¢«å¼•ç”¨çš„æ·±åº¦ï¼Œè¡¨ç¤ºç”± <code>GC</code> æ ¹ï¼ˆæ¯”å¦‚ <code>window</code> å¯¹è±¡ã€DOM æ•°æ ¹èŠ‚ç‚¹ï¼‰åˆ°è¯¥å¯¹è±¡ä¹‹é—´æœ€çŸ­çš„å¼•ç”¨æ•°é‡ã€‚</li>
<li><code>Shallow Size</code> æµ…å±‚å¤§å°ï¼Œè¯¥å¯¹è±¡æœ¬èº«çš„å¤§å°ã€‚</li>
<li><code>Reatined Size</code> ä¿ç•™å¤§å°ï¼Œè¡¨ç¤ºå¦‚æœå½“å‰å¯¹è±¡è¢«é‡Šæ”¾åï¼Œæ‰€æœ‰çš„ä» <code>GC</code> æ ¹æ— æ³•è¾¾åˆ°çš„å¯¹è±¡çš„æ€»çš„å¤§å°ï¼Œç®€å•ç‚¹è¯´ï¼Œé‡Šæ”¾äº†è¿™ä¸ªå¯¹è±¡ï¼Œèƒ½é‡Šæ”¾å¤šå°‘å†…å­˜ã€‚</li>
</ul>
<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>Distance</code> å’Œ <code>Reatined Size</code>ï¼Œå‰è€…å¦‚æœè¾ƒå¤§ï¼Œæˆ‘ä»¬å¯èƒ½å°±è¦å…³æ³¨ä¸€ä¸‹è¿™ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ã€‚æ¯”å¦‚ç¬¬ä¸€ä¸ª <code>a</code> å¯¹è±¡ï¼Œé¼ æ ‡æ‚¬æµ® <code>a @8001491</code> åï¼Œèƒ½çœ‹åˆ°è¯¥å¯¹è±¡çš„æ•°æ®ï¼š</p>
<p><img src="./assets/memory-snapshot-first-a-detail.png" alt="å†…å­˜å¿«ç…§-ç¬¬ä¸€ä¸ªaå¯¹è±¡" title="å†…å­˜å¿«ç…§-ç¬¬ä¸€ä¸ªaå¯¹è±¡" /></p>
<p>å‘ç°å®ƒæ˜¯ä¸€ä¸ª <code>Vue</code> ç»„ä»¶çš„å®ä¾‹ï¼Œé¼ æ ‡æ‚¬æµ®åˆ° <code>$el</code> çš„å€¼ä¸Šé¢ï¼Œå¦‚æœè¿™ä¸ªå…ƒç´ ä»ç„¶åœ¨é¡µé¢ä¸Šä¸”æ˜¯å¯è§çš„ï¼Œå®ƒå°±ä¼šåƒå®¡æŸ¥å…ƒç´ æ—¶ä¸€æ ·è¦†ç›–ä¸€å±‚è“è‰²çŸ©å½¢åŒºåŸŸï¼Œæ˜¾ç„¶è¿™ä¸ªæ²¡æœ‰ï¼ˆå¯ä»¥å†å±•å¼€å…¶å±æ€§ï¼Œçœ‹çœ‹ <code>isConnected</code>ã€<code>className</code>ã€<code>innerHTML</code> äº†è§£å…·ä½“æ˜¯å“ªé‡Œçš„é€»è¾‘ï¼Œä»¥åŠæ˜¯å¦ä» <code>DOM</code> æ ‘ä¸Šç§»é™¤äº†ï¼Œè¿™é‡Œçš„è¿™ä¸ªå®ä¾‹æ˜¯ä¸€ä¸ªè¡¨æ ¼ç»„ä»¶ï¼‰ã€‚è€Œå®ƒçš„ <code>Retained Size</code> åˆ™è¡¨ç¤ºäº†ï¼Œå¦‚æœæŠŠè¿™ä¸ªå¯¹è±¡ç»™é‡Šæ”¾äº†ï¼Œå¯ä»¥é‡Šæ”¾çº¦ <code>1MB</code> 2% çš„å†…å­˜ã€‚</p>
<p>ç‚¹å‡»è¿™ä¸ªå¯¹è±¡å¯ä»¥çœ‹åˆ°ç”±è¯¥å¯¹è±¡åˆ° <code>GC</code> æ ¹çš„å¼•ç”¨å…³ç³»ï¼š</p>
<p><img src="./assets/memory-snapshot-detail.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>è¿™å¼ å›¾è¯´æ˜ï¼šè¿™ä¸ªè¡¨æ ¼ç»„ä»¶æ˜¯å¦ä¸€ä¸ª <code>a</code>ï¼ˆ<code>VueComponent</code>ï¼‰ç»„ä»¶çš„ <code>$parent</code> å±æ€§ï¼Œå³ä½œä¸ºå¦ä¸€ä¸ªç»„ä»¶çš„çˆ¶ç»„ä»¶è€Œè¢«å¼•ç”¨äº†ï¼Œä¸²è”èµ·æ¥å°±æ˜¯ï¼Œè¿™ä¸ªè¡¨æ ¼ç»„ä»¶è¢«å­ç»„ä»¶å¼•ç”¨äº†ï¼Œå­ç»„ä»¶åˆè¢«å­ç»„ä»¶å¼•ç”¨äº†è€Œå­ç»„ä»¶åˆè¢«å­ç»„ä»¶å¼•ç”¨äº†ï¼Œè€Œè¿™ä¸ªå­ç»„ä»¶åˆè¢«ä¸€ä¸ªæ–¹æ³•å¼•ç”¨äº†ï¼ˆè¿™ä¸ªæ–¹æ³•ä½¿ç”¨ <code>bind</code> ç»‘å®šäº†è¿™ä¸ªç»„ä»¶ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•åˆè¢«ä½œä¸ºä¸€ä¸ª <code>DOM</code> å…ƒç´ çš„äº‹ä»¶è¢«å¼•ç”¨äº†ï¼Œè€Œè¿™ä¸ª <code>DOM</code> å…ƒç´ åˆè¢« <code>InternalNode</code> å¼•ç”¨äº†ï¼Œè¿™ä¸ª <code>InternalNode</code> å±äº <code>HTMLDocument</code>ã€‚</p>
<p>å³ï¼Œè¿™ä¸ªè¡¨æ ¼é‡Œé¢æœ‰ä¸ªç»„ä»¶æ·»åŠ äº†äº‹ä»¶ï¼Œä½†æ˜¯ç»„ä»¶é”€æ¯çš„æ—¶å€™æ²¡æœ‰æŠŠäº‹ä»¶ç§»é™¤ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªå…ƒç´ æ³„æ¼äº†ï¼Œå¯¼è‡´æ•´ä¸ªè¡¨æ ¼æ³„æ¼äº†ã€‚</p>
<p>å°†é¼ æ ‡æ‚¬æµ®åˆ° <code>bound_this in native_bind() @7606219</code> ä¸Šï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="./assets/memory-snapshot-first-a-event.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>æ‰¾åˆ°äº†è¿™ä¸ªè¢«æ·»åŠ è€Œæ²¡æœ‰è¢«ç§»é™¤çš„äº‹ä»¶å« <code>handleBlur</code>ã€‚OKï¼Œä½ ç°åœ¨æ˜¯ä¸æ˜¯æƒ³å…¨å±€æœç´¢ <code>handleBlur</code> æ–¹æ³•äº†ï¼Ÿ</p>
<p><img src="./assets/found-handle-blur.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>è¿˜çœŸæœåˆ°äº†ã€‚ã€‚ã€‚ä¸è¿‡ï¼Œè¿™æ ·å¤ªéº»çƒ¦äº†ï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ª <code>bind</code> ç»‘å®šçš„åˆ°åº•æ˜¯å“ªä¸ªç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯é¼ æ ‡æ‚¬æµ®è¿™ä¸ªä¸Šé¢çš„é‚£ä¸€æ¡è®°å½• <code>$parent in a @9400441</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="./assets/memory-snapshot-first-a-dep-detail.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>é€šè¿‡å®¡æŸ¥è¿™ä¸ªå¯¹è±¡çš„ <code>$el</code> å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>el-popover</code> ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>el-popover</code> ç›‘å¬äº† <code>handleBlur</code> äº‹ä»¶ï¼Œä½†æ˜¯å´æ²¡æœ‰ç§»é™¤ï¼Œæ‰“å¼€ <code>element</code> ä»“åº“åœ¨ <code>packages\popover\src\main.vue</code> ä¸­æœç´¢ <code>handleBlur</code>ï¼š</p>
<p><img src="./assets/element-popover-handle-blur.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåªæ·»åŠ äº†è¯¥äº‹ä»¶ï¼Œè€Œæ²¡æœ‰ç§»é™¤è¯¥äº‹ä»¶ã€‚</p>
<h2 id="ä¿®å¤å†…å­˜æ³„æ¼é—®é¢˜"><a class="header" href="#ä¿®å¤å†…å­˜æ³„æ¼é—®é¢˜">ä¿®å¤å†…å­˜æ³„æ¼é—®é¢˜</a></h2>
<p><code>Google</code> æœç´¢ <code>el-popover å†…å­˜æ³„æ¼</code>ï¼Œç„¶åå¤åˆ¶ã€ç²˜è´´ï¼Œ<code>over</code>ã€‚ä¸å¯¹ï¼Œæœç´¢ç»“æœç¬¬ä¸€æ¡æ˜¯ï¼š</p>
<blockquote>
<p>el-popover leaking memory Â· Issue #2561 Â· ElemeFE/element ...</p>
</blockquote>
<p>2017 å¹´çš„ <code>Issue</code>ï¼Œç‚¹å¼€ä¸€çœ‹ï¼Œå¯¹åº”çš„ <code>PR</code> å·²ç»åˆå¹¶äº†ï¼Œè€Œä¸”æ˜¯ç‚¹å‡»äº‹ä»¶ï¼Œä¸æ˜¯ <code>focusout</code> äº‹ä»¶ï¼Œéš¾é“æ˜¯å®šä½é”™äº†ï¼Ÿå…¶å®ç”¨ <code>el-tooltip å†…å­˜æ³„æ¼</code>ã€<code>el-popover memory leak</code> ä¸ºå…³é”®å­—æœç´¢æ˜¯å¯ä»¥æœç´¢åˆ° <a href="https://github.com/ElemeFE/element/issues/19370" title="[Bug Report] Memory leak at el-tooltip cleanup">[Bug Report] Memory leak at el-tooltip cleanup</a>ï¼Œæè¿™ä¸ª <code>bug</code> çš„ä»å…„è¿˜æäº†ä¸¤ä¸ª <code>PR</code> ä¿®å¤ <code>el-tooltip</code>ï¼Œè¿˜æœ‰ä½ä»å…„ä¹Ÿæäº† <code>PR</code> ä¿®å¤ <code>el-tooltip</code> å’Œ <code>el-popover</code>ï¼Œç„¶è€Œã€‚ã€‚ã€‚</p>
<p>ä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸å…‹éš† <code>element</code> ä»“åº“ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™å¯¹åº”çš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘æ‹¿ <code>el-tooltip</code> ä¸¾ä¾‹ï¼ŒåŸç‰ˆçš„ <code>el-tooltip</code> çš„ <code>mounted</code> ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">export default {
    // code ...

    mounted() {
        this.referenceElm = this.$el;
        if (this.$el.nodeType === 1) {
            this.$el.setAttribute('aria-describedby', this.tooltipId);
            this.$el.setAttribute('tabindex', this.tabindex);
            on(this.referenceElm, 'mouseenter', this.show);
            on(this.referenceElm, 'mouseleave', this.hide);
            on(this.referenceElm, 'focus', () =&gt; {
                if (!this.$slots.default || !this.$slots.default.length) {
                    this.handleFocus();
                    return;
                }
                const instance = this.$slots.default[0].componentInstance;
                if (instance &amp;&amp; instance.focus) {
                    instance.focus();
                } else {
                    this.handleFocus();
                }
            });
            on(this.referenceElm, 'blur', this.handleBlur);
            on(this.referenceElm, 'click', this.removeFocusing);
        }
    },

    // code ...

    destroyed() {
        const reference = this.referenceElm;
        if (reference.nodeType === 1) {
            off(reference, 'mouseenter', this.show);
            off(reference, 'mouseleave', this.hide);
            // è¿™é‡Œç§»é™¤äº† handleBlur æ–¹æ³•ï¼Œä½†æ˜¯å‰é¢æ·»åŠ çš„ä¸æ˜¯è¿™ä¸ªæ–¹æ³•ã€‚ã€‚ã€‚
            off(reference, 'focus', this.handleFocus);
            off(reference, 'blur', this.handleBlur);
            off(reference, 'click', this.removeFocusing);
        }
    }
}
</code></pre>
<p>é€šè¿‡å¦‚ä¸‹æ–¹æ³•é‡æ–°å®ç°å®ƒçš„ç›¸å…³æ–¹æ³•ï¼š</p>
<pre><code class="language-javascript">import { Tooltip } from 'element-ui'
import { on } from 'element-ui/lib/utils/dom'

Tooltip.methods.handleFocus = function () {
  if (!this.$slots.default || !this.$slots.default.length) {
    this.doFocus()
    return
  }
  const instance = this.$slots.default[0].componentInstance
  if (instance &amp;&amp; instance.focus) {
    instance.focus()
  } else {
    this.doFocus()
  }
}

Tooltip.methods.doFocus = function () {
  this.focusing = true
  this.show()
}

Tooltip.mounted = function () {
  this.referenceElm = this.$el
  if (this.$el.nodeType === 1) {
    this.$el.setAttribute('aria-describedby', this.tooltipId)
    // è¿™è¡Œä»£ç åœ¨ Element ä¸Šçš„æäº¤æ—¥å¿—æ˜¯ä¸ºäº†æ— éšœç¢è®¿é—®ï¼Œè¿™å°†å¯¼è‡´æµ‹è¯•æä¸€äº› bugï¼ˆç‚¹å‡»ç©ºç™½å¤„å…³é—­è¯¦æƒ…é¡µåï¼Œæ–‡å­—çš„ tooltip ä»ç„¶æ˜¾ç¤ºï¼‰ã€‚
    // this.$el.setAttribute('tabindex', 0)
    on(this.referenceElm, 'mouseenter', this.show)
    on(this.referenceElm, 'mouseleave', this.hide)
    on(this.referenceElm, 'focus', this.handleFocus)
    on(this.referenceElm, 'blur', this.handleBlur)
    on(this.referenceElm, 'click', this.removeFocusing)
  }
}

export default {
  install () {

  }
}
</code></pre>
<p>å³ï¼Œå°†åŸæ¥ç›´æ¥æ·»åŠ çš„äº‹ä»¶ï¼Œå†™æˆ <code>handleFocus</code> æ–¹æ³•ï¼ˆåŸæ¥ä¹Ÿæœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæ•…æŠŠåŸæ¥çš„ <code>handleFocus</code> æ–¹æ³•æ”¹ä¸º <code>doFocus</code> æ–¹æ³•ï¼Œç„¶ååœ¨ <code>handleFocus</code> æ–¹æ³•é‡Œè°ƒç”¨ï¼Œè¿™æ ·å…¶ <code>destroyed</code> é‡Œé¢é‡Šæ”¾çš„äº‹ä»¶å°±æ˜¯æ·»åŠ çš„äº‹ä»¶äº†ã€‚</p>
<h2 id="å…¶ä»–é—®é¢˜"><a class="header" href="#å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</a></h2>
<p>é€šè¿‡åŒæ ·çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥æ‰¾åˆ°å®šæ—¶å™¨æœªé‡Šæ”¾ã€ç‚¹å‡»äº‹ä»¶æœªé‡Šæ”¾ä¹‹ç±»çš„é—®é¢˜ï¼Œä½†éƒ½æ˜¯é¡¹ç›®å†…çš„ä»£ç ï¼Œæ¯”è¾ƒå¥½è§£å†³å°±ä¸å±•å¼€äº†ã€‚</p>
<h2 id="æˆæœ"><a class="header" href="#æˆæœ">æˆæœ</a></h2>
<p><img src="./assets/result.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<h2 id="æ·±å…¥æ€è€ƒ"><a class="header" href="#æ·±å…¥æ€è€ƒ">æ·±å…¥æ€è€ƒ</a></h2>
<p>ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„ï¼Œæœç´¢ä¸­æ–‡çš„ <code>el-popover</code> å†…å­˜æ³„æ¼æ²¡æœ‰æœç´¢åˆ°æƒ³è¦çš„ç»“æœï¼Œå…¶å®ä¸ç§»é™¤äº‹ä»¶ä¸€èˆ¬ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè€Œä¸”ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æ¯”è¾ƒéš¾ä»¥å‘ç°è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ç°ä»£æµè§ˆå™¨éƒ½æ˜¯ç”¨ <code>æ ‡è®°</code>-<code>æ¸…é™¤</code> ç®—æ³•æˆ–åŸºäºå…¶æ”¹è¿›çš„ç®—æ³•æ¥å®ç°çš„åƒåœ¾å›æ”¶ã€‚å…¶åŸç†æ˜¯ä» <code>GC</code> æ ¹å¼€å§‹ï¼Œéå†æ‰€æœ‰å¼•ç”¨çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶æ ‡è®°ï¼Œå½“ç®—æ³•éå†å®Œæ‰€æœ‰å¯¹è±¡åï¼Œé‚£äº›æœªè¢«æ ‡è®°çš„å¯¹è±¡å°†ä¼šè¢«æ¸…é™¤ã€‚</p>
<p>è€Œ <code>Vue.js</code> ä¼šåœ¨ç»„ä»¶è¢«é”€æ¯çš„æ—¶å€™ï¼Œé‡Šæ”¾å…¶å¼•ç”¨ï¼Œé‚£ä¹ˆå…¶å¼•ç”¨çš„å…ƒç´ ï¼Œä»¥åŠå…ƒç´ å¼•ç”¨çš„äº‹ä»¶éƒ½å°†æˆä¸ºæ— æ ¹æµ®èï¼Œä¼šè¢« <code>GC</code> å›æ”¶ã€‚</p>
<p>å†æ¬¡å®¡æŸ¥ä¸Šæ–‡ä¸­çš„è¡¨æ ¼ç»„ä»¶ï¼Œå¯ä»¥å‘ç° <code>V8EventListener</code> è¢« <code>Detached HTMLElement</code> å¼•ç”¨ï¼Œè€Œ <code>Detached HTMLElement</code> åˆè¢« <code>InternalNode</code> å¼•ç”¨ï¼Œè¿™ä¸ª <code>InternalNode</code> æ‰æ˜¯å®ƒæ²¡æœ‰è¢«é‡Šæ”¾çš„çœŸæ­£åŸå› ã€‚</p>
<p>è‡³äºè¿™ä¸ª <code>InternalNode</code> ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬ <code>N</code> æœŸä¹‹åå†è¯´ï¼ˆ<code>N â†’ âˆ</code>ï¼‰ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a class="header" href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li><a href="https://developers.google.com/web/tools/chrome-devtools/memory-problems/memory-101?hl=zh-cn" title="å†…å­˜æœ¯è¯­">å†…å­˜æœ¯è¯­</a></li>
<li><a href="https://developers.google.com/web/tools/chrome-devtools/memory-problems/heap-snapshots?hl=zh-cn" title="å¦‚ä½•è®°å½•å †å¿«ç…§">å¦‚ä½•è®°å½•å †å¿«ç…§</a></li>
<li><a href="https://github.com/ElemeFE/element/issues/19370" title="[Bug Report] Memory leak at el-tooltip cleanup">[Bug Report] Memory leak at el-tooltip cleanup</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management" title="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../../../../posts/2021/5/15/my-wordpress-config.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../../../../posts/2020/11/13/vsc-vue-intelli-sense.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
                <script>
                
                    document.body.querySelector('main').insertAdjacentHTML('beforeend', `
                        <div id="disqus_thread"></div>
                    `);
                    /**
                    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
                
                    var disqus_config = function () {
                    this.page.url = undefined;  // Replace PAGE_URL with your page's canonical URL variable
                    this.page.identifier = 'posts/2021/1/24/element-memory-leak.md'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                    };
                
                    (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = 'https://hamflx-blog.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                
                <!-- Global site tag (gtag.js) - Google Analytics -->
                <script async src="https://www.googletagmanager.com/gtag/js?id=G-8V723V89LY"></script>
                <script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());
                
                  gtag('config', 'G-8V723V89LY');
                </script>
                
                <div class="icp">
                  <a class="icp-link" href="https://beian.miit.gov.cn/" target="_blank">çš–ICPå¤‡16015010å·-2</a>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../../../../posts/2021/5/15/my-wordpress-config.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../../../../posts/2020/11/13/vsc-vue-intelli-sense.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../../../../elasticlunr.min.js"></script>
        <script src="../../../../mark.min.js"></script>
        <script src="../../../../searcher.js"></script>

        <script src="../../../../clipboard.min.js"></script>
        <script src="../../../../highlight.js"></script>
        <script src="../../../../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
