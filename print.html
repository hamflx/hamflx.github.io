<!DOCTYPE HTML>
<html lang="zh-cmn-Hans" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>hamflx&#x27;s blog</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="css/custom.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="index.html">ä¸ªäººå­¦ä¹ åˆ†äº«</a></li><li class="chapter-item expanded affix "><li class="part-title">æ–‡ç« æ¸…å•</li><li class="chapter-item expanded "><a href="posts/2023/2/28/call-net-from-rust-statically.html"><strong aria-hidden="true">1.</strong> é™æ€é“¾æ¥ C# åˆ° Rust</a></li><li class="chapter-item expanded "><a href="posts/2022/4/26/forward-dll.html"><strong aria-hidden="true">2.</strong> ä½¿ç”¨ Rust ç¼–å†™è½¬å‘ DLL</a></li><li class="chapter-item expanded "><a href="posts/2021/11/23/vite-compatibility.html"><strong aria-hidden="true">3.</strong> vite å…¼å®¹æ€§è¸©å‘è®°å½•</a></li><li class="chapter-item expanded "><a href="posts/2021/10/14/fe-ffmpeg.html"><strong aria-hidden="true">4.</strong> å‰ç«¯é€šè¿‡ ffmpeg åº“æ’­æ”¾è§†é¢‘</a></li><li class="chapter-item expanded "><a href="posts/2021/5/15/my-wordpress-config.html"><strong aria-hidden="true">5.</strong> åˆä¸€ä¸ª WordPress åšå®¢çš„åˆå§‹é…ç½®</a></li><li class="chapter-item expanded "><a href="posts/2021/1/24/element-memory-leak.html"><strong aria-hidden="true">6.</strong> è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹</a></li><li class="chapter-item expanded "><a href="posts/2020/11/13/vsc-vue-intelli-sense.html"><strong aria-hidden="true">7.</strong> å¢å¼º Vue é¡¹ç›®çš„æ™ºèƒ½æ„ŸçŸ¥</a></li><li class="chapter-item expanded "><a href="posts/2020/11/13/vuedraggable-usage.html"><strong aria-hidden="true">8.</strong> vuedraggable ä½¿ç”¨é—®é¢˜è®°å½•</a></li><li class="chapter-item expanded "><a href="posts/2019/3/22/dst-server.html"><strong aria-hidden="true">9.</strong> ç©é¥¥è’è”æœºç‰ˆæ—¥å¿—</a></li><li class="chapter-item expanded "><a href="posts/2023/2/11/fetch-browser.html"><strong aria-hidden="true">10.</strong> Chrome æ—¶ä»£çš„æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">hamflx&#x27;s blog</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="ä¸ªäººå­¦ä¹ åˆ†äº«"><a class="header" href="#ä¸ªäººå­¦ä¹ åˆ†äº«">ä¸ªäººå­¦ä¹ åˆ†äº«</a></h1>
<p>æš‚æ— ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="é™æ€é“¾æ¥-c-åˆ°-rust"><a class="header" href="#é™æ€é“¾æ¥-c-åˆ°-rust">é™æ€é“¾æ¥ C# åˆ° Rust</a></h1>
<p>æœ€è¿‘ <code>.Net 7</code> å‘å¸ƒä¹‹åï¼Œå› ä¸ºå¸¦äº† <code>AOT</code> ç¼–è¯‘å™¨ï¼Œåˆçˆ†å‘äº†ä¸€æ³¢çƒ­åº¦ï¼Œæ­£å¥½æˆ‘æœ€è¿‘æœ‰éœ€æ±‚éœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ªåŠŸèƒ½ï¼Œæœ¬æ–‡å°±è®°å½•ä¸‹å¦‚ä½•å®ç°å°† <code>.Net 7</code> åº“ç¼–è¯‘æˆé™æ€åº“ï¼Œç„¶åç”¨ <code>Rust</code> é“¾æ¥ã€‚</p>
<p>æœ¬æ–‡å®ç°çš„æ˜¯å°†ä¸€ä¸ªéæ ‡å‡†çš„ <code>DES</code> ç®—æ³•ç¼–è¯‘æˆé™æ€åº“ï¼Œä¾› <code>Rust</code> è°ƒç”¨ã€‚è¯¥ <code>DES</code> ç®—æ³•çš„ <code>C#</code> å®ç°åœ¨è¿™é‡Œå¯ä»¥æ‰¾åˆ°ï¼š<a href="https://github.com/fygroup/Security/blob/master/DES.cs">https://github.com/fygroup/Security/blob/master/DES.cs</a>ã€‚</p>
<p>æœ¬æ–‡é¡¹ç›®çš„ç›®å½•ç»“æ„ä¸ºï¼š</p>
<pre><code class="language-plaintext">./call-net-from-rust-statically
  â”œâ”€â”€ des-lib
  â”‚   â”œâ”€â”€ des-lib.csproj
  â”‚   â””â”€â”€ DES.cs
  â”œâ”€â”€ Cargo.toml
  â”œâ”€â”€ build.rs
  â””â”€â”€ src
      â””â”€â”€ main.rs
</code></pre>
<p>å…ˆåˆ›å»ºå¥½ <code>call-net-from-rust-statically</code> ç›®å½•ï¼š</p>
<pre><code class="language-powershell">mkdir call-net-from-rust-statically
</code></pre>
<h2 id="c-é¡¹ç›®éƒ¨åˆ†"><a class="header" href="#c-é¡¹ç›®éƒ¨åˆ†">C# é¡¹ç›®éƒ¨åˆ†</a></h2>
<p>é¦–å…ˆåˆ›å»ºé¡¹ç›®ï¼š</p>
<pre><code class="language-powershell">cd call-net-from-rust-statically
dotnet new classlib -n des-lib
</code></pre>
<p>å°† <code>Class1.cs</code> é‡å‘½åä¸º <code>DES.cs</code>ï¼Œç„¶åæŠŠä¸Šé¢é“¾æ¥ä¸­çš„ <code>DES</code> ç±»å¤åˆ¶åˆ° <code>DES.cs</code> ä¸­ï¼Œæ”¹ä¸‹å‘½åç©ºé—´ï¼Œå†åŠ ä¸Šå¯¼å‡ºå‡½æ•°çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p>
<pre><code class="language-csharp">namespace des_lib;

using System.Runtime.InteropServices;

public class DES
{
  [UnmanagedCallersOnly(EntryPoint = &quot;wtf_des_encrypt&quot;)]
  public static nint FFI_Encrypt(nint message, nint key)
  {
    var managedMessage = Marshal.PtrToStringUTF8(message);
    var managedKey = Marshal.PtrToStringUTF8(key);
    if (managedKey == null || managedMessage == null)
    {
      return nint.Zero;
    }
    var cipherText = EncryptDES(managedMessage, managedKey);
    return Marshal.StringToHGlobalAnsi(cipherText);
  }

  [UnmanagedCallersOnly(EntryPoint = &quot;wtf_des_decrypt&quot;)]
  public static nint FFI_Decrypt(nint cipherMessage, nint key)
  {
    var managedCipherMessage = Marshal.PtrToStringUTF8(cipherMessage);
    var managedKey = Marshal.PtrToStringUTF8(key);
    if (managedKey == null || managedCipherMessage == null)
    {
      return nint.Zero;
    }
    var plainText = DecryptDES(managedCipherMessage, managedKey);
    return Marshal.StringToHGlobalAnsi(plainText);
  }

  [UnmanagedCallersOnly(EntryPoint = &quot;wtf_des_free&quot;)]
  public static void FFI_FreeMemory(nint buffer)
  {
    Marshal.FreeHGlobal(buffer);
  }

  // å°†åŸæœ‰ DES ç±»çš„å†…å®¹æ”¾åœ¨è¿™é‡Œã€‚
}
</code></pre>
<p>å…¶ä¸­ <code>wtf_des_encrypt</code>ã€<code>wtf_des_decrypt</code> å’Œ <code>wtf_des_free</code> å°±æ˜¯å¯¼å‡ºçš„åŠ å¯†ã€è§£å¯†ä»¥åŠé‡Šæ”¾å†…å­˜çš„æ–¹æ³•ã€‚</p>
<p>é…ç½®é¡¹ç›®çš„å±æ€§ï¼š</p>
<pre><code class="language-xml">&lt;Project Sdk=&quot;Microsoft.NET.Sdk&quot;&gt;

  &lt;PropertyGroup&gt;
    &lt;TargetFramework&gt;net7.0&lt;/TargetFramework&gt;
    &lt;NativeLib&gt;Static&lt;/NativeLib&gt;
    &lt;PublishAot&gt;true&lt;/PublishAot&gt;
    &lt;StripSymbols&gt;true&lt;/StripSymbols&gt;
    &lt;SelfContained&gt;true&lt;/SelfContained&gt;
  &lt;/PropertyGroup&gt;

&lt;/Project&gt;
</code></pre>
<p>ç„¶åå°±å¯ä»¥ç”¨å¦‚ä¸‹å‘½ä»¤ç¼–è¯‘ä¸€ä¸‹è¯•è¯•çœ‹ï¼š</p>
<pre><code class="language-powershell">cd des-lib
dotnet publish -r win-x64 -c Release
</code></pre>
<p>åœ¨æ„å»ºå®Œæ¯•ä¹‹åï¼Œä¼šåœ¨ <code>bin\Release\net7.0\win-x64\publish</code> ç›®å½•ä¸‹ç”Ÿæˆ <code>des-lib.lib</code> æ–‡ä»¶ã€‚</p>
<h2 id="rust-é¡¹ç›®éƒ¨åˆ†"><a class="header" href="#rust-é¡¹ç›®éƒ¨åˆ†">Rust é¡¹ç›®éƒ¨åˆ†</a></h2>
<p>åœ¨ä¸Šé¢çš„é¡¹ç›®æ„å»ºæˆåŠŸåï¼Œå°†ä¼šæŠŠ <code>ilcompiler</code> åŒ…ç¼“å­˜ï¼Œå¹¶å¯ä»¥åœ¨è¯¥ç›®å½• <code>%USERPROFILE%/.nuget/packages/runtime.win-x64.microsoft.dotnet.ilcompiler/7.0.1/sdk</code> æ‰¾åˆ°é“¾æ¥ä¾èµ–çš„ä¸€äº›é™æ€åº“ï¼ˆæ³¨æ„ï¼Œç‰ˆæœ¬å·å¯èƒ½ä¼šå˜æ›´ï¼‰ã€‚</p>
<p>åœ¨ <code>call-net-from-rust-statically</code> ç›®å½•ä¸­åˆ›å»º <code>Rust</code> é¡¹ç›®ï¼š</p>
<pre><code class="language-powershell">cd call-net-from-rust-statically
cargo init
</code></pre>
<p>å…ˆæ·»åŠ  <code>windows</code> ä¾èµ–ï¼Œè¿™æ˜¯å› ä¸ºåœ¨é“¾æ¥çš„æ—¶å€™ï¼Œ<code>.Net</code> è¿è¡Œæ—¶ä¼šä¾èµ– <code>Win32 API</code>ï¼š</p>
<pre><code class="language-powershell">cargo add windows
</code></pre>
<p>æ·»åŠ  <code>build.rs</code>ï¼Œä¸€å®šè¦æ³¨æ„ä¿®æ”¹ <code>sdk_path</code> ä¸­çš„ <code>ilcompiler</code> ç‰ˆæœ¬å·ï¼ˆæœ¬æ–‡è®²çš„æ˜¯å®ç°æ­¥éª¤ï¼Œæœ€ç»ˆçš„ä»£ç æˆ‘ä¼šæŠŠ <code>des-lib</code> çš„æ„å»ºä¹Ÿæ”¾åœ¨ <code>build.rs</code> ä¸­ï¼Œå¹¶ä»æ„å»ºçš„è¾“å‡ºä¸­å¯»æ‰¾è¿™ä¸ªç‰ˆæœ¬å·ï¼Œè€Œä¸éœ€è¦å†™æ­»ï¼‰ï¼š</p>
<pre><pre class="playground"><code class="language-rust">use std::path::PathBuf;

fn main() {
    let user_profile: PathBuf = std::env::var(&quot;USERPROFILE&quot;).unwrap().into();
    let sdk_path: PathBuf = (user_profile)
        .join(&quot;.nuget\\packages\\runtime.win-x64.microsoft.dotnet.ilcompiler\\7.0.1\\sdk&quot;);
    let manifest_dir: PathBuf = std::env::var(&quot;CARGO_MANIFEST_DIR&quot;).unwrap().into();
    let des_lib_path = manifest_dir.join(&quot;des-lib&quot;);

    println!(&quot;cargo:rustc-link-arg=/INCLUDE:NativeAOT_StaticInitialization&quot;);
    println!(&quot;cargo:rustc-link-search={}&quot;, sdk_path.display());
    println!(
        &quot;cargo:rustc-link-search={}\\bin\\Release\\net7.0\\win-x64\\publish&quot;,
        des_lib_path.display()
    );

    println!(&quot;cargo:rustc-link-lib=static=windows&quot;);
    println!(&quot;cargo:rustc-link-lib=static=bootstrapperdll&quot;);
    println!(&quot;cargo:rustc-link-lib=static=Runtime.WorkstationGC&quot;);
    println!(&quot;cargo:rustc-link-lib=static=System.Globalization.Native.Aot&quot;);
    println!(&quot;cargo:rustc-link-lib=static=des-lib&quot;);
}</code></pre></pre>
<p>æ¥ä¸‹æ¥å°±æ˜¯è°ƒç”¨äº†ï¼Œåœ¨ <code>main.rs</code> ä¸­æ·»åŠ ï¼š</p>
<pre><pre class="playground"><code class="language-rust">extern &quot;C&quot; {
    fn wtf_des_encrypt(message: *const u8, key: *const u8) -&gt; *const u8;
    fn wtf_des_decrypt(cipher_text: *const u8, key: *const u8) -&gt; *const u8;
    fn wtf_des_free(ptr: *const u8);
}

fn main() {
    let key = b&quot;key\0&quot;;
    let cipher_text = unsafe { wtf_des_encrypt(b&quot;message\0&quot;.as_ptr(), key.as_ptr()) };
    let cipher_text = unsafe { std::ffi::CStr::from_ptr(cipher_text as *const i8) };
    let plain_text = unsafe { wtf_des_decrypt(cipher_text.as_ptr() as _, key.as_ptr()) };
    let plain_text = unsafe { std::ffi::CStr::from_ptr(plain_text as *const i8) };
    println!(&quot;cipher_text: {}&quot;, cipher_text.to_str().unwrap());
    println!(&quot;plain_text: {}&quot;, plain_text.to_str().unwrap());

    unsafe {
        wtf_des_free(cipher_text.as_ptr() as _);
        wtf_des_free(plain_text.as_ptr() as _);
    }
}</code></pre></pre>
<h2 id="æœ€ç»ˆç‰ˆæœ¬"><a class="header" href="#æœ€ç»ˆç‰ˆæœ¬">æœ€ç»ˆç‰ˆæœ¬</a></h2>
<p>ä»“åº“åœ°å€ï¼š<a href="https://github.com/hamflx/call-net-from-rust-statically">https://github.com/hamflx/call-net-from-rust-statically</a>ï¼Œåœ¨æœ¬æ–‡çš„åŸºç¡€å¢åŠ äº†è‡ªåŠ¨æ„å»º <code>C#</code> é¡¹ç›®ï¼Œè‡ªåŠ¨æŸ¥æ‰¾ <code>ilcompiler</code> çš„è·¯å¾„å¹¶é“¾æ¥ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ä½¿ç”¨-rust-ç¼–å†™è½¬å‘-dll"><a class="header" href="#ä½¿ç”¨-rust-ç¼–å†™è½¬å‘-dll">ä½¿ç”¨ Rust ç¼–å†™è½¬å‘ DLL</a></h1>
<p>æœ¬æ–‡å®ç°ä¸€ä¸ªè½¬å‘ DLLï¼š<code>version.dll</code> è½¬å‘åˆ°ç³»ç»Ÿçš„ <code>version.dll</code> ä¸Šã€‚å¦å¤–è¦æ³¨æ„ï¼Œæœ¬æ–‡ä»£ç ä»…ä¾›å‚è€ƒï¼Œä¸ä¸€å®šå¯ä»¥è¿è¡Œï¼Œéœ€è¦åšä¸€å®šçš„ä¿®æ”¹ï¼Œæˆ–ç›´æ¥æŸ¥çœ‹æœ€ç»ˆå®ç°ï¼š<a href="https://github.com/hamflx/forward-dll">https://github.com/hamflx/forward-dll</a>ã€‚</p>
<p>é¦–å…ˆç”¨ä¸‹é¢çš„å‘½ä»¤æŸ¥çœ‹ç³»ç»Ÿçš„ <code>version.dll</code> å¯¼å‡ºå‡½æ•°ï¼š</p>
<pre><code class="language-plain">C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise&gt;dumpbin /exports c:\windows\system32\version.dll
Microsoft (R) COFF/PE Dumper Version 14.29.30136.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file c:\windows\system32\version.dll

File Type: DLL

  Section contains the following exports for VERSION.dll

    00000000 characteristics
    927B71E6 time date stamp
        0.00 version
           1 ordinal base
          17 number of functions
          17 number of names

    ordinal hint RVA      name

          1    0 00001080 GetFileVersionInfoA
          2    1 00002190 GetFileVersionInfoByHandle
          3    2 00001DF0 GetFileVersionInfoExA
          4    3 00001040 GetFileVersionInfoExW
          5    4 00001010 GetFileVersionInfoSizeA
          6    5 00001E00 GetFileVersionInfoSizeExA
          7    6 00001050 GetFileVersionInfoSizeExW
          8    7 00001060 GetFileVersionInfoSizeW
          9    8 00001070 GetFileVersionInfoW
         10    9 00001E10 VerFindFileA
         11    A 00002360 VerFindFileW
         12    B 00001E20 VerInstallFileA
         13    C 00002F80 VerInstallFileW
         14    D          VerLanguageNameA (forwarded to KERNEL32.VerLanguageNameA)
         15    E          VerLanguageNameW (forwarded to KERNEL32.VerLanguageNameW)
         16    F 00001020 VerQueryValueA
         17   10 00001030 VerQueryValueW

  Summary

        1000 .data
        1000 .pdata
        2000 .rdata
        1000 .reloc
        1000 .rsrc
        3000 .text

C:\Program Files (x86)\Microsoft Visual Studio\2019\Enterprise&gt;
</code></pre>
<p>ç„¶åæˆ‘ä»¬æ‹¿ <code>GetFileVersionInfoSizeA</code> ä¸¾ä¾‹æ¥å†™ä¸€ä¸ªå®ä¾‹å‡½æ•°ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>static mut RealGetFileVersionInfoSizeA: usize = 0;

#[no_mangle]
pub extern &quot;system&quot; fn GetFileVersionInfoSizeA() -&gt; u32 {
    unsafe {
        std::arch::asm!(
            &quot;jmp rax&quot;,
            in(&quot;rax&quot;) RealGetFileVersionInfoSizeA,
            options(nostack)
        );
    }
    1
}
<span class="boring">}</span></code></pre></pre>
<p>è¿™ä¸ªå‡½æ•°å…¶å®ä¹Ÿä¸èƒ½å«å‡½æ•°ï¼Œå› ä¸ºå®ƒä¸ä¼šè¿”å›ï¼Œç›´æ¥è·³è½¬åˆ°ç›®æ ‡å‡½æ•°åœ°å€ï¼Œè¿™ä¸ªç›®æ ‡å‡½æ•°åœ°å€éœ€è¦åœ¨ <code>DllMain</code> ä¸­é€šè¿‡ <code>LoadLibrary</code> å’Œ <code>GetProcAddress</code> è¿›è¡Œèµ‹å€¼ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[no_mangle]
pub extern &quot;system&quot; fn DllMain(_inst: isize, reason: u32, _: *const u8) -&gt; u32 {
    if reason == 1 {
        let version_module = load_library(&quot;c:\\windows\\system32\\version.dll&quot;);
        unsafe { RealGetFileVersionInfoSizeA = get_proc_address(version_module, &quot;GetFileVersionInfoSizeA&quot;) };
    }
    1
}
<span class="boring">}</span></code></pre></pre>
<p>å¦‚æœæ¯ä¸ªå‡½æ•°éƒ½è¿™ä¹ˆå†™ï¼Œé‚£æ˜¯ç›¸å½“çš„éº»çƒ¦ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ªå®ï¼Œå¹¶æŠŠåŠ è½½ç›®æ ‡ dll çš„çœŸå®åœ°å€å°è£…åˆ°ç»“æ„ä½“çš„æ–¹æ³•é‡Œé¢ï¼Œè¿™æ ·åœ¨ <code>DllMain</code> æ—¶ç›´æ¥è°ƒç”¨å³å¯ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[macro_export]
macro_rules! forward_dll {
    ($lib:expr, $name:ident, $($proc:ident)*) =&gt; {
        static mut $name: forward_dll::DllForwarder&lt;{ forward_dll::count!($($proc)*) }&gt; = forward_dll::DllForwarder {
            lib_name: $lib,
            target_functions_address: [
                0;
                forward_dll::count!($($proc)*)
            ],
            target_function_names: [
                $(stringify!($proc),)*
            ]
        };
        forward_dll::define_function!($name, 0, $($proc)*);
    };
}

#[macro_export]
macro_rules! define_function {
    ($name:ident, $index:expr, ) =&gt; {};
    ($name:ident, $index:expr, $proc:ident $($procs:ident)*) =&gt; {
        #[no_mangle]
        pub extern &quot;system&quot; fn $proc() -&gt; u32 {
            unsafe {
                std::arch::asm!(
                    &quot;jmp rax&quot;,
                    in(&quot;rax&quot;) $name.target_functions_address[$index],
                    options(nostack)
                );
            }
            1
        }
        forward_dll::define_function!($name, ($index + 1), $($procs)*);
    };
}

/// DLL è½¬å‘ç±»å‹çš„å…·ä½“å®ç°ã€‚è¯¥ç±»å‹ä¸è¦è‡ªå·±å®ä¾‹åŒ–ï¼Œåº”è°ƒç”¨ forward_dll å®ç”Ÿæˆå…·ä½“çš„å®ä¾‹ã€‚
pub struct DllForwarder&lt;const N: usize&gt; {
    pub target_functions_address: [usize; N],
    pub target_function_names: [&amp;'static str; N],
    pub lib_name: &amp;'static str,
}

impl&lt;const N: usize&gt; DllForwarder&lt;N&gt; {
    /// å°†æ‰€æœ‰å‡½æ•°çš„è·³è½¬åœ°å€è®¾ç½®ä¸ºå¯¹åº”çš„ DLL çš„åŒåå‡½æ•°åœ°å€ã€‚
    pub fn forward_all(&amp;mut self) -&gt; ForwardResult&lt;()&gt; {
        let load_module_dir = &quot;C:\\Windows\\System32\\&quot;;
        let module_full_path = format!(&quot;{}{}&quot;, load_module_dir, self.lib_name);
        let module_handle = get_module_handle(module_full_path.as_str())?;

        for index in 0..self.target_functions_address.len() {
            let addr_in_remote_module =
                get_proc_address_by_module(module_handle, self.target_function_names[index])?;
            self.target_functions_address[index] = addr_in_remote_module as *const usize as usize;
        }

        Ok(())
    }
}

forward_dll::forward_dll!(
    &quot;C:\\Windows\\system32\\version.dll&quot;,
    DLL_VERSION_FORWARDER,
    GetFileVersionInfoA
    GetFileVersionInfoByHandle
    GetFileVersionInfoExA
    GetFileVersionInfoExW
    GetFileVersionInfoSizeA
    GetFileVersionInfoSizeExA
    GetFileVersionInfoSizeExW
    GetFileVersionInfoSizeW
    GetFileVersionInfoW
    VerFindFileA
    VerFindFileW
    VerInstallFileA
    VerInstallFileW
    VerLanguageNameA
    VerLanguageNameW
    VerQueryValueA
    VerQueryValueW
);

// åœ¨ DllMain ä¸­è°ƒç”¨ï¼š
// unsafe { DLL_VERSION_FORWARDER.forward_all() };
<span class="boring">}</span></code></pre></pre>
<p>è¿™å°±å®Œæˆäº† <code>version.dll</code> çš„è½¬å‘ã€‚å¯å‚è€ƒé€šè¿‡è¯¥æ–¹æ³•å®ç°çš„ä¸€ä¸ªå°å·¥å…·ï¼š<a href="https://github.com/hamflx/huawei-pc-manager-bootstrap">https://github.com/hamflx/huawei-pc-manager-bootstrap</a>ã€‚</p>
<h2 id="æ³•äºŒ"><a class="header" href="#æ³•äºŒ">æ³•äºŒ</a></h2>
<p>å¦‚æœæˆ‘ä»¬ä¸å¸Œæœ›é€šè¿‡ <code>DllMain</code> æ¥åˆå§‹åŒ–æ€ä¹ˆåŠï¼Ÿæˆ‘ä»¬å¯ä»¥åœ¨è·³æ¿å‡½æ•°é‡Œé¢åŠ è½½ç›®æ ‡å‡½æ•°åœ°å€ï¼Œä¸ºäº†ä¿è¯å¯„å­˜å™¨å’Œæ ˆä¸Šæ•°æ®çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å•ç‹¬å†™ä¸€ä¸ªåŠ è½½å‡½æ•°ï¼Œå¹¶ä»è·³æ¿é‡Œé¢è°ƒç”¨è¿‡å»ï¼Œç”±ç¼–è¯‘å™¨æ¥å¸®æˆ‘ä»¬ä¿è¯å¯„å­˜å™¨çš„çŠ¶æ€ã€‚</p>
<p>é€šè¿‡è¯¥å‡½æ•°æ‹¿åˆ°ç›®æ ‡å‡½æ•°åœ°å€åå°†å…¶è¿”å›ï¼Œé‚£ä¹ˆç›®æ ‡å‡½æ•°åœ°å€å°±å­˜å‚¨åœ¨ <code>rax</code> ä¸Šï¼Œç„¶åå†è·³è½¬åˆ° <code>rax</code> ä¸Šï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub extern &quot;system&quot; fn $proc() -&gt; u32 {
    unsafe {
        std::arch::asm!(
            &quot;push rcx&quot;,
            &quot;push rdx&quot;,
            &quot;push r8&quot;,
            &quot;push r9&quot;,
            &quot;push r10&quot;,
            &quot;push r11&quot;,
            options(nostack)
        );
        std::arch::asm!(
            &quot;sub rsp, 28h&quot;,
            &quot;call rax&quot;,
            &quot;add rsp, 28h&quot;,
            in(&quot;rax&quot;) forward_dll::default_jumper,
            in(&quot;rcx&quot;) std::concat!($lib, &quot;\0&quot;).as_ptr() as usize,
            in(&quot;rdx&quot;) std::concat!(std::stringify!($proc), &quot;\0&quot;).as_ptr() as usize,
            options(nostack)
        );
        std::arch::asm!(
            &quot;pop r11&quot;,
            &quot;pop r10&quot;,
            &quot;pop r9&quot;,
            &quot;pop r8&quot;,
            &quot;pop rdx&quot;,
            &quot;pop rcx&quot;,
            &quot;jmp rax&quot;,
            options(nostack)
        );
    }
    1
}
<span class="boring">}</span></code></pre></pre>
<p>ç„¶åæˆ‘ä»¬å®ç°ä¸€ä¸ª <code>forward_dll::default_jumper</code> æ–¹æ³•ï¼š</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// é»˜è®¤çš„è·³æ¿ï¼Œå¦‚æœæ²¡æœ‰æ‰§è¡Œåˆå§‹åŒ–æ“ä½œï¼Œåˆ™è¿›å…¥è¯¥å‡½æ•°ã€‚
pub fn default_jumper(
    lib_name: *const u8,
    func_name: *const u8,
) -&gt; usize {
    let module_handle = unsafe { LoadLibraryA(lib_name) };
    if module_handle != 0 {
        let addr = unsafe { GetProcAddress(module_handle, func_name) };
        // è¿™é‡Œè°ƒç”¨äº† FreeLibrary é‡Šæ”¾ç›®æ ‡æ¨¡å—ï¼Œå®é™…ä½¿ç”¨éœ€è¦åœ¨å…¶ä»–åœ°æ–¹æŒæœ‰ç›®æ ‡æ¨¡å—çš„å¥æŸ„ï¼Œé˜²æ­¢è¢«é‡Šæ”¾ã€‚
        unsafe { FreeLibrary(module_handle) };
        return addr.map(|addr| addr as usize).unwrap_or(exit_fn as usize);
    }

    exit_fn as usize
}
<span class="boring">}</span></code></pre></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vite-å…¼å®¹æ€§è¸©å‘è®°å½•"><a class="header" href="#vite-å…¼å®¹æ€§è¸©å‘è®°å½•">vite å…¼å®¹æ€§è¸©å‘è®°å½•</a></h1>
<p>vite æä¾›çš„å¿«é€Ÿå¯åŠ¨å¼€å‘æ¨¡å¼æœåŠ¡å™¨çš„ç‰¹æ€§éå¸¸å¥½ç”¨ï¼Œä¸è¿‡ï¼Œæœ‰æ—¶å€™çº¿ä¸Šå‡ºäº†å…¼å®¹æ€§é—®é¢˜ï¼Œä½ è¿˜æ— æ³•å¿«é€Ÿå®šä½åˆ°é—®é¢˜çš„æ ¹æºï¼Œé‚£å°±éœ€è¦ä½ç‰ˆæœ¬çš„æµè§ˆå™¨æ¥è¿›è¡Œå¼€å‘æµ‹è¯•ï¼Œç„¶è€Œâ€¦â€¦</p>
<p>æƒ³è¦åœ¨ä½ç‰ˆæœ¬æµè§ˆå™¨ä¸Šè¿è¡Œé¡¹ç›®ï¼Œé¦–å…ˆè¦åœ¨æµè§ˆå™¨ä¸Šæ‰“å¼€é¡¹ç›®ï¼Œå› ä¸ºæˆ‘ä»¬é¡¹ç›®é‡‡ç”¨äº†å¯é€‰é“¾ï¼Œå¯¼è‡´è¿é¡¹ç›®éƒ½æ‰“ä¸å¼€ã€‚</p>
<p>å°è¯•é…ç½® <code>config.esbuild.target</code> ä¸º <code>es2015</code>ï¼Œts æ–‡ä»¶æ˜¯å¯ä»¥è¢«æ­£ç¡®ç¼–è¯‘äº†ï¼Œä½†æ˜¯ vue æ–‡ä»¶ä»ç„¶ä¸è¡Œï¼Œç„¶åæˆ‘å»æœç´¢ï¼Œå‘ç°äº†å¥½å¤šäººéƒ½æœ‰è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯è²Œä¼¼æ²¡æœ‰ä¸€ä¸ªèƒ½ç»™å‡ºå¾ˆæ–¹ä¾¿çš„è§£å†³æ–¹æ¡ˆçš„ã€‚åœ¨ GitHub ä¸Šæœ‰ä¸ª issue ç»™å‡ºäº† PRï¼Œä½†æ˜¯è¿™ä¸ª PR æ²¡æœ‰è¢«åˆå¹¶ï¼ˆissueï¼š<a href="https://github.com/vitejs/vite/issues/5222" title="https://github.com/vitejs/vite/issues/5222">https://github.com/vitejs/vite/issues/5222</a>ï¼Œprï¼š<a href="https://github.com/vitejs/vite/pull/5652" title="https://github.com/vitejs/vite/pull/5652">https://github.com/vitejs/vite/pull/5652</a>ï¼‰ã€‚</p>
<p>æ ¹æ®ä¸Šé¢çš„ pr æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>plugin-vue</code> çš„æºä»£ç ï¼Œå‘ç° vue ä¸­çš„ ts æ˜¯ä¸æ£€æŸ¥ <code>config.esbuild.target</code> é€‰é¡¹çš„ï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="posts/2021/11/23/./assets/image_0QLmJMwi1A.png" alt="transformWithEsBuild" title="transformWithEsBuild" /></p>
<p>æ‰€ä»¥æˆ‘é¦–å…ˆå°è¯•çš„æ–¹æ³•å°±æ˜¯æŒ‰ç…§ PR æ‰€è¿°ç›´æ¥ä¿®æ”¹ node_modules é‡Œçš„æ–‡ä»¶ï¼Œæ”¹å®Œä¹‹åå‘ç° vue ä¸­çš„å¯é€‰é“¾è¢«ç¼–è¯‘äº†ï¼Œä½†æ˜¯ ts ä¸­çš„å¯é€‰é“¾ä»ç„¶æ²¡æœ‰è¢«ç¼–è¯‘ï¼Œè¿™ä¸ªæ—¶å€™å†æ­é…ä¸€ä¸‹ <code>config.esbuild.target</code> å°±èƒ½æŠŠä¸¤è¾¹é—®é¢˜éƒ½ç»™è§£å†³äº†ï¼Œä¸è¿‡è¿™ä¸ªæ–¹æ³•è¦ä¿®æ”¹ node_modules ä¸å¤ªå¥½ã€‚</p>
<p>åæ¥æ¢äº† <code>@rollup/plugin-babel</code> æ’ä»¶ï¼Œé…ç½®å®Œä¹Ÿä¸è¡Œï¼Œç ”ç©¶äº†ä¸‹æºä»£ç ï¼Œå¯¹äº ts é¡¹ç›®ï¼Œéœ€è¦é…ç½® extensions æ‰è¡Œï¼š</p>
<pre><code class="language-javascript">export const DEFAULT_EXTENSIONS: ['.js', '.jsx', '.es6', '.es', '.mjs'];

const unpackOptions = ({
  extensions = babel.DEFAULT_EXTENSIONS,
  // rollup uses sourcemap, babel uses sourceMaps
  // just normalize them here so people don't have to worry about it
  sourcemap = true,
  sourcemaps = true,
  sourceMap = true,
  sourceMaps = true,
  ...rest
} = {}) =&gt; {
  return {
    extensions,
    plugins: [],
    sourceMaps: sourcemap &amp;&amp; sourcemaps &amp;&amp; sourceMap &amp;&amp; sourceMaps,
    ...rest,
    caller: {
      name: '@rollup/plugin-babel',
      ...rest.caller
    }
  };
};
</code></pre>
<p>é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">import { resolve } from 'path'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import babel from '@rollup/plugin-babel'

export default defineConfig({
  plugins: [
    vue(),
    babel({
      extensions: ['.ts', '.js', '.jsx', '.es6', '.es', '.mjs'],
      plugins: [
        '@babel/plugin-proposal-optional-chaining',
        '@babel/plugin-proposal-nullish-coalescing-operator'
      ]
    })
  ]
})
</code></pre>
<p>ä¸€çœ¼çœ‹è¿‡å»å‘ç°åº”è¯¥è¿˜æ˜¯ä¸è¡Œï¼Œå› ä¸ºç¼ºå°‘ <code>.vue</code> æ–‡ä»¶çš„å¤„ç†ï¼Œè¯•äº†ä¸€ä¸‹æœç„¶ä¸è¡Œï¼Œä¸è¿‡ï¼Œæ‰©å±•åé‡ŒåŠ  <code>.vue</code> çš„è¯ä¼šæŠ¥é”™ï¼Œä¸€èˆ¬æ¥è¯´ <code>.vue</code> æ–‡ä»¶ç¼–è¯‘ä¹‹åä¼šæ˜¯ jsï¼Œä½†æ˜¯ <code>.vue</code> é‡Œé¢å¦‚æœåŒ…å«äº†æ ·å¼ï¼Œä¼šå•ç‹¬æå–å‡ºæ¥ä½œä¸ºä¸€ä¸ªè™šæ‹Ÿçš„æ–‡ä»¶ï¼Œé€šè¿‡æŸ¥è¯¢å‚æ•° <code>type=style</code> æ¥è¯»å–ï¼Œè¿™é‡Œä»¥ <code>babel</code> æ¥è½¬è¯‘æ ·å¼æ–‡ä»¶å½“ç„¶æŠ¥é”™ã€‚</p>
<p>çœ‹äº†ä¸‹ <code>@rollup/plugin-babel</code> çš„ä»£ç ï¼Œå‘ç°è¿˜æœ‰ <code>include/exclude/filter</code> é€‰é¡¹å¯ä»¥ä½¿ç”¨ï¼Œä¸æ‰©å±•åä¹‹é—´æ˜¯ä¸”çš„å…³ç³»ï¼š</p>
<pre><code class="language-javascript">const userDefinedFilter =
  typeof customFilter === 'function' ? customFilter : createFilter(include, exclude);
filter = (id) =&gt; extensionRegExp.test(stripQuery(id).bareId) &amp;&amp; userDefinedFilter(id);
</code></pre>
<p>æ‰€ä»¥ï¼Œæˆ‘ä»¬åªè¦é™å®šä¸€ä¸‹ï¼Œåªè½¬ä¹‰ä»¥ <code>.vue</code> ä¸ºåç¼€çš„æ–‡ä»¶å°±è¡Œäº†ï¼š</p>
<pre><code class="language-javascript">import { resolve } from 'path'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import babel from '@rollup/plugin-babel'

export default defineConfig({
  plugins: [
    vue(),
    babel({
      include: [
        /\.vue$/,
        /\.ts$/
      ],
      extensions: ['.vue', '.ts', '.js'],
      plugins: [
        '@babel/plugin-proposal-optional-chaining',
        '@babel/plugin-proposal-nullish-coalescing-operator'
      ]
    })
  ]
})
</code></pre>
<p>æœ€åç»“æœå¦‚ä¸‹ï¼š</p>
<p><img src="posts/2021/11/23/./assets/image_2sI2iMOtJM.png" alt="è½¬è¯‘ç»“æœ" title="è½¬è¯‘ç»“æœ" /></p>
<p>ä¸ºäº†è§£å†³ <code>chrome</code> çš„æ»šåŠ¨æ¡ <code>bug</code>ï¼ˆå¦å¤–å†åæ§½ä¸‹ï¼Œæœ€è¿‘ <code>chrome</code> é¢‘ç¹å‡çº§å¯¼è‡´çš„ <code>bug</code> çœŸçš„æ˜¯ä¸å°‘ï¼‰ï¼Œå…ˆå¾—æŠŠ <code>vite</code> ä¸æ”¯æŒ <code>chrome</code> è€ç‰ˆæœ¬çš„é—®é¢˜è§£å†³â€¦â€¦</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å‰ç«¯é€šè¿‡-ffmpeg-åº“æ’­æ”¾è§†é¢‘"><a class="header" href="#å‰ç«¯é€šè¿‡-ffmpeg-åº“æ’­æ”¾è§†é¢‘">å‰ç«¯é€šè¿‡ ffmpeg åº“æ’­æ”¾è§†é¢‘</a></h1>
<p>ä»“åº“åœ°å€ï¼š<a href="https://github.com/hamflx/ffmpeg-fe">https://github.com/hamflx/ffmpeg-fe</a></p>
<p>å…ˆçœ‹ä¸€ä¸‹ <code>chrome</code> æ”¯æŒçš„è§†é¢‘æ ¼å¼ä¸è§£ç å™¨ï¼š</p>
<p><img src="posts/2021/10/14/./assets/codec-and-container-support.png" alt="Codec and Container Support" title="Codec and Container Support" /></p>
<p>å…¶ä¸­ <code>H.265</code> å¹¶ä¸åœ¨ä¸€èˆ¬çš„ <code>Chrome</code> ä¸Šæ”¯æŒï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ’­æ”¾ä¸€äº›ä¸å¸¸ç”¨çš„æ ¼å¼ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±å¯ä»¥å°† <code>ffmpeg</code> åº“ç¼–è¯‘ä¸º <code>WebAssembly</code> ä»¥æ”¯æŒè¿™äº›æ ¼å¼ã€‚</p>
<p><code>ffmpeg</code> æ˜¯ä¸€ä¸ªéŸ³è§†é¢‘å¤„ç†çš„é€šç”¨åº“ï¼Œæˆ‘ä»¬éœ€è¦ç”¨ <code>C++</code> å†™ä¸€ä¸ªè°ƒç”¨ <code>ffmpeg</code> çš„è§£ç ç¨‹åºï¼Œè¯¥ç¨‹åºä¸ <code>JS</code> è¿›è¡Œé€šä¿¡ï¼Œå–å¾—è§†é¢‘æ•°æ®ï¼Œå¹¶è°ƒç”¨ <code>ffmpeg</code> è§£ç ï¼Œå°†è§£ç åçš„ç¨‹åºé€ç»™ <code>JS</code>ï¼Œç”± <code>JS</code> è°ƒç”¨ <code>WebGL</code> æ¸²æŸ“ã€‚</p>
<p><img src="posts/2021/10/14/./assets/program-structure.png" alt="ç¨‹åºç»“æ„" title="ç¨‹åºç»“æ„" /></p>
<p>æˆ‘è¿™é‡Œä»¥æµçš„å½¢å¼æ¥å–è§†é¢‘æ•°æ®ã€è§£ç ï¼Œåœ¨æ’­æ”¾å™¨ä¸€ä¾§åœ¨ <code>requestAnimationFrame</code> ä¸­æ‹‰å–è§†é¢‘æ•°æ®ï¼š</p>
<p><img src="posts/2021/10/14/./assets/program-sequence.png" alt="æ—¶åºå›¾" title="æ—¶åºå›¾" /></p>
<h2 id="æ„å»º-ffmpeg-åº“"><a class="header" href="#æ„å»º-ffmpeg-åº“">æ„å»º <code>ffmpeg</code> åº“</a></h2>
<p>é¦–å…ˆéœ€è¦æŠŠ <code>ffmpeg</code> ç¼–è¯‘æˆå‡ ä¸ªåº“ï¼Œåç»­æˆ‘ä»¬çš„ <code>C++</code> è§£ç ç¨‹åºå°±å¯ä»¥è°ƒç”¨è¿™ä¸ªåº“é‡Œçš„æ–¹æ³•ï¼Œæ„å»ºå‘½ä»¤ï¼š</p>
<pre><code class="language-shell">CPPFLAGS=&quot;-D_POSIX_C_SOURCE=200112 -D_XOPEN_SOURCE=600&quot; \
emconfigure ./configure \
    --prefix=$(pwd)/lib \
    --cc=&quot;emcc&quot; \
    --cxx=&quot;em++&quot; \
    --ar=&quot;emar&quot; \
    --ranlib=&quot;emranlib&quot; \
    --target-os=none \
    --enable-cross-compile \
    --enable-lto \
    --cpu=generic \
    --arch=x86_64 \
    --disable-asm \
    --disable-inline-asm \
    --disable-programs \
    --disable-avdevice \
    --disable-doc \
    --disable-swresample \
    --disable-postproc  \
    --disable-avfilter \
    --disable-pthreads \
    --disable-w32threads \
    --disable-os2threads \
    --disable-network \
    --disable-logging \
    --disable-everything \
    --enable-gpl \
    --enable-version3 \
    --enable-static \
    --enable-demuxers \
    --enable-parsers \
    --enable-decoder=pcm_mulaw \
    --enable-decoder=pcm_alaw \
    --enable-decoder=adpcm_ima_smjpeg \
    --enable-protocol=file \
    --enable-protocol=pipe \
    --enable-decoder=h264 \
    --enable-decoder=hevc

make &amp;&amp; make install
</code></pre>
<p>ä»¥ä¸Šæ„å»ºå‘½ä»¤æˆåŠŸåï¼Œå°†ä¼šå¾—åˆ°ä¸‹é¢çš„æ–‡ä»¶ï¼š</p>
<p><img src="posts/2021/10/14/./assets/build-artifacts.png" alt="lib*.a" title="lib*.a" /></p>
<h2 id="ç¼–å†™è§£ç ç¨‹åº"><a class="header" href="#ç¼–å†™è§£ç ç¨‹åº">ç¼–å†™è§£ç ç¨‹åº</a></h2>
<p>é€šè¿‡ <code>ffmpeg</code> çš„è‡ªå®šä¹‰æµï¼Œæ¥å®ç°ä¸€ä¸ª <code>read_packet</code> æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å†…éƒ¨è°ƒç”¨ <code>js</code> çš„å¼‚æ­¥æ–¹æ³•å–å¾—è§†é¢‘æµï¼Œä»¥æ­¤ä½œä¸ºè¾“å…¥ã€‚ç¨‹åºä¸»å¾ªç¯ä¸­ä¸æ–­å°è¯•è°ƒç”¨ <code>avcodec_receive_frame</code> è§£ç ï¼Œå½“æ•°æ®ä¸è¶³æ—¶ï¼Œé€šè¿‡ <code>av_read_frame</code> å’Œ <code>avcodec_send_packet</code> å°†æ•°æ®å‘é€ç»™ <code>ffmpeg</code> çš„è§£ç å™¨ã€‚</p>
<p>è‡ªå®šä¹‰è¾“å…¥æµå¦‚ä¸‹ï¼š</p>
<pre><code class="language-cpp">int nBufferSize = 32768;
unsigned char *pReadBuffer = (unsigned char*)av_malloc(nBufferSize);
if (pReadBuffer == NULL)
{
  return DECODER_ERROR::AV_ERROR;
}

AVIOContext *pIoCtx = avio_alloc_context(pReadBuffer, nBufferSize, 0, (void*)this, DecoderReadPacket, NULL, NULL);
if (pIoCtx == NULL)
{
  return DECODER_ERROR::AV_ERROR;
}

m_pFmtCtx = avformat_alloc_context();
m_pFmtCtx-&gt;pb = pIoCtx;
m_pFmtCtx-&gt;flags = AVFMT_FLAG_CUSTOM_IO;

int ret;
while ((ret = avformat_open_input(&amp;m_pFmtCtx, NULL, NULL, NULL)) == AVERROR(EAGAIN))
{
}
if (ret)
{
  return DECODER_ERROR::AV_ERROR;
}

int Decoder::ReadPacket(void *opaque, uint8_t*buf, int buf_size)
{
  emscripten::val packet = m_jsUpstream.call&lt;emscripten::val&gt;(&quot;next&quot;, buf_size).await();
  emscripten::val data = packet[&quot;data&quot;];
  emscripten::val done = packet[&quot;done&quot;];
  if (done.as&lt;bool&gt;())
  {
    return 0;
  }

  const auto nPacketLength = data[&quot;length&quot;].as&lt;unsigned&gt;();
  if (nPacketLength &gt; buf_size)
  {
    printf(&quot;==&gt; nPacketLength &gt; buf_size\n&quot;);
  }

  emscripten::val memoryView{emscripten::typed_memory_view(nPacketLength, buf)};
  memoryView.call&lt;void&gt;(&quot;set&quot;, data.call&lt;emscripten::val&gt;(&quot;slice&quot;, 0, nPacketLength));

  return nPacketLength;
}
</code></pre>
<p>ç¨‹åºä¸»å¾ªç¯è§£ç ï¼ˆå…¶å®æ˜¯åœ¨ <code>JS</code> é‡Œè°ƒç”¨ <code>Next</code> åˆ° <code>C++</code> çš„ï¼‰å¦‚ä¸‹ï¼š</p>
<pre><code class="language-cpp">while ((ret = avcodec_receive_frame(m_pCodecCtx, m_pFrame)) == AVERROR(EAGAIN))
{
  while (1)
  {
    ret = av_read_frame(m_pFmtCtx, m_pPacketFrame);
    if (ret == 0)
    {
      if (m_pPacketFrame-&gt;stream_index == m_iVideoStream)
      {
        break;
      }
      av_packet_unref(m_pPacketFrame);
      continue;
    }

    printf(&quot;==&gt; av_read_frame error: %s\n&quot;, av_err2str(ret));
    av_packet_unref(m_pPacketFrame);

    if (ret == AVERROR_EOF)
    {
      result.set(&quot;status&quot;, (int)DECODER_ERROR::END_OF_FILE);
      return result;
    }
    if (ret != 0)
    {
      printf(&quot;av_read_frame failed: %s\n&quot;, av_err2str(ret));
      result.set(&quot;status&quot;, (int)DECODER_ERROR::AV_READ_FRAME);
      return result;
    }
  }

  ret = avcodec_send_packet(m_pCodecCtx, m_pPacketFrame);
  av_packet_unref(m_pPacketFrame);

  if (ret != 0)
  {
    printf(&quot;==&gt; avcodec_send_packet error: %s\n&quot;, av_err2str(ret));
    result.set(&quot;status&quot;, (int)DECODER_ERROR::AVCODEC_SEND_PACKET);
    return result;
  }
}
</code></pre>
<p>Makefile</p>
<pre><code class="language-makefile">all: ../web/ff.js

rebuild: clean all

CC = emcc
CFLAGS = -O3 -I../lib/include
LIBOBJS := ../lib/lib/libavcodec.a ../lib/lib/libavutil.a ../lib/lib/libavformat.a
EMCCFLAGS = -gsource-map -g --bind -s ASYNCIFY -s WASM=1 -s ALLOW_TABLE_GROWTH=1 -s ALLOW_MEMORY_GROWTH=1 -s FILESYSTEM=0 -s ASSERTIONS=1

../web/ff.js: ff.cpp $(LIBOBJS)
 $(CC) $(EMCCFLAGS) $(CFLAGS) -o $@ $^

fflib: build-ffmpeg.sh
 sh build-ffmpeg.sh

clean:
 rm -f ff.js ff.wasm
</code></pre>
<h2 id="web-ç«¯"><a class="header" href="#web-ç«¯"><code>web</code> ç«¯</a></h2>
<p>é¦–å…ˆè¦å®ç°ä¸€ä¸ªè§†é¢‘æ¥æºå¯¹è±¡ï¼Œä¸»è¦é€»è¾‘å°±æ˜¯åœ¨è°ƒç”¨ <code>next</code> æ–¹æ³•æ—¶ï¼Œå°†è§†é¢‘æ•°æ®è¿”å›ï¼ŒåŒæ—¶ï¼Œå¦‚æœæ•°æ®å¤ªå¤šï¼Œå°±å…ˆç¼“å­˜ç€ï¼š</p>
<pre><code class="language-js">async function beginReadPacket() {
  let cachedSize = 0
  /**

* @type {Uint8Array[]}
   */
  const cachedChunks = []
  const reader = (await fetch('test.mkv')).body.getReader()
  const combineChunks = size =&gt; {
    let resultSize = 0
    const result = new Uint8Array(size)
    while (resultSize &lt; size) {
      const chunk = cachedChunks.shift()
      if (chunk.length + resultSize &gt; size) {
        const needSize = size - resultSize
        result.set(chunk.slice(0, needSize), resultSize)
        resultSize += needSize
        cachedChunks.unshift(chunk.slice(needSize))
        break
      } else {
        result.set(chunk, resultSize)
        resultSize += chunk.length
      }
    }
    cachedSize -= result.length
    return result
  }
  return async size =&gt; {
    while (cachedSize &lt; size) {
      const { done, value } = await reader.read()
      if (done) {
        if (!cachedSize) return { done }
        return { data: combineChunks(cachedSize) }
      }
      cachedChunks.push(value)
      cachedSize += value.length
    }
    return { data: combineChunks(size) }
  }
}
</code></pre>
<p>ç„¶åå°±æ˜¯åœ¨ <code>requestAnimationFrame</code> ä¸­è°ƒç”¨ <code>decoder.next</code> æ¥æ‹‰å»è§†é¢‘å¸§äº†ï¼Œå°±ä¸å†™äº†ã€‚å½“ç„¶ï¼Œæœ€åè¿˜æœ‰ä¸€æ­¥æ˜¯æ‹¿è§£ç åçš„ <code>YUV</code> æ•°æ®ä¸¢ç»™ <code>WebGL</code> æ¸²æŸ“ï¼Œå…·ä½“å°±ä¸å±•å¼€äº†ã€‚</p>
<h2 id="é—®é¢˜"><a class="header" href="#é—®é¢˜">é—®é¢˜</a></h2>
<p>è™½ç„¶æœ€å¼€å§‹æ˜¯å› ä¸º <code>H.265</code> æ— æ³•æ’­æ”¾ï¼Œæ‰å»åšè¿™ä¸ªä¸œè¥¿çš„ï¼Œä½†æ˜¯å§ï¼Œåšå®Œä¹‹åå‘ç°ï¼Œå°±è¿™æ ·è¿˜çœŸä¸ä¸€å®šèƒ½æ’­æ”¾ <code>mp4</code> å°è£…çš„ <code>H.265</code> è§†é¢‘ã€‚</p>
<p>å¯¹äº <code>mp4</code> æ ¼å¼çš„æ–‡ä»¶ä¿¡æ¯ <code>moov</code> <code>box</code> æœ‰å¯èƒ½æ˜¯åœ¨æ–‡ä»¶æœ€åçš„ï¼Œæˆ‘è¿™é‡Œå®ç°çš„æ–¹æ³•æ˜¯å–è§†é¢‘æµï¼Œä¸€éƒ¨åˆ†ä¸€éƒ¨åˆ†çš„è§£ç ï¼Œå°±ä¼šå¯¼è‡´å–ä¸åˆ°è§†é¢‘ä¿¡æ¯ã€‚æ‰€ä»¥å¯¹äºè¿™ç§è§†é¢‘æ–‡ä»¶ï¼Œè¦ä¹ˆæ˜¯æŠŠè§†é¢‘æ•°æ®å–å®Œæ•´äº†ï¼Œä¸€è‚¡è„‘å¡è¿› <code>ffmpeg</code> å–è¯†åˆ«ï¼Œæˆ–è€…ä¹Ÿå¯ä»¥æŠŠä»–çš„ <code>moov</code> <code>box</code> æ”¾åˆ°å‰é¢ï¼Œæˆ–è€…ç›´æ¥æŒ‡å®šè§£ç å™¨å‚æ•°ä¹Ÿå¯ä»¥å§ã€‚</p>
<p>ä¸‹é¢çš„å‘½ä»¤å°† <code>mp4</code> è§†é¢‘çš„ <code>moov</code> <code>box</code> æ”¾å‰é¢ï¼š</p>
<pre><code class="language-shell">ffmpeg -i test.mkv -c:v libx265 -preset ultrafast -c:a copy -movflags faststart test.mp4
</code></pre>
<h2 id="å‚è€ƒèµ„æ–™"><a class="header" href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li><a href="https://github.com/3dgen/cppwasm-book">C/C++é¢å‘WebAssemblyç¼–ç¨‹</a></li>
<li><a href="https://stackoverflow.com/questions/41734219/avformat-open-input-fails-only-with-a-custom-io-context">avformat_open_input fails only with a custom IO context</a></li>
<li><a href="https://blog.csdn.net/wowotou_heihei/article/details/115622917">avformat_open_inputè¿”å›-1094995529 â€œInvalid data found when processing inputâ€œ</a></li>
<li><a href="https://www.cnblogs.com/leisure_chn/p/10318145.html">FFmpegå†…å­˜IOæ¨¡å¼(å†…å­˜åŒºä½œè¾“å…¥æˆ–è¾“å‡º)</a></li>
<li><a href="https://github.com/lightfish-zhang/mpegUtil">ffmpeg çš„ç¼–ç¨‹æ•™ç¨‹</a></li>
<li><a href="https://segmentfault.com/a/1190000017980746">ä¸€æ­¥æ­¥è¿›è¡Œffmpegçš„Cè¯­è¨€éŸ³è§†é¢‘ç¼–ç¨‹</a></li>
<li><a href="https://segmentfault.com/a/1190000021378256">ffmpeg AVIOContext è‡ªå®šä¹‰ IO åŠ seek</a></li>
<li><a href="https://cloud.tencent.com/developer/article/1669163">FFmpegè¿›è¡ŒéŸ³é¢‘çš„è§£ç å’Œæ’­æ”¾</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="åˆä¸€ä¸ª-wordpress-åšå®¢çš„åˆå§‹é…ç½®"><a class="header" href="#åˆä¸€ä¸ª-wordpress-åšå®¢çš„åˆå§‹é…ç½®">åˆä¸€ä¸ª WordPress åšå®¢çš„åˆå§‹é…ç½®</a></h1>
<p>ç«™ç‚¹ç»“æ„ï¼š<code>nginx</code> =&gt; <code>WordPress</code></p>
<h2 id="é…ç½®-https"><a class="header" href="#é…ç½®-https">é…ç½® HTTPS</a></h2>
<pre><code class="language-conf"># ç”Ÿæˆå…¬ç§é’¥å¯¹
ssh-keygen ...

# ç”Ÿæˆè¯ä¹¦ç”³è¯·è¯·æ±‚
openssl req -new -sha256 -key cert.key -subj &quot;/C=CN/ST=Anhui/L=Wuhu/O=whit/CN=hamflx.cn&quot; \
    -reqexts SAN -config &lt;(cat /etc/pki/tls/openssl.cnf \
    &lt;(printf &quot;[SAN]\nsubjectAltName=DNS:hamflx.cn,DNS:*.hamflx.cn&quot;)) \
    &gt;cert.csr

# ç”³è¯·é€šé…ç¬¦è¯ä¹¦
docker run -it --rm \
    -e DP_Id=DP_Id \
    -e DP_Key=DP_Key \
    -v $PWD:/acme.sh \
    neilpang/acme.sh \
    --signcsr \
    --csr /acme.sh/cert.csr \
    --dns dns_dp
</code></pre>
<p>å¼ºåˆ¶æµé‡ä» <code>http</code> é‡å®šå‘åˆ° <code>https</code> çš„ <code>nginx</code> çš„é…ç½®ï¼š</p>
<pre><code class="language-conf">server {
  listen 80 default_server;
  listen [::]:80 default_server;
  server_name _;
  return 301 https://$host$request_uri;
}
</code></pre>
<h2 id="é…ç½®-http-20"><a class="header" href="#é…ç½®-http-20">é…ç½® HTTP 2.0</a></h2>
<pre><code class="language-conf">server {
    listen       443 default_server ssl http2;
    listen  [::]:443 default_server ssl http2;
    server_name  www.hamflx.cn hamflx.cn;

    ssl_certificate     /hamflx.cn/fullchain.cer;
    ssl_certificate_key /hamflx.cn/cert.key;

    location / {
        root   /usr/share/nginx/html;
        index  index.html index.htm;

        # æ³¨æ„è¿™é‡Œä¸€å®šè¦åŠ ï¼Œä¸ç„¶åœ¨ç™»å½•çš„æ—¶å€™ä¼šä¸€ç›´é‡å®šå‘ã€‚
        proxy_set_header   X-Forwarded-Proto $scheme;

        proxy_pass https://www.hamflx.cn;
    }
}
</code></pre>
<h2 id="é…ç½®é‚®ç®±"><a class="header" href="#é…ç½®é‚®ç®±">é…ç½®é‚®ç®±</a></h2>
<p>è¿™é‡Œå¹¶ä¸ä½¿ç”¨ <code>WP-SMTP</code> ç±»ä¼¼çš„æ’ä»¶ï¼Œè€Œæ˜¯é€šè¿‡â€œ<code>My Custom Functions</code>â€æ’ä»¶æ¥å®ç°è¿™ä¸ªåŠŸèƒ½ã€‚è¿™ä¸ªæ’ä»¶ä¸é‚®ç®±åŠŸèƒ½æ— å…³ï¼Œä½†æ˜¯å¯ä»¥æ’å…¥ä»£ç åˆ° <code>WordPress</code>ï¼Œè¿™é‡Œåªéœ€è¦å†™ä¸€ä¸ªé‚®ç®±åŠŸèƒ½åˆå§‹åŒ–çš„å‡½æ•°æ’å…¥åˆ° <code>WordPress</code> å³å¯ã€‚</p>
<p>ä½†æ˜¯å¯ç”¨é‚®ç®±ä¹‹åï¼Œæ¿€æ´»é‚®ä»¶å’Œé‡ç½®å¯†ç é‚®ä»¶ä¸­çš„é“¾æ¥ç‚¹å‡»éƒ½æ— æ•ˆï¼Œè¿™æ˜¯ <code>WordPress</code> çš„ä¸€ä¸ª <code>BUG</code>ã€‚ä»£ç ä¸­çš„ <code>h_mail_filter</code> å‡½æ•°å³æ˜¯ä¸ºè§£å†³è¿™ä¸ªé—®é¢˜çš„ã€‚</p>
<p>åœ¨å¼€å§‹ä¹‹å‰ä½ éœ€è¦ä¸€ä¸ªå…·æœ‰ <code>SMTP</code> åŠŸèƒ½çš„é‚®ä»¶æœåŠ¡å™¨ç”¨æ¥å‘é€é‚®ä»¶ï¼Œå¦‚æœæ²¡æœ‰å¯ä»¥ä½¿ç”¨ <code>QQ</code> é‚®ç®±ã€‚</p>
<h2 id="é…ç½®æ¸…å•"><a class="header" href="#é…ç½®æ¸…å•">é…ç½®æ¸…å•</a></h2>
<p>åœ¨ <code>My Custom Functions</code> æ’ä»¶ä¸­çš„ <code>Settings</code> é¡µé¢ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç ï¼š</p>
<pre><code class="language-php">function h_override_mail_from_name($email) {
    return 'å¹»æ¢¦';
}

function h_override_mail_from($email) {
    return 'service@hamflx.cn';
}

function h_mail_filter($args) {
    $args['message'] = preg_replace(&quot;/&lt;(.*?)&gt;/&quot;, &quot;$1&quot;, $args['message']);
    return $args;
}

function h_mail_smtp($phpmailer) {
    $phpmailer-&gt;IsSMTP();
    $phpmailer-&gt;SMTPAuth = true;
    $phpmailer-&gt;Port = 465;
    $phpmailer-&gt;SMTPSecure = &quot;ssl&quot;;
    $phpmailer-&gt;Host = &quot;smtp.qq.com&quot;;
    $phpmailer-&gt;Username = &quot;service@hamflx.cn&quot;;
    $phpmailer-&gt;Password = &quot;Your Token&quot;;
}

add_filter('wp_mail_from_name', 'h_override_mail_from_name');
add_filter('wp_mail_from', 'h_override_mail_from');
add_filter('wp_mail', 'h_mail_filter');

add_action(&quot;phpmailer_init&quot;, &quot;h_mail_smtp&quot;);
</code></pre>
<h2 id="å¯ç”¨-qq-é‚®ç®±-smtp-åŠŸèƒ½"><a class="header" href="#å¯ç”¨-qq-é‚®ç®±-smtp-åŠŸèƒ½">å¯ç”¨ QQ é‚®ç®± SMTP åŠŸèƒ½</a></h2>
<p>è‹¥ä½¿ç”¨ <code>QQ</code> é‚®ç®±ï¼Œåˆ™éœ€è¦å¯ç”¨ <code>QQ</code> é‚®ç®±çš„ <code>SMTP</code> åŠŸèƒ½å¹¶ç”Ÿæˆæˆæƒç ï¼ˆä½œä¸º <code>SMTP</code> ç™»å½•æ—¶çš„å¯†ç ï¼‰ã€‚</p>
<p>åœ¨ <code>QQ</code> é‚®ç®±çš„è®¾ç½®é¡µé¢ä¸­è¿›å…¥åˆ°â€œè´¦æˆ·â€é€‰é¡¹å¡ï¼Œæ‰¾åˆ°ä¸‹å›¾çš„é…ç½®ï¼Œå¯ç”¨â€œ<code>POP3/SMTP</code>â€æœåŠ¡ã€ç”Ÿæˆæˆæƒç ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™-1"><a class="header" href="#å‚è€ƒèµ„æ–™-1">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li><a href="https://leonax.net/p/6391/implement-wordpress-email-notification-myself/">è‡ªå·±åŠ¨æ‰‹å®ç° WordPress çš„é‚®ä»¶é€šçŸ¥åŠŸèƒ½</a></li>
<li><a href="https://www.jerryzone.cn/diy-wp-email-content/">WordPressä¸­å„ç§é‚®ä»¶å†…å®¹åŠæ ‡é¢˜çš„è‡ªå®šä¹‰</a></li>
<li><a href="https://www.cnblogs.com/kenshinobiy/p/7441781.html">å®Œç¾è§£å†³wordpressé‚®ä»¶é“¾æ¥æ— æ•ˆçš„é—®é¢˜</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹"><a class="header" href="#è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹">è®°ä¸€æ¬¡å†…å­˜æ³„æ¼çš„æ’æŸ¥è¿‡ç¨‹</a></h1>
<p><code>JavaScript</code> æ˜¯æœ‰åƒåœ¾å›æ”¶æœºåˆ¶çš„ï¼Œä¸€èˆ¬ä¸å¤ªéœ€è¦è€ƒè™‘èµ„æºé‡Šæ”¾çš„é—®é¢˜ã€‚ç„¶è€Œï¼Œå³ä½¿æœ‰åƒåœ¾å›æ”¶å…œåº•ï¼Œä½†æ˜¯ä»£ç å†™çš„å¤ªè¿‡äºå¥”æ”¾ï¼Œä»ç„¶å­˜åœ¨ä¸å°çš„é—®é¢˜ã€‚è¿™ç¯‡æ–‡ç« å°±ä»¥ <code>********</code> æ’æŸ¥å‡ºçš„é—®é¢˜åšä¸ªç®€å•ä»‹ç»ï¼ˆæ³¨ï¼š<code>********</code> ä¸ºå†…éƒ¨é¡¹ç›®åç§°ï¼Œä¸‹åŒï¼‰ã€‚</p>
<h2 id="æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼"><a class="header" href="#æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼">æ£€æŸ¥æ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼</a></h2>
<p>æœ‰ç”¨æˆ·åé¦ˆåœ¨ <code>********</code> ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå¶å°”ä¼šå‡ºç°æµè§ˆå™¨å´©æºƒçš„é—®é¢˜ï¼Œç„¶ååœ¨ä¸€æ¬¡å‘ç‰ˆæœ¬çš„è¿‡ç¨‹ä¸­ï¼Œ<code>****</code> å‘ç°äº†å†…å­˜å ç”¨è¾¾åˆ°äº† <code>1GB</code> ç¨‹åº¦ï¼Œå¦‚ä¸‹å›¾ï¼ˆæˆªå›¾æ˜¯åæ¥æˆªçš„ï¼Œå«Œéº»çƒ¦å°±ç‚¹åˆ° <code>579MB</code>ï¼Œå¤šç‚¹å‡ æ¬¡æ€»æ˜¯èƒ½åˆ° <code>1GB</code> çš„ ğŸ˜ï¼‰ï¼š</p>
<p><img src="posts/2021/1/24/./assets/large-memory.png" alt="å†…å­˜å ç”¨" title="å†…å­˜å ç”¨" /></p>
<p>ä¸è¿‡è¿™ <code>579MB</code> æ˜¯æ­£å¸¸å†…å­˜å ç”¨ï¼Œè¿˜æ˜¯å†…å­˜æ³„æ¼äº†å‘¢ï¼Ÿå¾ˆç®€å•ï¼Œå¦‚æœåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œå†…å­˜å ç”¨æœªå¢åŠ ï¼Œæˆ–å¢åŠ çš„éƒ½èƒ½åœ¨ä¸€æ®µæ—¶é—´åï¼ˆ<code>GC</code> æ‰§è¡Œäº†ä¹‹åï¼‰æ­£å¸¸é‡Šæ”¾æ‰ï¼Œéƒ½æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­ï¼Œå†…å­˜ä¸€ç›´å¢é•¿è€Œä»æœªå‡å°‘ï¼Œå³å­˜åœ¨å†…å­˜æ³„æ¼ã€‚</p>
<p>é€šè¿‡å¼€å‘è€…å·¥å…·é‡Œé¢çš„ <code>Memory</code> é¢æ¿ï¼Œå³å¯çœ‹åˆ°å†…å­˜å ç”¨ï¼Œä½¿ç”¨ <code>Heap snapshot</code> å·¥å…·å¯¹å†…å­˜å ç”¨åšå¿«ç…§ï¼Œåœ¨ä¸€é¡¿çŒ›çƒˆçš„æ“ä½œä¹‹å‰ä»¥åŠä¹‹åï¼Œåˆ†åˆ«åšå¿«ç…§ï¼Œç„¶åå¯¹æ¯”ä¸€ä¸‹å°±å¯ä»¥çŸ¥é“æœ‰æ²¡æœ‰å†…å­˜æ³„æ¼äº†ã€‚</p>
<p>ä»¥ <code>********</code> ä¸¾ä¾‹è¯¦ç»†è¯´ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>å¼„æ¸…æ¥šä½ è¦æ’æŸ¥å“ªä¸€æ­¥å¯èƒ½å­˜åœ¨å†…å­˜æ³„æ¼ï¼Œæ¯”å¦‚æˆ‘éœ€è¦æ’æŸ¥ <code>A</code> ä¸ <code>B</code> é¡µé¢<strong>æ¥å›åˆ‡æ¢æ—¶</strong>ï¼Œæ˜¯å¦å­˜åœ¨å†…å­˜æ³„æ¼ï¼›</li>
<li>å…ˆæ‰“å¼€ <code>********</code> çš„ B é¡µé¢<strong>ç­‰å¾…åŠ è½½å®Œæ¯•</strong>ï¼Œå› ä¸ºå¦‚æœä½ åˆ‡æ¢å¿«äº†ï¼Œå¯èƒ½ä¹Ÿä¼šé€ æˆå†…å­˜æ³„æ¼ï¼ˆæ¯”æ–¹è¯´ï¼Œåœ¨æ¥å£è¿”å›åæ·»åŠ äº‹ä»¶ï¼‰ï¼Œè¿™é‡Œè¦<strong>ä¸€æ­¥æ­¥</strong>æ’æŸ¥ï¼Œå°±æ˜¯æ§åˆ¶å˜é‡æ³•ï¼‰ï¼›</li>
<li>ç„¶å<strong>åˆ‡æ¢åˆ° A é¡µé¢</strong>ï¼Œåšå¿«ç…§ä¹‹å‰è¦<strong>å…ˆ</strong>æŠŠç›®æ ‡é¡µé¢<strong>åŠ è½½ä¸€æ¬¡</strong>ï¼Œå› ä¸ºâ€œå†·å¯åŠ¨â€ä¹Ÿæ˜¯è¦æ¶ˆè€—èµ„æºçš„ï¼›</li>
<li>å†åˆ‡æ¢å› B é¡µé¢ï¼Œåœ¨ <code>Memory</code> é¢æ¿ä¸­é€‰æ‹© <code>Heap snapshot</code> ç„¶åç‚¹ <code>Take snapshot</code> åšåˆå§‹çš„å¿«ç…§ï¼ˆåšå¿«ç…§ä¹‹å‰è¦ç‚¹å‡»ä¸€æ¬¡ <code>GC</code> æŒ‰é’®ï¼Œå‚ç…§ä¸‹å›¾ï¼‰ï¼›</li>
<li>ç‚¹å‡» A é¡µé¢ =&gt; ç‚¹å‡» B é¡µé¢ =&gt; ç‚¹å‡» A é¡µé¢ =&gt; ç‚¹å‡» B é¡µé¢ï¼Œåæ­£å°±æ˜¯ä¸€é¡¿æ“ä½œå°±æ˜¯äº†ï¼Œæ³¨æ„<strong>æ‰‹é€Ÿ</strong>ï¼Œ<strong>ä¸è¦</strong>æŠŠå…¶ä»–<strong>ä¸ç¡®å®šå› ç´ </strong>å¼•å…¥è¿›æ¥ï¼›</li>
<li>æœ€ååœç•™åœ¨åš<strong>åˆå§‹å†…å­˜å¿«ç…§</strong>çš„é¡µé¢ï¼Œè¿™é‡Œæ˜¯ B é¡µé¢ï¼Œç„¶åå†åšä¸€ä¸ªå†…å­˜å¿«ç…§ï¼ˆåˆ«å¿˜äº†å…ˆç‚¹ <code>GC</code> æŒ‰é’®ï¼‰ï¼›</li>
<li>å¯¹æ¯”ä¸€ä¸‹ä¸¤ä¸ªæ•°å­—å°±å¥½äº†ï¼Œå¦‚æœæ²¡æœ‰å¤ªå¤§å·®è·çš„è¯ï¼Œæ˜¾ç„¶æ˜¯æ²¡æœ‰å†…å­˜æ³„æ¼çš„ï¼ˆå½“ç„¶ï¼Œä¸ºäº†é¿å…è¯¯åˆ¤ï¼Œä½ å¯ä»¥å¤šé‡å¤å‡ æ¬¡ç¬¬ <code>5</code> æ­¥çš„æ“ä½œï¼‰ï¼Œå¦åˆ™ï¼Œå­˜åœ¨å†…å­˜æ³„æ¼ã€‚</li>
</ol>
<p><img src="posts/2021/1/24/./assets/devtools-memory-panel.png" alt="Memory é¢æ¿" title="Memory é¢æ¿" /></p>
<p>ä¸‹é¢æ˜¯ <code>********</code> çš„ï¼ˆå½“ç„¶æ˜¯ç‚¹äº†å¾ˆå¤šå¾ˆå¤šæ¬¡æ‰ä¼šæœ‰è¿™ä¸ªæ•°æ®çš„ ğŸ¤£ï¼‰ï¼š</p>
<p><img src="posts/2021/1/24/./assets/memory-snapshots.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<h2 id="æ’æŸ¥é—®é¢˜æ ¹æº"><a class="header" href="#æ’æŸ¥é—®é¢˜æ ¹æº">æ’æŸ¥é—®é¢˜æ ¹æº</a></h2>
<p><img src="posts/2021/1/24/./assets/memory-snapshot-summary.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>æ‹¿å‡ºä¸Šé¢æ­¥éª¤çš„ç¬¬äºŒä¸ªå¿«ç…§ï¼ˆå›¾ç‰‡é‡Œåªæœ‰ä¸€ä¸ªæ˜¯å› ä¸ºæˆ‘æŠŠç¬¬ä¸€ä¸ªåˆ äº†ï¼‰ï¼Œå±•å¼€ <code>a</code>ï¼ˆå°±æ˜¯ <code>VueComponent</code>ï¼Œç»éªŒï¼‰ï¼Œå¯ä»¥çœ‹åˆ°ç¬¬ä¸€ä¸ª <code>a</code> çš„â€œä¸‰å›´â€ï¼š</p>
<ul>
<li><code>Distance</code> 14 è¢«å¼•ç”¨çš„æ·±åº¦ï¼Œè¡¨ç¤ºç”± <code>GC</code> æ ¹ï¼ˆæ¯”å¦‚ <code>window</code> å¯¹è±¡ã€DOM æ•°æ ¹èŠ‚ç‚¹ï¼‰åˆ°è¯¥å¯¹è±¡ä¹‹é—´æœ€çŸ­çš„å¼•ç”¨æ•°é‡ã€‚</li>
<li><code>Shallow Size</code> æµ…å±‚å¤§å°ï¼Œè¯¥å¯¹è±¡æœ¬èº«çš„å¤§å°ã€‚</li>
<li><code>Reatined Size</code> ä¿ç•™å¤§å°ï¼Œè¡¨ç¤ºå¦‚æœå½“å‰å¯¹è±¡è¢«é‡Šæ”¾åï¼Œæ‰€æœ‰çš„ä» <code>GC</code> æ ¹æ— æ³•è¾¾åˆ°çš„å¯¹è±¡çš„æ€»çš„å¤§å°ï¼Œç®€å•ç‚¹è¯´ï¼Œé‡Šæ”¾äº†è¿™ä¸ªå¯¹è±¡ï¼Œèƒ½é‡Šæ”¾å¤šå°‘å†…å­˜ã€‚</li>
</ul>
<p>æˆ‘ä»¬ä¸»è¦å…³æ³¨ <code>Distance</code> å’Œ <code>Reatined Size</code>ï¼Œå‰è€…å¦‚æœè¾ƒå¤§ï¼Œæˆ‘ä»¬å¯èƒ½å°±è¦å…³æ³¨ä¸€ä¸‹è¿™ä¸ªå¯¹è±¡æ˜¯ä¸æ˜¯æœ‰é—®é¢˜ã€‚æ¯”å¦‚ç¬¬ä¸€ä¸ª <code>a</code> å¯¹è±¡ï¼Œé¼ æ ‡æ‚¬æµ® <code>a @8001491</code> åï¼Œèƒ½çœ‹åˆ°è¯¥å¯¹è±¡çš„æ•°æ®ï¼š</p>
<p><img src="posts/2021/1/24/./assets/memory-snapshot-first-a-detail.png" alt="å†…å­˜å¿«ç…§-ç¬¬ä¸€ä¸ªaå¯¹è±¡" title="å†…å­˜å¿«ç…§-ç¬¬ä¸€ä¸ªaå¯¹è±¡" /></p>
<p>å‘ç°å®ƒæ˜¯ä¸€ä¸ª <code>Vue</code> ç»„ä»¶çš„å®ä¾‹ï¼Œé¼ æ ‡æ‚¬æµ®åˆ° <code>$el</code> çš„å€¼ä¸Šé¢ï¼Œå¦‚æœè¿™ä¸ªå…ƒç´ ä»ç„¶åœ¨é¡µé¢ä¸Šä¸”æ˜¯å¯è§çš„ï¼Œå®ƒå°±ä¼šåƒå®¡æŸ¥å…ƒç´ æ—¶ä¸€æ ·è¦†ç›–ä¸€å±‚è“è‰²çŸ©å½¢åŒºåŸŸï¼Œæ˜¾ç„¶è¿™ä¸ªæ²¡æœ‰ï¼ˆå¯ä»¥å†å±•å¼€å…¶å±æ€§ï¼Œçœ‹çœ‹ <code>isConnected</code>ã€<code>className</code>ã€<code>innerHTML</code> äº†è§£å…·ä½“æ˜¯å“ªé‡Œçš„é€»è¾‘ï¼Œä»¥åŠæ˜¯å¦ä» <code>DOM</code> æ ‘ä¸Šç§»é™¤äº†ï¼Œè¿™é‡Œçš„è¿™ä¸ªå®ä¾‹æ˜¯ä¸€ä¸ªè¡¨æ ¼ç»„ä»¶ï¼‰ã€‚è€Œå®ƒçš„ <code>Retained Size</code> åˆ™è¡¨ç¤ºäº†ï¼Œå¦‚æœæŠŠè¿™ä¸ªå¯¹è±¡ç»™é‡Šæ”¾äº†ï¼Œå¯ä»¥é‡Šæ”¾çº¦ <code>1MB</code> 2% çš„å†…å­˜ã€‚</p>
<p>ç‚¹å‡»è¿™ä¸ªå¯¹è±¡å¯ä»¥çœ‹åˆ°ç”±è¯¥å¯¹è±¡åˆ° <code>GC</code> æ ¹çš„å¼•ç”¨å…³ç³»ï¼š</p>
<p><img src="posts/2021/1/24/./assets/memory-snapshot-detail.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>è¿™å¼ å›¾è¯´æ˜ï¼šè¿™ä¸ªè¡¨æ ¼ç»„ä»¶æ˜¯å¦ä¸€ä¸ª <code>a</code>ï¼ˆ<code>VueComponent</code>ï¼‰ç»„ä»¶çš„ <code>$parent</code> å±æ€§ï¼Œå³ä½œä¸ºå¦ä¸€ä¸ªç»„ä»¶çš„çˆ¶ç»„ä»¶è€Œè¢«å¼•ç”¨äº†ï¼Œä¸²è”èµ·æ¥å°±æ˜¯ï¼Œè¿™ä¸ªè¡¨æ ¼ç»„ä»¶è¢«å­ç»„ä»¶å¼•ç”¨äº†ï¼Œå­ç»„ä»¶åˆè¢«å­ç»„ä»¶å¼•ç”¨äº†è€Œå­ç»„ä»¶åˆè¢«å­ç»„ä»¶å¼•ç”¨äº†ï¼Œè€Œè¿™ä¸ªå­ç»„ä»¶åˆè¢«ä¸€ä¸ªæ–¹æ³•å¼•ç”¨äº†ï¼ˆè¿™ä¸ªæ–¹æ³•ä½¿ç”¨ <code>bind</code> ç»‘å®šäº†è¿™ä¸ªç»„ä»¶ï¼‰ï¼Œè¿™ä¸ªæ–¹æ³•åˆè¢«ä½œä¸ºä¸€ä¸ª <code>DOM</code> å…ƒç´ çš„äº‹ä»¶è¢«å¼•ç”¨äº†ï¼Œè€Œè¿™ä¸ª <code>DOM</code> å…ƒç´ åˆè¢« <code>InternalNode</code> å¼•ç”¨äº†ï¼Œè¿™ä¸ª <code>InternalNode</code> å±äº <code>HTMLDocument</code>ã€‚</p>
<p>å³ï¼Œè¿™ä¸ªè¡¨æ ¼é‡Œé¢æœ‰ä¸ªç»„ä»¶æ·»åŠ äº†äº‹ä»¶ï¼Œä½†æ˜¯ç»„ä»¶é”€æ¯çš„æ—¶å€™æ²¡æœ‰æŠŠäº‹ä»¶ç§»é™¤ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ªå…ƒç´ æ³„æ¼äº†ï¼Œå¯¼è‡´æ•´ä¸ªè¡¨æ ¼æ³„æ¼äº†ã€‚</p>
<p>å°†é¼ æ ‡æ‚¬æµ®åˆ° <code>bound_this in native_bind() @7606219</code> ä¸Šï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="posts/2021/1/24/./assets/memory-snapshot-first-a-event.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>æ‰¾åˆ°äº†è¿™ä¸ªè¢«æ·»åŠ è€Œæ²¡æœ‰è¢«ç§»é™¤çš„äº‹ä»¶å« <code>handleBlur</code>ã€‚OKï¼Œä½ ç°åœ¨æ˜¯ä¸æ˜¯æƒ³å…¨å±€æœç´¢ <code>handleBlur</code> æ–¹æ³•äº†ï¼Ÿ</p>
<p><img src="posts/2021/1/24/./assets/found-handle-blur.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>è¿˜çœŸæœåˆ°äº†ã€‚ã€‚ã€‚ä¸è¿‡ï¼Œè¿™æ ·å¤ªéº»çƒ¦äº†ï¼Œå¯ä»¥çœ‹çœ‹è¿™ä¸ª <code>bind</code> ç»‘å®šçš„åˆ°åº•æ˜¯å“ªä¸ªç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯é¼ æ ‡æ‚¬æµ®è¿™ä¸ªä¸Šé¢çš„é‚£ä¸€æ¡è®°å½• <code>$parent in a @9400441</code>ï¼Œå¯ä»¥çœ‹åˆ°ï¼š</p>
<p><img src="posts/2021/1/24/./assets/memory-snapshot-first-a-dep-detail.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>é€šè¿‡å®¡æŸ¥è¿™ä¸ªå¯¹è±¡çš„ <code>$el</code> å¯ä»¥çŸ¥é“ï¼Œè¿™æ˜¯ä¸€ä¸ª <code>el-popover</code> ç»„ä»¶ï¼Œä¹Ÿå°±æ˜¯è¯´ <code>el-popover</code> ç›‘å¬äº† <code>handleBlur</code> äº‹ä»¶ï¼Œä½†æ˜¯å´æ²¡æœ‰ç§»é™¤ï¼Œæ‰“å¼€ <code>element</code> ä»“åº“åœ¨ <code>packages\popover\src\main.vue</code> ä¸­æœç´¢ <code>handleBlur</code>ï¼š</p>
<p><img src="posts/2021/1/24/./assets/element-popover-handle-blur.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåªæ·»åŠ äº†è¯¥äº‹ä»¶ï¼Œè€Œæ²¡æœ‰ç§»é™¤è¯¥äº‹ä»¶ã€‚</p>
<h2 id="ä¿®å¤å†…å­˜æ³„æ¼é—®é¢˜"><a class="header" href="#ä¿®å¤å†…å­˜æ³„æ¼é—®é¢˜">ä¿®å¤å†…å­˜æ³„æ¼é—®é¢˜</a></h2>
<p><code>Google</code> æœç´¢ <code>el-popover å†…å­˜æ³„æ¼</code>ï¼Œç„¶åå¤åˆ¶ã€ç²˜è´´ï¼Œ<code>over</code>ã€‚ä¸å¯¹ï¼Œæœç´¢ç»“æœç¬¬ä¸€æ¡æ˜¯ï¼š</p>
<blockquote>
<p>el-popover leaking memory Â· Issue #2561 Â· ElemeFE/element ...</p>
</blockquote>
<p>2017 å¹´çš„ <code>Issue</code>ï¼Œç‚¹å¼€ä¸€çœ‹ï¼Œå¯¹åº”çš„ <code>PR</code> å·²ç»åˆå¹¶äº†ï¼Œè€Œä¸”æ˜¯ç‚¹å‡»äº‹ä»¶ï¼Œä¸æ˜¯ <code>focusout</code> äº‹ä»¶ï¼Œéš¾é“æ˜¯å®šä½é”™äº†ï¼Ÿå…¶å®ç”¨ <code>el-tooltip å†…å­˜æ³„æ¼</code>ã€<code>el-popover memory leak</code> ä¸ºå…³é”®å­—æœç´¢æ˜¯å¯ä»¥æœç´¢åˆ° <a href="https://github.com/ElemeFE/element/issues/19370" title="[Bug Report] Memory leak at el-tooltip cleanup">[Bug Report] Memory leak at el-tooltip cleanup</a>ï¼Œæè¿™ä¸ª <code>bug</code> çš„ä»å…„è¿˜æäº†ä¸¤ä¸ª <code>PR</code> ä¿®å¤ <code>el-tooltip</code>ï¼Œè¿˜æœ‰ä½ä»å…„ä¹Ÿæäº† <code>PR</code> ä¿®å¤ <code>el-tooltip</code> å’Œ <code>el-popover</code>ï¼Œç„¶è€Œã€‚ã€‚ã€‚</p>
<p>ä¸ºäº†ä¿®å¤è¿™ä¸ªé—®é¢˜ï¼Œè€Œä¸å…‹éš† <code>element</code> ä»“åº“ï¼Œæˆ‘ä»¬å¯ä»¥é‡å†™å¯¹åº”çš„æ–¹æ³•ï¼Œè¿™é‡Œæˆ‘æ‹¿ <code>el-tooltip</code> ä¸¾ä¾‹ï¼ŒåŸç‰ˆçš„ <code>el-tooltip</code> çš„ <code>mounted</code> ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-javascript">export default {
    // code ...

    mounted() {
        this.referenceElm = this.$el;
        if (this.$el.nodeType === 1) {
            this.$el.setAttribute('aria-describedby', this.tooltipId);
            this.$el.setAttribute('tabindex', this.tabindex);
            on(this.referenceElm, 'mouseenter', this.show);
            on(this.referenceElm, 'mouseleave', this.hide);
            on(this.referenceElm, 'focus', () =&gt; {
                if (!this.$slots.default || !this.$slots.default.length) {
                    this.handleFocus();
                    return;
                }
                const instance = this.$slots.default[0].componentInstance;
                if (instance &amp;&amp; instance.focus) {
                    instance.focus();
                } else {
                    this.handleFocus();
                }
            });
            on(this.referenceElm, 'blur', this.handleBlur);
            on(this.referenceElm, 'click', this.removeFocusing);
        }
    },

    // code ...

    destroyed() {
        const reference = this.referenceElm;
        if (reference.nodeType === 1) {
            off(reference, 'mouseenter', this.show);
            off(reference, 'mouseleave', this.hide);
            // è¿™é‡Œç§»é™¤äº† handleBlur æ–¹æ³•ï¼Œä½†æ˜¯å‰é¢æ·»åŠ çš„ä¸æ˜¯è¿™ä¸ªæ–¹æ³•ã€‚ã€‚ã€‚
            off(reference, 'focus', this.handleFocus);
            off(reference, 'blur', this.handleBlur);
            off(reference, 'click', this.removeFocusing);
        }
    }
}
</code></pre>
<p>é€šè¿‡å¦‚ä¸‹æ–¹æ³•é‡æ–°å®ç°å®ƒçš„ç›¸å…³æ–¹æ³•ï¼š</p>
<pre><code class="language-javascript">import { Tooltip } from 'element-ui'
import { on } from 'element-ui/lib/utils/dom'

Tooltip.methods.handleFocus = function () {
  if (!this.$slots.default || !this.$slots.default.length) {
    this.doFocus()
    return
  }
  const instance = this.$slots.default[0].componentInstance
  if (instance &amp;&amp; instance.focus) {
    instance.focus()
  } else {
    this.doFocus()
  }
}

Tooltip.methods.doFocus = function () {
  this.focusing = true
  this.show()
}

Tooltip.mounted = function () {
  this.referenceElm = this.$el
  if (this.$el.nodeType === 1) {
    this.$el.setAttribute('aria-describedby', this.tooltipId)
    // è¿™è¡Œä»£ç åœ¨ Element ä¸Šçš„æäº¤æ—¥å¿—æ˜¯ä¸ºäº†æ— éšœç¢è®¿é—®ï¼Œè¿™å°†å¯¼è‡´æµ‹è¯•æä¸€äº› bugï¼ˆç‚¹å‡»ç©ºç™½å¤„å…³é—­è¯¦æƒ…é¡µåï¼Œæ–‡å­—çš„ tooltip ä»ç„¶æ˜¾ç¤ºï¼‰ã€‚
    // this.$el.setAttribute('tabindex', 0)
    on(this.referenceElm, 'mouseenter', this.show)
    on(this.referenceElm, 'mouseleave', this.hide)
    on(this.referenceElm, 'focus', this.handleFocus)
    on(this.referenceElm, 'blur', this.handleBlur)
    on(this.referenceElm, 'click', this.removeFocusing)
  }
}

export default {
  install () {

  }
}
</code></pre>
<p>å³ï¼Œå°†åŸæ¥ç›´æ¥æ·»åŠ çš„äº‹ä»¶ï¼Œå†™æˆ <code>handleFocus</code> æ–¹æ³•ï¼ˆåŸæ¥ä¹Ÿæœ‰è¿™ä¸ªæ–¹æ³•ï¼Œæ•…æŠŠåŸæ¥çš„ <code>handleFocus</code> æ–¹æ³•æ”¹ä¸º <code>doFocus</code> æ–¹æ³•ï¼Œç„¶ååœ¨ <code>handleFocus</code> æ–¹æ³•é‡Œè°ƒç”¨ï¼Œè¿™æ ·å…¶ <code>destroyed</code> é‡Œé¢é‡Šæ”¾çš„äº‹ä»¶å°±æ˜¯æ·»åŠ çš„äº‹ä»¶äº†ã€‚</p>
<h2 id="å…¶ä»–é—®é¢˜"><a class="header" href="#å…¶ä»–é—®é¢˜">å…¶ä»–é—®é¢˜</a></h2>
<p>é€šè¿‡åŒæ ·çš„æ–¹å¼ï¼Œè¿˜å¯ä»¥æ‰¾åˆ°å®šæ—¶å™¨æœªé‡Šæ”¾ã€ç‚¹å‡»äº‹ä»¶æœªé‡Šæ”¾ä¹‹ç±»çš„é—®é¢˜ï¼Œä½†éƒ½æ˜¯é¡¹ç›®å†…çš„ä»£ç ï¼Œæ¯”è¾ƒå¥½è§£å†³å°±ä¸å±•å¼€äº†ã€‚</p>
<h2 id="æˆæœ"><a class="header" href="#æˆæœ">æˆæœ</a></h2>
<p><img src="posts/2021/1/24/./assets/result.png" alt="å†…å­˜å¿«ç…§" title="å†…å­˜å¿«ç…§" /></p>
<h2 id="æ·±å…¥æ€è€ƒ"><a class="header" href="#æ·±å…¥æ€è€ƒ">æ·±å…¥æ€è€ƒ</a></h2>
<p>ä¸çŸ¥é“å¤§å®¶æœ‰æ²¡æœ‰æ³¨æ„ï¼Œæœç´¢ä¸­æ–‡çš„ <code>el-popover</code> å†…å­˜æ³„æ¼æ²¡æœ‰æœç´¢åˆ°æƒ³è¦çš„ç»“æœï¼Œå…¶å®ä¸ç§»é™¤äº‹ä»¶ä¸€èˆ¬ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œè€Œä¸”ä¸ä¼šé€ æˆå†…å­˜æ³„æ¼ï¼Œæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹æ¯”è¾ƒéš¾ä»¥å‘ç°è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>ç°ä»£æµè§ˆå™¨éƒ½æ˜¯ç”¨ <code>æ ‡è®°</code>-<code>æ¸…é™¤</code> ç®—æ³•æˆ–åŸºäºå…¶æ”¹è¿›çš„ç®—æ³•æ¥å®ç°çš„åƒåœ¾å›æ”¶ã€‚å…¶åŸç†æ˜¯ä» <code>GC</code> æ ¹å¼€å§‹ï¼Œéå†æ‰€æœ‰å¼•ç”¨çš„å¯¹è±¡ï¼Œå¹¶å°†å…¶æ ‡è®°ï¼Œå½“ç®—æ³•éå†å®Œæ‰€æœ‰å¯¹è±¡åï¼Œé‚£äº›æœªè¢«æ ‡è®°çš„å¯¹è±¡å°†ä¼šè¢«æ¸…é™¤ã€‚</p>
<p>è€Œ <code>Vue.js</code> ä¼šåœ¨ç»„ä»¶è¢«é”€æ¯çš„æ—¶å€™ï¼Œé‡Šæ”¾å…¶å¼•ç”¨ï¼Œé‚£ä¹ˆå…¶å¼•ç”¨çš„å…ƒç´ ï¼Œä»¥åŠå…ƒç´ å¼•ç”¨çš„äº‹ä»¶éƒ½å°†æˆä¸ºæ— æ ¹æµ®èï¼Œä¼šè¢« <code>GC</code> å›æ”¶ã€‚</p>
<p>å†æ¬¡å®¡æŸ¥ä¸Šæ–‡ä¸­çš„è¡¨æ ¼ç»„ä»¶ï¼Œå¯ä»¥å‘ç° <code>V8EventListener</code> è¢« <code>Detached HTMLElement</code> å¼•ç”¨ï¼Œè€Œ <code>Detached HTMLElement</code> åˆè¢« <code>InternalNode</code> å¼•ç”¨ï¼Œè¿™ä¸ª <code>InternalNode</code> æ‰æ˜¯å®ƒæ²¡æœ‰è¢«é‡Šæ”¾çš„çœŸæ­£åŸå› ã€‚</p>
<p>è‡³äºè¿™ä¸ª <code>InternalNode</code> ç©¶ç«Ÿæ˜¯ä»€ä¹ˆï¼Œæˆ‘ä»¬ <code>N</code> æœŸä¹‹åå†è¯´ï¼ˆ<code>N â†’ âˆ</code>ï¼‰ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™-2"><a class="header" href="#å‚è€ƒèµ„æ–™-2">å‚è€ƒèµ„æ–™</a></h2>
<ul>
<li><a href="https://developers.google.com/web/tools/chrome-devtools/memory-problems/memory-101?hl=zh-cn" title="å†…å­˜æœ¯è¯­">å†…å­˜æœ¯è¯­</a></li>
<li><a href="https://developers.google.com/web/tools/chrome-devtools/memory-problems/heap-snapshots?hl=zh-cn" title="å¦‚ä½•è®°å½•å †å¿«ç…§">å¦‚ä½•è®°å½•å †å¿«ç…§</a></li>
<li><a href="https://github.com/ElemeFE/element/issues/19370" title="[Bug Report] Memory leak at el-tooltip cleanup">[Bug Report] Memory leak at el-tooltip cleanup</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Memory_Management" title="å†…å­˜ç®¡ç†">å†…å­˜ç®¡ç†</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="å¢å¼º-vue-é¡¹ç›®çš„æ™ºèƒ½æ„ŸçŸ¥"><a class="header" href="#å¢å¼º-vue-é¡¹ç›®çš„æ™ºèƒ½æ„ŸçŸ¥">å¢å¼º <code>Vue</code> é¡¹ç›®çš„æ™ºèƒ½æ„ŸçŸ¥</a></h1>
<p>æœ¬æ–‡è¯´çš„ç±»å‹æ”¯æŒä»…ä»…æ˜¯ <code>VS Code</code> çš„ <code>IntelliSense</code> åŠŸèƒ½ï¼Œå¹¶éé™æ€ç±»å‹è¯­è¨€çš„ç±»å‹æ£€æŸ¥ï¼Œæ‰€ä»¥å¯¹å¼€å‘çš„æ•ˆç‡æå‡ä¸å¤§ï¼Œä½†æ˜¯å¯ä»¥æé«˜é¡¹ç›®çš„å¯ç»´æŠ¤æ€§ï¼Œå³æ‰€è°“ä»£ç å³æ–‡æ¡£ <code>CaaD</code>ï¼ˆ<code>Code as a Documentation</code> -_-ï¼‰ã€‚</p>
<h2 id="vs-code-çš„-intellisense-åŠŸèƒ½"><a class="header" href="#vs-code-çš„-intellisense-åŠŸèƒ½"><code>VS Code</code> çš„ <code>IntelliSense</code> åŠŸèƒ½</a></h2>
<p>ä½¿ç”¨è¿‡ <code>IDE</code> ä¸é™æ€ç±»å‹è¯­è¨€çš„åŒå­¦å¯èƒ½å¾ˆç†Ÿæ‚‰äº†ï¼Œæ¯”å¦‚ <code>VS</code>/<code>C#</code> çš„è‡ªåŠ¨å¯¼å…¥å‘½åç©ºé—´ã€<code>Code Refactor</code>ï¼ˆé‡å‘½åå±æ€§/æ–¹æ³•/ç±»åç­‰æ ‡è¯†ç¬¦ï¼Œå¹¶è‡ªåŠ¨ä¿®æ”¹æ‰€æœ‰çš„å¼•ç”¨ï¼‰ã€è½¬åˆ°å®šä¹‰ï¼ˆè½¬åˆ°å£°æ˜ã€æŸ¥æ‰¾å¼•ç”¨ï¼‰ç”šè‡³ä»£ç æ®µæå–ï¼ˆæå–ä¸€æ®µä»£ç ä½œä¸ºä¸€ä¸ªå‡½æ•°ï¼Œå¹¶è‡ªåŠ¨å°†ä¾èµ–çš„å˜é‡ä½œä¸ºå‚æ•°è¾“å…¥ï¼‰ç­‰å„ç§å¼ºå¤§çš„åŠŸèƒ½ã€‚</p>
<p>è€Œ <code>JS</code> æ˜¯ä¸€ä¸ªåŠ¨æ€ç±»å‹çš„è¯­è¨€ï¼Œä¸ºäº†æ”¯æŒä¸Šè¿°åŠŸèƒ½ï¼Œ<code>VS Code</code> å›¢é˜Ÿå¼€å‘äº†ä¸€ä¸ªæ’ä»¶ï¼Œåä¸º <code>Visual Studio IntelliCode</code>ï¼Œæœ€æ—©è¯¥æ’ä»¶æ˜¯ä½œä¸ºä¸€ä¸ªå¤–éƒ¨æ‰©å±•ï¼Œåæ¥ç›´æ¥ä½œä¸ºå†…éƒ¨æ‰©å±•ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚</p>
<p>ä»¥ä¸‹æ‘˜è‡ªå®˜ç½‘æè¿°ï¼š</p>
<blockquote>
<p>IntelliSense is a general term for a variety of code editing features including: code completion, parameter info, quick info, and member lists. IntelliSense features are sometimes called by other names such as &quot;code completion&quot;, &quot;content assist&quot;, and &quot;code hinting.&quot;</p>
</blockquote>
<p>è¹©è„šç¿»è¯‘å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>æ™ºèƒ½æ„ŸçŸ¥æ˜¯ä¸€ç³»åˆ—ç¼–ç ç‰¹æ€§çš„ç»Ÿç§°ï¼ŒåŒ…æ‹¬è‡ªåŠ¨è¡¥å…¨ã€å‚æ•°æç¤ºã€å¿«æ·ä¿¡æ¯ä»¥åŠæˆå‘˜æç¤ºã€‚â€¦â€¦</p>
</blockquote>
<p><strong>ç‰¹åˆ«æ³¨æ„</strong>ï¼šåœ¨æˆå‘˜æç¤ºè¢«å…³é—­çš„æƒ…å†µä¸‹å¯ä»¥ä½¿ç”¨å¿«æ·é”® <code>Ctrl</code>+<code>Space</code> é‡æ–°æ‰“å¼€æˆå‘˜æç¤ºï¼ˆæå¤§çš„å¯èƒ½ä¸ <code>Windows</code> ç³»ç»Ÿé»˜è®¤çš„è¾“å…¥æ³•åˆ‡æ¢é”®å†²çªå¯¼è‡´å¤±æ•ˆï¼Œæ­¤æ—¶å¯ä»¥è€ƒè™‘æ›´æ¢å¿«æ·é”®ï¼‰ï¼Œä¸ <code>Ctrl</code>+<code>Shift</code>+<code>Space</code> æ‰“å¼€å‚æ•°æç¤ºã€‚</p>
<h2 id="é…ç½®-jsconfigjson"><a class="header" href="#é…ç½®-jsconfigjson">é…ç½® <code>jsconfig.json</code></a></h2>
<p>é¦–å…ˆè¦è¯´çš„æ˜¯ <code>jsconfig.json</code> æ–‡ä»¶ã€‚ç”¨ <code>vue</code> è„šæ‰‹æ¶ç”Ÿæˆçš„é¡¹ç›®ä¸­ï¼Œå¹¶æ— è¯¥æ–‡ä»¶ï¼Œä¸”ä¸€èˆ¬æƒ…å†µä¸‹æ²¡æœ‰è¯¥æ–‡ä»¶ä¹Ÿä¼šæœ‰ <code>IntelliSense</code> åŠŸèƒ½ã€‚</p>
<p>è¿™é‡Œé…ç½® <code>jsconfig.json</code> çš„å¿…è¦åŸå› æ˜¯ï¼š</p>
<ol>
<li>æ— è¯¥æ–‡ä»¶ä¼šå¯¼è‡´é¡¹ç›®å†…çš„ <code>.d.ts</code> æ–‡ä»¶ä¸ä¸€å®šè¢«åŠ è½½ï¼›</li>
<li>å¯¹äº <code>Vue</code> é¡¹ç›®æ¥è¯´ï¼Œå¯¼å…¥æ—¶ä½¿ç”¨ <code>@</code> æ˜¯å¾ˆå¸¸è§çš„è¡Œä¸ºï¼Œä½†æ˜¯è¿™å°†ä¼šå¯¼è‡´ <code>IntelliSense</code> æ— æ³•è¯†åˆ«ã€‚</li>
</ol>
<p>ä¸€ä¸ªå¸¸è§çš„ <code>jsconfig.json</code> é…ç½®å¦‚ä¸‹ï¼š</p>
<pre><code class="language-json">{
  &quot;compilerOptions&quot;: {
    &quot;baseUrl&quot;: &quot;.&quot;,
    &quot;paths&quot;: {
      &quot;@/*&quot;: [
        &quot;src/*&quot;
      ]
    }
  },
  &quot;include&quot;: [
    &quot;./src/**/*.d.ts&quot;,
    &quot;./src/**/*.js&quot;,
    &quot;./src/**/*.vue&quot;
  ]
}
</code></pre>
<p>è¿™ä¸ª <code>jsconfig.json</code> åŒ…å«äº†å¯¹å¯¼å…¥æ—¶ <code>@</code> çš„è§£æä»¥åŠæ‰«æé¡¹ç›® <code>src</code> ç›®å½•åŠå…¶å­ç›®å½•ä¸‹çš„ <code>.d.ts</code>ã€<code>.js</code>ã€<code>.vue</code> æ–‡ä»¶ï¼Œä»¥å»ºç«‹ç±»å‹ã€å¼•ç”¨ç­‰ç›¸å…³ä¿¡æ¯ï¼ˆè½¬åˆ°å®šä¹‰ã€æŸ¥æ‰¾å¼•ç”¨ä»¥åŠè‡ªåŠ¨å¯¼å…¥çš„å…³é”®ï¼‰ã€‚</p>
<p>é…ç½®å®Œæˆåé‡æ–°åŠ è½½ï¼ˆ<code>Ctrl</code>+<code>Shift</code>+<code>P</code> è¾“å…¥ <code>Reload Window</code> å¹¶å›è½¦ï¼‰å³å¯ã€‚æ­¤æ—¶è¾“å…¥ <code>import '@/'</code> åä¼šæœ‰è·¯å¾„æç¤ºï¼ˆå¦‚æœæ²¡æœ‰å¯èƒ½æ˜¯è¿˜æ²¡æœ‰åŠ è½½å®Œæˆï¼Œè€å¿ƒç­‰å¾…ä¸€ä¼šå„¿ -.-ï¼‰ã€‚</p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/import-list.png" alt="å¯¼å…¥æç¤º" /></p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¯¼å…¥ <code>SFC</code> æ–‡ä»¶æ—¶ï¼Œæ–‡ä»¶çš„è·¯å¾„å¿…é¡»æ·»åŠ  <code>.vue</code> åç¼€ï¼š</p>
<pre><code class="language-javascript">import FieldEdit from '@/components/FieldEdit.vue'
</code></pre>
<p>è¿™æ ·çš„è¯ä½ å°±å¯ä»¥å°†å…‰æ ‡ç§»åŠ¨åˆ°ç»„ä»¶åç§°ä¸ŠæŒ‰ä¸‹ <code>F12</code> é”®ä»¥å¯¼èˆªåˆ°ç»„ä»¶çš„å®šä¹‰ï¼Œå¦åˆ™æ˜¯æ— æ³•å¯¼èˆªåˆ°ç»„ä»¶å®šä¹‰çš„ï¼Œä½ ä¼šçœ‹åˆ°è¿™æ ·çš„æç¤ºï¼š</p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/component-not-found.png" alt="å¯¼èˆªå¤±è´¥" /></p>
<p>å¦å¤–ï¼Œé…ç½®å®Œæˆåï¼Œè¿˜å¯ä»¥åœ¨ <code>&lt;template&gt;</code> æ ‡ç­¾ä¸­å¾—åˆ°è‡ªå®šä¹‰ç»„ä»¶çš„è¡¥å…¨æç¤ºï¼Œå¦‚æœæ²¡æœ‰å¯¼å…¥ï¼Œç”šè‡³å¯ä»¥åœ¨æ•²å›è½¦è¡¥å…¨æ—¶è‡ªåŠ¨å¯¼å…¥ï¼š</p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/component-list.png" alt="å¯¼èˆªå¤±è´¥" /></p>
<p>è‡³äºæç¤ºçš„ç»„ä»¶çš„å‘½åæ–¹å¼å¯ä»¥åœ¨æ­¤å¤„é…ç½®ï¼Œå…·ä½“æ¯ä¸ªé€‰é¡¹éƒ½æœ‰æè¿°å°±ä¸è¯´äº†ï¼š</p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/tag-casing.png" alt="è§„åˆ™é…ç½®" /></p>
<h2 id="jsdoc-æ³¨é‡Š"><a class="header" href="#jsdoc-æ³¨é‡Š"><code>JSDoc</code> æ³¨é‡Š</a></h2>
<p>å³ä½¿ç”¨æ³¨é‡Šæ¥è¯´æ˜ä»£ç ã€‚åœ¨ <code>VS Code</code> ä¸­å¯ä»¥é€šè¿‡åœ¨ <code>js</code> ç±»å‹çš„æ–‡ä»¶ä¸­è¾“å…¥ <code>/**</code> æ¥è§¦å‘ <code>JSDoc</code> ä»£ç ç‰‡æ®µï¼Œä»¥ä¸‹æ˜¯ä¸€äº›å®ä¾‹ï¼š</p>
<pre><code class="language-javascript">/**
 * å¼•ç”¨æ•°æ®é¢å¤–çš„ä¿¡æ¯å‘ç”Ÿäº†å˜åŒ–çš„äº‹ä»¶ã€‚
 */
const EVENT_ISSUE_INFO_CHANGE = 'issue-info-change'

/**
 * æ‰€å±çš„åº”ç”¨ç±»å‹ IDã€‚
 */
const ISSUE_TYPE = {
  /** éœ€æ±‚ã€‚ */
  REQUIREMENT: 1,
  /** ä»»åŠ¡ã€‚ */
  TASK: 2
}

/**
 * å°†ä¸€ä¸ªå­—ç¬¦ä¸²åè¿‡æ¥ã€‚
 * @param {string} str éœ€è¦åè½¬çš„å­—ç¬¦ä¸²ã€‚
 * @returns {string} åè½¬åçš„å­—ç¬¦ä¸²ã€‚
 */
function reverseString (str) {
  return str.split('').reverse().join('')
}
</code></pre>
<p>è¿™ç§æ³¨é‡Šå¯ä»¥æä¾›å¦‚ä¸‹çš„æ•ˆæœï¼Œåœ¨æˆå‘˜æç¤ºçš„åˆ—è¡¨ä¸­å¯ä»¥æ˜¾ç¤ºæ³¨é‡Šå†…å®¹ï¼Œå³åšåˆ°æ–‡æ¡£çš„æ•ˆæœï¼ˆåŒæ—¶é¼ æ ‡æ‚¬æµ®æ—¶ä¹Ÿä¼šæœ‰æ–‡æ¡£çš„æç¤ºï¼‰ï¼š</p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/member-list.png" alt="æˆå‘˜æç¤º" /></p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/function-annote.png" alt="å‡½æ•°å£°æ˜" /></p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬äºŒå¼ å›¾æ ‡æ³¨äº†ä¼ å…¥å‚æ•° <code>str</code> çš„ç±»å‹ï¼Œåœ¨è¾“å…¥ <code>str.sp</code> æ—¶ä¼šç»™äºˆæˆå‘˜æç¤ºï¼Œæ•²å›è½¦é”®åå³ä¼šè‡ªåŠ¨å®Œæˆã€‚</p>
<h2 id="ç±»å‹å£°æ˜æ–‡ä»¶"><a class="header" href="#ç±»å‹å£°æ˜æ–‡ä»¶">ç±»å‹å£°æ˜æ–‡ä»¶</a></h2>
<p>ç±»å‹å£°æ˜æ–‡ä»¶æ˜¯ä¸€ä¸ª <code>.d.ts</code> æ–‡ä»¶ï¼Œä½¿ç”¨è¿‡ <code>Type Script</code> çš„åŒå­¦åº”è¯¥ä¸é™Œç”Ÿï¼Œåœ¨ä½¿ç”¨ <code>Type Script</code> å¼€å‘åº“é¡¹ç›®æ—¶ï¼Œå¦‚æœéœ€è¦å‘å¸ƒåˆ° <code>npm</code> ä»“åº“ï¼Œåˆ™éœ€è¦ç¼–è¯‘æˆ <code>js</code> å‘å¸ƒï¼Œå¹¶å¯ä»¥ç”¨ <code>tsc</code> ç”Ÿæˆå¯¹åº”çš„ç±»å‹å£°æ˜æ–‡ä»¶ï¼Œä»¥ä¾›ä½¿ç”¨è€…å‚ç…§ã€‚</p>
<p>å¯¹äºæ²¡æœ‰ <code>Type Script</code> çš„ <code>Vue</code> é¡¹ç›®ï¼Œä»ç„¶å¯ä»¥ä½¿ç”¨ <code>.d.ts</code> æ–‡ä»¶å¸¦æ¥çš„éƒ¨åˆ†ä¾¿åˆ©ï¼Œè™½ç„¶éœ€è¦æ‰‹å†™ <code>.d.ts</code> æ–‡ä»¶ã€‚</p>
<p>ä¸€ä¸ª <code>.d.ts</code> æ–‡ä»¶çš„ä¾‹å­å¦‚ä¸‹ï¼š</p>
<pre><code class="language-typescript">/**
 * åº”ç”¨æ•°æ®çš„æ¨¡å‹ã€‚
 */
declare type IssueModel = {
  /**
   * åº”ç”¨æ•°æ®çš„å±æ€§å­—å…¸ã€‚
   */
  dataMap: {
    [key in IssuePropertyNames]: IssueProperty
  }

  /**
   * å¯ç¼–è¾‘çš„å±æ€§åç§°åˆ—è¡¨ã€‚
   */
  editablePropertyList: string[]
}

/**
 * åº”ç”¨æ•°æ®çš„æ•°æ®å±æ€§åç§°åˆ—è¡¨ã€‚
 */
declare type IssuePropertyNames =
  'id' |
  'issuetype' |
  'key' |
  'project' |
  'summary' |
  'description'

/**
 * åº”ç”¨æ•°æ®çš„å±æ€§å®šä¹‰ã€‚
 */
declare interface IssueProperty {
  /**
   * å±æ€§çš„åç§°ã€‚
   */
  name: string

  /**
   * å±æ€§å€¼çš„å¯è¯»å½¢å¼ã€‚
   */
  label: string

  /**
   * å±æ€§å€¼ã€‚
   */
  value: PropertyValue
}

/**
 * å±æ€§å€¼çš„ç±»å‹ã€‚
 */
declare type PropertyValue = boolean | number | string | boolean[] | number[] | string[]
</code></pre>
<p>ä¸Šè¿°ä»£ç å¹¶ä¸ä¼šç”Ÿæˆ <code>js</code> ä»£ç ï¼Œä»…ä»…åœ¨å¼€å‘æœŸé—´è¢«ç¼–è¾‘å™¨æˆ–é›†æˆå¼€å‘ç¯å¢ƒè¯†åˆ«ä»¥ç”¨ä½œä»£ç è‡ªåŠ¨å®Œæˆã€æˆå‘˜æç¤ºç­‰åŠŸèƒ½ã€‚åœ¨æ•°æ®ç»“æ„è¾ƒä¸ºå¤æ‚æ—¶ï¼Œå¯ä»¥åˆ©ç”¨ç±»å‹å£°æ˜æ–‡ä»¶ä½œä¸ºæ–‡æ¡£ä»¥æé«˜é¡¹ç›®çš„å¯ç»´æŠ¤æ€§ã€‚</p>
<p>è™½ç„¶ç±»å‹å£°æ˜æ–‡ä»¶ä¸å‚ä¸ <code>js</code> ä»£ç çš„æ‰§è¡Œï¼Œä½†æ˜¯ä»ç„¶å¯ä»¥åˆ©ç”¨ç±»å‹å£°æ˜æ–‡ä»¶å½±å“åˆ° <code>js</code> ä»£ç çš„ç¼–å†™ï¼Œå°†ä¸Šè¿°ç±»å‹å£°æ˜æ–‡ä»¶ä¿å­˜åï¼Œå³å¯åœ¨ <code>js</code> ä»£ç ä¸­ä»¥ <code>JSDoc</code> çš„å½¢å¼å¼•ç”¨ï¼š</p>
<pre><code class="language-javascript">/**
 * åº”ç”¨æ•°æ®æ¨¡å‹ã€‚
 * @type {IssueModel}
 */
const model = {
  dataMap: {
    issuetype: {
      value: ISSUE_TYPE.REQUIREMENT
    }
  }
}

console.log(model.dataMap.issuetype.value)
</code></pre>
<p>æ•ˆæœå¦‚ä¸‹ï¼š</p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/object-definition-member-list.png" alt="å¯¹è±¡æˆå‘˜" /></p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/object-ref-member-list.png" alt="å¯¹è±¡æˆå‘˜" /></p>
<h2 id="sfc-çš„æˆå‘˜ç±»å‹"><a class="header" href="#sfc-çš„æˆå‘˜ç±»å‹"><code>SFC</code> çš„æˆå‘˜ç±»å‹</a></h2>
<pre><code class="language-vue">&lt;template&gt;
  &lt;div&gt;
    &lt;input v-model=&quot;value&quot; @blur=&quot;handleInputBlur&quot; /&gt;
  &lt;/div&gt;
&lt;/template&gt;

&lt;script&gt;
export default {
  props: {
    /**
     * åº”ç”¨æ•°æ®æ¨¡å‹ã€‚
     * @type {import('vue').PropOptions&lt;IssueModel&gt;}
     */
    model: {
      type: Object,
      required: true
    },
    /**
     * éœ€è¦ç¼–è¾‘çš„å­—æ®µã€‚
     * @type {import('vue').PropOptions&lt;IssuePropertyNames&gt;}
     */
    property: {
      type: String,
      required: true
    }
  },
  data () {
    return {
      value: this.model.dataMap[this.property].value,
      /**
       * @type {IssueModel}
       */
      other: {}
    }
  },
  methods: {
    /**
     * è·å–å±æ€§å€¼ã€‚
     * @param {IssueModel} issue åº”ç”¨æ•°æ®æ¨¡å‹ã€‚
     * @param {IssuePropertyNames} property å±æ€§åç§°ã€‚
     * @returns {PropertyValue} å±æ€§å€¼ã€‚
     */
    getPropertyValue (issue, property) {
      issue.dataMap[property].value
    },
    handleInputBlur () {
      this.$emit('submit', this.model, this.property, this.value)
    }
  }
}
&lt;/script&gt;
</code></pre>
<p>ä¸Šé¢åˆ†åˆ«æ ‡è®°äº† <code>props</code>ã€<code>data</code>ã€<code>methods</code> çš„æ•°æ®ç±»å‹ã€å‚æ•°åŠè¿”å›å€¼ï¼Œåœ¨å¼•ç”¨è¿™äº›å±æ€§ã€å˜é‡æ—¶ï¼Œå°†ä¼šæœ‰è‡ªåŠ¨å®Œæˆæç¤ºã€å‚æ•°ä¿¡æ¯ç­‰ï¼š</p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/vue-member-list.png" alt="å¯¹è±¡æˆå‘˜" /></p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/vue-method-param.png" alt="å¯¹è±¡æˆå‘˜" /></p>
<h2 id="è‡ªåŠ¨å¯¼å…¥åŠŸèƒ½"><a class="header" href="#è‡ªåŠ¨å¯¼å…¥åŠŸèƒ½">è‡ªåŠ¨å¯¼å…¥åŠŸèƒ½</a></h2>
<p>åœ¨å¼•ç”¨ä¸€äº›å¸¸ç”¨çš„å¯¼å‡ºç¬¦å·æ—¶ï¼Œå¦‚æœè¿™ä¸ªç¬¦å·æ²¡æœ‰è¢«å¯¼å…¥ï¼Œåˆ™å¯ä»¥åœ¨æ‰“å¼€çš„æˆå‘˜æç¤ºä¸­æ‰¾åˆ°è¿™ä¸ªæ ‡è¯†ç¬¦ï¼Œå¹¶é”®å…¥å›è½¦å®Œæˆè‡ªåŠ¨è¡¥å…¨ï¼Œè¿™ä¸ªæ—¶å€™ä¼šè‡ªåŠ¨å¯¼å…¥è¿™ä¸ªæ ‡è¯†ç¬¦ï¼š</p>
<p><img src="posts/2020/11/13/./vsc-vue-intelli-sense/auto-import.png" alt="å¯¹è±¡æˆå‘˜" /></p>
<p>åœ¨æç¤ºä¿¡æ¯ä¸­è¯´æ˜äº† <code>Import 'ISSUE_TYPE' from module &quot;@/constatns/issueType&quot;</code>ï¼Œé”®å…¥å›è½¦å³å¯è‡ªåŠ¨å¯¼å…¥è¯¥æ ‡è¯†ç¬¦ã€‚</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="vuedraggable-ä½¿ç”¨é—®é¢˜è®°å½•"><a class="header" href="#vuedraggable-ä½¿ç”¨é—®é¢˜è®°å½•"><code>vuedraggable</code> ä½¿ç”¨é—®é¢˜è®°å½•</a></h1>
<ul>
<li>æœ¬æ–‡å¼•ç”¨çš„ <code>Sortable.js</code> æºç  <code>commit id</code> ä¸ºï¼š<code>1dff5e1</code></li>
<li>æœ¬æ–‡å¼•ç”¨çš„ <code>vuedraggable</code> æºç  <code>commit id</code> ä¸ºï¼š<code>2fd91d6</code></li>
</ul>
<p><code>vuedraggable</code> å®˜æ–¹åœ°å€ï¼š<a href="https://sortablejs.github.io/Vue.Draggable/">https://sortablejs.github.io/Vue.Draggable/</a></p>
<p><code>vuedraggable</code> æ˜¯ä¸€ä¸ªå°è£…äº† <code>Sortable.js</code> çš„ <code>vue</code> ç»„ä»¶ï¼Œå°†æ‹–åŠ¨åŒæ­¥åˆ°å¯¹åº”çš„æ•°æ®æ¨¡å‹ä¸Šï¼Œæä¾›äº† <code>Sortable.js</code> çš„æ‰€æœ‰ç‰¹æ€§ã€‚</p>
<p>ä½†æ˜¯ <code>vuedraggable</code> æä¾›çš„ <code>vue</code> ç»„ä»¶å¯¹åŠ¨æ€ç»‘å®šçš„å±æ€§å¹¶ä¸èƒ½è¾ƒå¥½çš„å…¼å®¹ï¼Œä¼šå¼•å‘ä¸€äº›è«åå¥‡å¦™çš„é—®é¢˜ã€‚</p>
<p>è€ƒè™‘ä¸€ä¸ªå…¸å‹çš„æ‹–åŠ¨åœºæ™¯ï¼Œæœ‰å¾…åŠã€è¿›è¡ŒåŠå®Œæˆä¸‰ä¸ªæ³³é“ï¼Œæ¯ä¸ªæ³³é“é‡Œé¢æœ‰è‹¥å¹²å¡ç‰‡ï¼Œå¾…åŠä¸­çš„å¡ç‰‡å¯ä»¥æ‹–åŠ¨åˆ°è¿›è¡Œçš„æ³³é“ï¼Œåä¹‹è¿›è¡Œçš„å¡ç‰‡åˆ™æ— æ³•æ‹–åŠ¨åˆ°å¾…åŠçš„æ³³é“ï¼Œè‹¥è¦åœ¨æ‹–åŠ¨æ—¶ï¼Œé«˜äº®æ˜¾ç¤ºå¯ä»¥æ”¾ç½®çš„æ³³é“ï¼Œåˆ™å¯ä»¥åœ¨ <code>start</code> äº‹ä»¶è®°å½•ä¸‹æ‹–åŠ¨çš„å¡ç‰‡ï¼Œé€šè¿‡åŒå‘ç»‘å®šè®¾ç½®æ˜¯å¦å¯ä»¥æ”¾ç½®çš„ç±»å <code>is-droppable</code>ã€‚</p>
<pre><code class="language-html">&lt;!-- is-droppable ç”¨äºè®¾ç½®æ‹–åŠ¨æ—¶ï¼Œå¯ä»¥æ”¾ç½®çš„æ ·å¼ï¼Œåœ¨æ‹–åŠ¨è¿‡ç¨‹ä¸­ï¼ŒisLaneDroppable å°†ä¼šè¿”å› trueï¼Œå¦åˆ™ä¸º false --&gt;
&lt;div :class=&quot;{ 'is-droppable': isLaneDroppable(item) }&quot;&gt;
    &lt;Draggable :sort=&quot;false&quot;&gt;
        &lt;div&gt;&lt;/div&gt;
    &lt;/Draggable&gt;
&lt;/div&gt;
</code></pre>
<p>åœ¨è¿™ç§ <code>draggable</code> ç»„ä»¶çš„çˆ¶çº§å…ƒç´ ç»‘å®šäº†åŠ¨æ€å±æ€§çš„æƒ…å†µä¸‹ï¼Œä¼šå¯¼è‡´ <code>sort</code> å±æ€§ä¸ç”Ÿæ•ˆï¼Œåˆæ­¥çŒœæµ‹æ˜¯ <code>DOM</code> ç»“æ„æ›´æ–°åï¼Œ<code>Sortable.js</code> æœªèƒ½åŒ¹é…ä¸Šï¼Œå¯¼è‡´ <code>sort</code> çš„åˆ¤æ–­å¤±æ•ˆã€‚</p>
<p>å› æ­¤ï¼Œåœ¨ä½¿ç”¨ <code>draggable</code> æ—¶ï¼Œ<strong>æœ€å¥½ä¸è¦åœ¨æ‹–åŠ¨çš„è¿‡ç¨‹ä¸­ï¼Œä¿®æ”¹åŠ¨æ€ç»‘å®šçš„å±æ€§çš„å€¼ï¼Œé¿å…æ‹–åŠ¨æ—¶æ›´æ–° <code>DOM</code></strong>ã€‚</p>
<p>é¿å…ä½¿ç”¨åŒå‘ç»‘å®šï¼ŒåŒæ—¶å†é…åˆ <code>start</code> äº‹ä»¶ï¼Œåœ¨è¯¥äº‹ä»¶ä¸­æ‰¾åˆ°æ‰€æœ‰å¯ä»¥æ”¾ç½®çš„æ³³é“ï¼Œå¹¶é€šè¿‡ç›´æ¥æ“ä½œ <code>DOM</code> çš„å½¢å¼ï¼Œç»™å¯ä»¥æ”¾ç½®çš„å…ƒç´ æ·»åŠ  <code>is-droppable</code> ç±»åå¯ä»¥è§£å†³è¯¥é—®é¢˜ã€‚</p>
<p>åœ¨è¯¥åœºæ™¯ä¸Šè€ƒè™‘å¦ä¸€ä¸ªé—®é¢˜ï¼Œè‹¥éœ€è¦åœ¨æ‹–åŠ¨æ—¶ï¼Œå½“å‰é¼ æ ‡æ‚¬åœçš„ã€å¯æ”¾ç½®çš„æ³³é“ä¸Šè®¾ç½®ä¸€ä¸ªæœ‰åˆ«äºå¯æ”¾ç½®çš„æ ·å¼ï¼ˆæ¯”æ–¹è¯´ï¼Œå¯æ”¾ç½®æ˜¯è™šçº¿è¾¹æ¡†ï¼Œæ‚¬åœçš„æ˜¯å®ç°è¾¹æ¡†ä¸”æœ‰èƒŒæ™¯è‰²ï¼‰ï¼ŒåŸºäºå…ˆå‰çš„ç»éªŒé¿å¼€ä½¿ç”¨åŒå‘ç»‘å®šçš„æ–¹æ³•ï¼Œç›´æ¥ä½¿ç”¨ <code>move</code> äº‹ä»¶æ“ä½œå¯¹åº”çš„ <code>DOM</code>ï¼Œæ·»åŠ  <code>is-target</code> ç±»åã€‚</p>
<p>æ­¤æ—¶ä¼šæœ‰ä¸€ä¸ªæ–°çš„é—®é¢˜ï¼Œå½“ <code>:sort=&quot;false&quot;</code> è§¦å‘æ—¶ï¼ˆå³ï¼Œé¼ æ ‡ç§»åŠ¨åˆ°åŸæ³³é“ä½†éå¡ç‰‡åŸä½ç½®ï¼Œå°†ä¼šè§¦å‘æ‹–åŠ¨çš„é‡ç½®ï¼Œæ­¤æ—¶å¡ç‰‡çš„å ä½ç¬¦å°†ä¼šå›åˆ°æ‹–åŠ¨å‰çš„ä½ç½®ï¼‰ï¼Œå°†ä¸ä¼šè§¦å‘ <code>move</code> äº‹ä»¶ï¼Œå³ï¼Œæ‚¬åœé«˜äº®å°†æ²¡åŠæ³•æ›´æ–°ï¼Œè¿˜æ˜¯ä¸ºåŸå…ˆè®¾ç½®çš„å…ƒç´ é«˜äº®ã€‚</p>
<p>æ£€æŸ¥ <code>Sortable.js</code> æºç çš„ <code>1287-1306</code> è¡Œï¼š</p>
<pre><code class="language-typescript">if (revert) {
    parentEl = rootEl; // actualization
    capture();

    this._hideClone();

    //@ts-ignore
    dragOverEvent(&quot;revert&quot;);

    //@ts-ignore
    if (!Sortable.eventCanceled) {
        if (nextEl) {
        rootEl.insertBefore(dragEl, nextEl);
        } else {
        rootEl.appendChild(dragEl);
        }
    }

    return completed(true);
}
</code></pre>
<p>å¯çŸ¥ï¼Œåœ¨æ‹–åŠ¨è¢«é‡ç½®æ—¶ï¼Œä¼šè§¦å‘ <code>revert</code> äº‹ä»¶ï¼Œæ£€æŸ¥ <code>dragOverEvent</code> å‡½æ•°çš„å®šä¹‰å¯çŸ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªåœ¨æ’ä»¶ä¸Šè§¦å‘çš„äº‹ä»¶ï¼Œè€Œé <code>Sortable.js</code> å®ä¾‹äº‹ä»¶ï¼Œå› æ­¤ï¼Œå¯ä»¥ç¼–å†™ä¸€ä¸ªæ’ä»¶ï¼Œç›‘å¬è¯¥äº‹ä»¶ï¼Œå¹¶å°†è¯¥äº‹ä»¶åœ¨å®ä¾‹ä¸Šè§¦å‘ï¼Œä¾¿å¯ä»¥è§£å†³è¯¥é—®é¢˜ã€‚</p>
<p>æ£€æŸ¥ <code>vuedraggable</code> æºä»£ç çš„ç¬¬ <code>197-228</code> è¡Œï¼š</p>
<pre><code class="language-javascript">mounted() {
    // ...

    !(&quot;draggable&quot; in options) &amp;&amp; (options.draggable = &quot;&gt;*&quot;);
    this._sortable = new Sortable(this.rootContainer, options);
    this.computeIndexes();
},
</code></pre>
<p>å¯ä»¥ä½¿ç”¨ä»¥ä¸‹çš„æ–¹æ³•è·å–å†…éƒ¨çš„ <code>Sortable.js</code> å¼•ç”¨ï¼š</p>
<pre><code class="language-javascript">import Vue from 'vue'
import Draggable from 'vuedraggable'

const Tmp = Vue.extend(Draggable)
const tmp = new Tmp().$mount()
const Sortable = tmp._sortable.constructor
</code></pre>
<p>å‚è€ƒ <code>on-spill</code> æ’ä»¶ï¼Œå¯ä»¥ç¼–å†™å‡ºå¦‚ä¸‹çš„æ’ä»¶ï¼š</p>
<pre><code class="language-javascript">function RevertEventPlugin () {}

RevertEventPlugin.prototype = {
  constructor: RevertEventPlugin,
  revertGlobal ({ dispatchSortableEvent }) {
    dispatchSortableEvent('revert')
  }
}

Object.assign(RevertEventPlugin, {
  pluginName: 'revertEventPlugin'
})
</code></pre>
<p>å°†ä»¥ä¸Šä¸¤éƒ¨å°è£…ä¸ºä¸€ä¸ªæ¨¡å—ï¼Œç”¨äºæ›¿ä»£ <code>vuedraggable</code> æ¨¡å—ï¼š</p>
<pre><code class="language-javascript">/*
 * æè¿°ï¼šè¿”å›ä¸€ä¸ªå¯ä»¥è§¦å‘ revert äº‹ä»¶çš„ vuedraggable ç»„ä»¶
 * æ–‡ä»¶åï¼šsrc/utils/vuedraggableWithRevert.js
 */

import Vue from 'vue'
import Draggable from 'vuedraggable'

function RevertEventPlugin () {}

RevertEventPlugin.prototype = {
  constructor: RevertEventPlugin,
  revertGlobal ({ dispatchSortableEvent }) {
    dispatchSortableEvent('revert')
  }
}

Object.assign(RevertEventPlugin, {
  pluginName: 'revertEventPlugin'
})

const getDraggableWithRevertEvent = () =&gt; {
  const Tmp = Vue.extend(Draggable)
  const tmp = new Tmp().$mount()
  const Sortable = tmp._sortable.constructor
  Sortable.mount(RevertEventPlugin)
  return Draggable
}

export default getDraggableWithRevertEvent()
</code></pre>
<p>åœ¨ä½¿ç”¨æ—¶ï¼Œç›´æ¥å°† <code>import Draggable from 'vuedraggable'</code> æ›¿æ¢ä¸º <code>import Draggable from './src/utils/vuedraggableWithRevert'</code> å³å¯ï¼Œè‹¥éœ€è¦ç›‘å¬ <code>revert</code> äº‹ä»¶ï¼Œæ·»åŠ ä¸€ä¸ªå…·æœ‰ <code>onRevert</code> å±æ€§çš„ <code>options</code>ã€‚</p>
<pre><code class="language-html">&lt;Draggable
    :sort=&quot;false&quot;
    :options=&quot;{ onRevert: handleCardItemRevert }&quot;
/&gt;
&lt;/Draggable&gt;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="ç©é¥¥è’è”æœºç‰ˆæ—¥å¿—"><a class="header" href="#ç©é¥¥è’è”æœºç‰ˆæ—¥å¿—">ç©é¥¥è’è”æœºç‰ˆæ—¥å¿—</a></h1>
<h2 id="æ­å»ºç‹¬ç«‹æœåŠ¡å™¨"><a class="header" href="#æ­å»ºç‹¬ç«‹æœåŠ¡å™¨">æ­å»ºç‹¬ç«‹æœåŠ¡å™¨</a></h2>
<ol>
<li>
<p>å®‰è£… <code>SteamCMD</code>ã€‚é¦–å…ˆåˆ›å»º <code>steam</code> ç”¨æˆ·ï¼Œç„¶åä¸‹è½½ <code>SteamCMD</code>ï¼š<a href="https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz">https://steamcdn-a.akamaihd.net/client/installer/steamcmd_linux.tar.gz</a>Â è§£å‹å®‰è£…ï¼Œå®‰è£…ä½ç½®ä»»æ„ï¼Œè¯¦ç»†æ­¥éª¤åŠä¾èµ–å…³ç³»æ¨èå‚é˜…æ­¤å¤„ã€‚</p>
</li>
<li>
<p>è¿è¡ŒÂ <code>steamcmd.sh</code></p>
</li>
<li>
<p>ç™»é™†å¹¶å®‰è£…æœåŠ¡å™¨ï¼š</p>
<pre><code class="language-shell">login anonymous
force_install_dir /home/steam/dstserver
app_update 343050
validate
quit
</code></pre>
</li>
<li>
<p>é…ç½®æœåŠ¡å™¨ã€‚å¯åœ¨ <code>Windows</code> ä¸Šä½¿ç”¨å›¾å½¢ç•Œé¢å¯åŠ¨å…·æœ‰æ´ç©´çš„æœåŠ¡å™¨ï¼Œç„¶åæ¸…é™¤è¯¥å­˜æ¡£è®°å½•å¹¶å°†å…¶å¤åˆ¶åˆ° <code>/home/steam/.klei/DoNotStarveTogether</code>Â ç›®å½•ä¸­å³å¯ã€‚ä¹Ÿå¯ä»¥å…ˆå°†å­˜æ¡£å¤åˆ¶åˆ°ä¸Šè¿°ç›®å½•ï¼Œç„¶åä½¿ç”¨ä¸‹è¿°è„šæœ¬æ¸…é™¤å­˜æ¡£ï¼š</p>
<pre><code class="language-shell"># å…¶ä¸­ /home/steam/.klei/DoNotStarveTogether/GlxinWorld ä¸ºä¸–ç•Œå­˜æ¡£ç›®å½•
rm -rf /home/steam/.klei/DoNotStarveTogether/GlxinWorld/{Master,Caves}/save
</code></pre>
</li>
<li>
<p>å¯åŠ¨æœåŠ¡å™¨ã€‚</p>
<pre><code class="language-shell"># å¿…é¡»è¿›å…¥è¯¥ç›®å½•ï¼Œå¦åˆ™å¯èƒ½ä¼šæ— æ³•åŠ è½½
# å…¶ä¸­ Cluster_1 æ”¹ä¸ºå¯¹åº”çš„å­˜æ¡£åç§°
cd /home/steam/dstserver/bin
./dontstarve_dedicated_server_nullrenderer -console -cluster Cluster_1 -shard Caves
./dontstarve_dedicated_server_nullrenderer -console -cluster Cluster_1 -shard Master
</code></pre>
</li>
</ol>
<p>Tipï¼šæœ‰äº›ç³»ç»Ÿï¼ˆå¦‚ï¼š<code>CentOS 7</code>ï¼‰ä¸æä¾› <code>libcurl-gnutls.so.4</code> é‚£ä¹ˆå°†å…¶é“¾æ¥åˆ° <code>libcurl.so.4</code> å³å¯ã€‚</p>
<p>å¤šä¸–ç•Œå¹¶å­˜ï¼šè‹¥è¦åœ¨ä¸€å°æœåŠ¡å™¨ä¸Šè¿è¡Œå¤šä¸ªé¥¥è’æœåŠ¡å™¨ï¼Œåˆ™éœ€è¦ä¿®æ”¹å­˜æ¡£çš„ <code>Master</code> åŠ <code>Caves</code> ç›®å½•ä¸­ <code>server.ini</code> çš„ <code>server_port</code> ä½¿å…¶å„ä¸ç›¸åŒï¼Œä¸”åœ¨ <code>10998-11018</code> èŒƒå›´å†…ã€‚ä¸”æ¯ä¸ªå­˜æ¡£çš„ <code>cluster.ini</code> ä¸­ <code>master_port</code> åº”å”¯ä¸€ï¼Œè¯¥ç«¯å£ç”¨äºå­˜æ¡£çš„åœ°é¢ä¸æ´ç©´ä¹‹é—´é€šä¿¡ã€‚ é¥¥è’æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶åŒæ ·ä¼šç›‘å¬ <code>127.0.0.1:10888/UDP</code> ç«¯å£å’Œä¸€ä¸ªéå›ºå®š <code>TCP</code> ç«¯å£ï¼Œå¯èƒ½è¿™äº›ä¹Ÿéœ€è¦ä¿®æ”¹ã€‚åˆæ­¥çŒœæµ‹è¯¥ç«¯å£å¯èƒ½ç”¨äºå­˜æ¡£çš„åœ°é¢ä¸æ´ç©´ä¹‹é—´é€šä¿¡ï¼Œå¤šä¸ªå­˜æ¡£åº”ä¿®æ”¹è¯¥ç«¯å£ã€‚</p>
<p>è·¨æœåŠ¡å™¨ä¸–ç•Œï¼šå³å°†æ´ç©´æœåŠ¡å™¨ä¸åœ°é¢æœåŠ¡å™¨åˆ†ç¦»ï¼Œå°†å­˜æ¡£çš„ <code>cluster.ini</code> ä¸­ <code>master_ip</code> ä¸ <code>master_port</code> é…ç½®ä¸ºåœ°é¢æœåŠ¡å™¨çš„ IP åœ°å€å’Œç«¯å£å³å¯ã€‚</p>
<h2 id="ä¸€é”®å¯åŠ¨è„šæœ¬"><a class="header" href="#ä¸€é”®å¯åŠ¨è„šæœ¬">ä¸€é”®å¯åŠ¨è„šæœ¬</a></h2>
<p>å…¶ä¸­å˜é‡æŒ‰éœ€ä¿®æ”¹ï¼Œè‹¥ä¸å¸Œæœ›æ¯æ¬¡å¯åŠ¨éƒ½æ£€æŸ¥æ›´æ–°ï¼Œå°†è„šæœ¬ä¸­æ£€æŸ¥æ›´æ–°çš„è¡Œæ³¨é‡Šå³å¯ã€‚å¦å¤–ï¼Œæœ€æ–°ç‰ˆä¸è´­ä¹°å¯èƒ½å¯¼è‡´æœç´ ä¸åˆ°ä¸–ç•Œçš„é—®é¢˜ï¼Œæ•…å¯ä»¥æŒ‰ç…§ä¸‹ä¸€èŠ‚ä»‹ç»å®‰è£… <code>247691</code> ç‰ˆæœ¬ã€‚</p>
<pre><code class="language-shell">#!/bin/bash

steamcmd_dir=&quot;$HOME/Steam&quot;
install_dir=&quot;$HOME/dstserver&quot;
cluster_name=&quot;GlxinWorld&quot;
dontstarve_dir=&quot;$HOME/.klei/DoNotStarveTogether&quot;

function fail()
{
        echo Error: &quot;$@&quot; &gt;&amp;2
        exit 1
}

function check_for_file(){
    if [ ! -e &quot;$1&quot; ]; then
            fail &quot;Missing file: $1&quot;
    fi
}

cd &quot;$steamcmd_dir&quot; || fail &quot;Missing $steamcmd_dir directory!&quot;
check_for_file &quot;$steamcmd_dir/steamcmd.sh&quot;
check_for_file &quot;$dontstarve_dir/$cluster_name/cluster.ini&quot;
check_for_file &quot;$dontstarve_dir/$cluster_name/cluster_token.txt&quot;
check_for_file &quot;$dontstarve_dir/$cluster_name/Master/server.ini&quot;
check_for_file &quot;$dontstarve_dir/$cluster_name/Caves/server.ini&quot;

# æ£€æŸ¥æ›´æ–°ï¼Œè‹¥ä¸éœ€è¦æ¯æ¬¡å¯åŠ¨éƒ½æ£€æŸ¥æ›´æ–°ï¼Œå°†å…¶æ³¨é‡Šå³å¯
~/Steam/steamcmd.sh +force_install_dir &quot;$install_dir&quot; +login anonymous +app_update 343050 validate +quit

check_for_file &quot;$install_dir/bin&quot;

cd &quot;$install_dir/bin&quot; || fail
run_shared=(./dontstarve_dedicated_server_nullrenderer)
run_shared+=(-console)
run_shared+=(-cluster &quot;$cluster_name&quot;)
run_shared+=(-monitor_parent_process $$)

&quot;${run_shared[@]}&quot; -shard Caves  | sed 's/^/Caves:  /' &amp;
&quot;${run_shared[@]}&quot; -shard Master | sed 's/^/Master: /'
</code></pre>
<h2 id="ä¸‹è½½æŒ‡å®šç‰ˆæœ¬"><a class="header" href="#ä¸‹è½½æŒ‡å®šç‰ˆæœ¬">ä¸‹è½½æŒ‡å®šç‰ˆæœ¬</a></h2>
<ol>
<li>è¿›å…¥ <code>SteamDB</code> æŸ¥æ‰¾æ¸¸æˆï¼Œè®°å½• <code>AppID</code>ã€‚</li>
<li>è¿›å…¥ <code>Depots</code> æ‰¾åˆ°å¯¹åº”å¹³å°ï¼Œè®°å½• <code>DepotID</code>ã€‚</li>
<li>ç‚¹å‡» <code>DepotID</code> =&gt; <code>Manifests</code> æ‰¾åˆ°éœ€è¦çš„ç‰ˆæœ¬ï¼Œè®°å½• <code>ManifestID</code>ã€‚</li>
<li><code>Windows</code> ä¸‹è¿è¡Œ <code>steam://nav/console</code> è¿›å…¥æ§åˆ¶å°/<code>Linux</code> ä¸‹æ‰§è¡Œ <code>steamcmd.sh</code>ã€‚</li>
<li>è‹¥æ˜¯ <code>Linux</code> ç”¨æˆ·ï¼Œéœ€è¦æ‰§è¡Œ <code>login anonymous</code> ç™»é™†ï¼›è‹¥ä¸æ˜¯ <code>Linux</code> ç”¨æˆ·åˆ™è·³è¿‡ã€‚</li>
<li>æ‰§è¡Œ <code>download_depot &lt;AppID&gt; &lt;DepotID&gt; &lt;ManifestID&gt;</code> è¿›è¡Œä¸‹è½½ã€‚</li>
<li>æ‰§è¡Œ <code>quit</code> é€€å‡ºã€‚</li>
</ol>
<p>è‹¥ä¸‹è½½å¤±è´¥ï¼Œå¯é€€å‡ºä»ç¬¬ 4 æ­¥é‡æ–°å¼€å§‹ã€‚å®é™…æµ‹è¯•å‘ç°ï¼Œä¸‹è½½æˆåŠŸç‡éå¸¸ä½ï¼Œæ•…å»ºè®®ä½¿ç”¨å¤–ç½‘æœåŠ¡å™¨ï¼Œä¸”å…·æœ‰ä¸ä½çš„å¸¦å®½ã€‚</p>
<p>ä¸Šè¿°è¿‡ç¨‹å¾—åˆ° DST çš„ä¿¡æ¯å¦‚ä¸‹ï¼š</p>
<ul>
<li>AppID: 343050</li>
<li>Linux DepotID: 343052</li>
<li>Latest Version ManifestID: 3637127330667398786</li>
<li>Version 247691 ManifestID: 6994825278996354537</li>
<li>SteamDB URL: <a href="https://steamdb.info/app/343050/">https://steamdb.info/app/343050/</a></li>
</ul>
<p>è¿›å…¥æ§åˆ¶å°ï¼ˆ<code>Win + R</code> è¿è¡Œï¼‰:</p>
<pre><code class="language-shell">steam://nav/console
</code></pre>
<p>ä¸‹è½½ <code>247691</code> ç‰ˆæœ¬æ¸¸æˆï¼š</p>
<pre><code class="language-shell">download_depot 343050 343052 6994825278996354537
</code></pre>
<p><code>Linux</code> å¯åœ¨æ§åˆ¶å°ç›´æ¥æ‰§è¡Œï¼š</p>
<pre><code class="language-shell">steamcmd.sh +login anonymous +download_depot 343050 343052 6994825278996354537 +quit
</code></pre>
<p><code>SteamCMD</code> æ ¹æ®æ¸¸æˆ <code>depot id</code> è¿›è¡Œå­˜å‚¨ï¼Œæ•…ä¸€ä¸ªæ¸¸æˆå¯ä¸‹è½½å¤šä¸ª <code>depot</code> å¯¹åº”çš„ç‰ˆæœ¬ï¼Œä½†æ¯ä¸ª <code>depot</code> ä»…èƒ½ä¸‹è½½ä¸€ä¸ª <code>manifest</code> å¯¹åº”çš„ç‰ˆæœ¬ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™-3"><a class="header" href="#å‚è€ƒèµ„æ–™-3">å‚è€ƒèµ„æ–™</a></h2>
<p><a href="https://gist.github.com/xPaw/fe7d275d31da14d70481">steam_commands</a>
<a href="https://developer.valvesoftware.com/wiki/SteamCMD">SteamCMD â€“ Valve Developer Community</a>
<a href="https://blessing.studio/deploy-dont-starve-together-dedicated-server/">é¥¥è’è”æœºç‰ˆç‹¬ç«‹æœåŠ¡å™¨æ­å»ºè¸©å‘è®°å½• â€“ Blessing Studio</a>
<a href="https://steamcn.com/t258082-1-1">ã€ç¤¾åŒºæŒ‡å—ç¿»è¯‘ã€‘å¦‚ä½•ä¸‹è½½æ—§ç‰ˆçš„æ¸¸æˆ â€“ å¹³å°ç ”è®¨ â€“ SteamCN è’¸æ±½åŠ¨åŠ› â€“ é©±åŠ¨æ­£ç‰ˆæ¸¸æˆçš„å¼•æ“ï¼</a>
<a href="https://steamcn.com/t258079-1-1">é€šè¿‡depotä¸‹è½½å¾—åˆ°æ—§ç‰ˆæ¸¸æˆåŠä¸€ä¸ªè¡ç”Ÿåº”ç”¨ â€“ å¹³å°ç ”è®¨ â€“ SteamCN è’¸æ±½åŠ¨åŠ› â€“ é©±åŠ¨æ­£ç‰ˆæ¸¸æˆçš„å¼•æ“ï¼</a>
<a href="https://www.reddit.com/r/Steam/comments/611h5e/guide_how_to_download_older_versions_of_a_game_on/">Guide: How to download older versions of a game on Steamï¼šSteam</a>
<a href="http://blog.ttionya.com/article-1235.html">é¥¥è’è”æœºç‹¬ç«‹æœåŠ¡å™¨æ­å»ºæ•™ç¨‹ï¼ˆä¸‰ï¼‰ï¼šé…ç½®ç¯‡ | å¤©å¤©ã®è¨˜äº‹ç°¿</a>
<a href="https://unix.stackexchange.com/questions/267118/create-udp-to-tcp-bridge-with-socat-netcat-to-relay-control-commands-for-vlc-med">Create UDP to TCP bridge with socat/netcat to relay control commands for vlc media-player â€“ Unix &amp; Linux Stack Exchange</a></p>
<h2 id="playing-outside-the-lan"><a class="header" href="#playing-outside-the-lan">Playing outside the LAN</a></h2>
<p>å¯¹æ¸¸æˆç«¯å£ <code>UDP 10998/10999</code> è¿›è¡Œè½¬å‘ï¼Œå¯å®ç°åœ¨å¤–ç½‘è¿›å…¥å†…ç½‘çš„æ¸¸æˆæœåŠ¡å™¨ã€‚å…¶ç®€å• <code>python2</code> è„šæœ¬å¦‚ä¸‹ï¼š</p>
<p>agent_v3.pyï¼š</p>
<pre><code class="language-python">#!/usr/bin/env python2
# -*- coding: utf-8 -*-

&quot;&quot;&quot;
Usage:
    agent.py -h | --help
    agent.py client [-p BASE_PORT]
    agent.py server [-p BASE_PORT]

Options:
    -h --help                       show this
    -p BASE_PORT, --port BASE_PORT  specify base port

Examples:
    agent.py client

&quot;&quot;&quot;


from threading import Thread
from docopt import docopt
from time import sleep
from socket import socket, AF_INET, SOCK_DGRAM

LOCALHOST_IP = '127.0.0.1'
MASTER_IP_ADDRESS = '172.18.135.5'
MASTER_PORT = 10999
CAVES_IP_ADDRESS = '172.18.135.5'
CAVES_PORT = 10998

BASE_TRANSFER_PORT = 10001

BUFFER_SIZE = 10485760


def remote_to_local(sock_local, sock_remote, addr, buffsize):
    while True:
        data = sock_remote.recv(buffsize)
        if len(data):
            sock_local.sendto(data, )
    pass


def local_to_remote(local, remote, buffsize):
    conn_dict = {}
    sock_local = socket(AF_INET, SOCK_DGRAM)
    sock_local.bind(local)
    sock_remote = None
    while True:
        data, addr = sock_local.recvfrom(buffsize)
        if addr in conn_dict:
            sock_remote = conn_dict[addr]
        else:
            sock_remote = socket(AF_INET, SOCK_DGRAM)
            sock_remote.connect(remote)
            Thread(target=remote_to_local, args=(sock_local, sock_remote, addr, buffsize))
        sock_remote.sendall(data)


def build_connection(local, remote, buffsize):
    thread = Thread(target=local_to_remote, args=(local, remote, buffsize))
    thread.setDaemon(True)
    thread.start()


def check_connection(conns):
    for conn in conns:
        if not conn['t_l2r'].isAlive():
            return False
        if not conn['t_r2l'].isAlive():
            return False
    return True


def main(client_mode, base_port):
    master_listen, master_remote = None, None
    caves_listen, caves_remote = None, None
    if client_mode:
        master_listen = ('0.0.0.0', MASTER_PORT)
        master_remote = (MASTER_IP_ADDRESS, base_port)
        caves_listen = ('0.0.0.0', CAVES_PORT)
        caves_remote = (CAVES_IP_ADDRESS, base_port + 1)
    else:
        master_listen = ('0.0.0.0', base_port)
        master_remote = (LOCALHOST_IP, MASTER_PORT)
        caves_listen = ('0.0.0.0', base_port + 1)
        caves_remote = (LOCALHOST_IP, CAVES_PORT)
    conns = []
    conns.append(build_connection(master_listen, master_remote, BUFFER_SIZE))
    conns.append(build_connection(caves_listen, caves_remote, BUFFER_SIZE))

    try:
        while check_connection(conns):
            sleep(1)
    except KeyboardInterrupt as e:
        print 'User interrupted'

    return None


if __name__ == '__main__':
    arguments = docopt(__doc__)
    main(arguments['client'], int(arguments['--port'] or BASE_TRANSFER_PORT))
</code></pre>
<p>è„šæœ¬ä¾èµ– docoptã€‚</p>
<p>forward_v1.pyï¼š</p>
<pre><code class="language-python">#!/usr/bin/python2
# coding: utf-8


import sys

from time import sleep
from Queue import Queue
from select import select
from socket import socket, AF_INET, SOCK_DGRAM, SOL_SOCKET, SO_REUSEADDR

# 512KB
BUFFER_SIZE = 524288

LEVEL_INFO = 0
LEVEL_ERROR = 1


def log(level, text):
    if level == LEVEL_ERROR:
        print text


def do_forwarding(options):
    sock_remote = socket(AF_INET, SOCK_DGRAM)
    sock_remote.setblocking(False)
    sock_remote.setsockopt(SOL_SOCKET, SO_REUSEADDR, 1)
    sock_remote.bind(options[&quot;bind&quot;])

    connections = {}

    inputs = [sock_remote]
    outputs = []
    msg_queues = []

    while True:
        try:
            readable, writable, exceptional = select(inputs, outputs, [], 0.1)
        except KeyboardInterrupt:
            break
        if not (readable or writable or exceptional):
            continue
        for sock in readable:
            try:
                data, address = sock.recvfrom(BUFFER_SIZE)
            except Exception, ex:
                log(LEVEL_ERROR, 'Error: ' + repr(ex))
            if len(data) == 0:
                continue
            log(LEVEL_INFO, 'Received from: ' + repr(address))
            sleep
            if sock is sock_remote:
                if address in connections:
                    sock_out = connections[address]
                    log(LEVEL_INFO, 'Host already exists: ' + repr(address))
                else:
                    sock_out = socket(AF_INET, SOCK_DGRAM)
                    sock_out.connect(options[&quot;host&quot;])
                    connections[address] = sock_out
                    inputs.append(sock_out)
                    log(LEVEL_INFO, 'Added remote host: ' + repr(address))
                addr_out = options[&quot;host&quot;]
            else:
                for src_addr, src_sock in connections.iteritems():
                    if src_sock is sock:
                        addr_out = src_addr
                sock_out = sock_remote
            msg_queues.append({ &quot;to&quot;: addr_out, &quot;sock&quot;: sock_out, &quot;data&quot;: data })
            outputs.append(sock_out)
            log(LEVEL_INFO, 'Add sock to output list: ' + repr(sock_out.getsockname()))
        for sock in writable:
            log(LEVEL_INFO, 'Sock want to send data: ' + repr(sock.getsockname()))
            remains_msgs = []
            for msg in msg_queues:
                if msg[&quot;sock&quot;] is sock:
                    log(LEVEL_INFO, 'Hint message')
                    try:
                        sock.sendto(msg[&quot;data&quot;], msg[&quot;to&quot;])
                        log(LEVEL_INFO, 'Sent to: ' + repr(msg[&quot;to&quot;]) + ' via: ' + repr(sock.getsockname()))
                    except Exception, ex:
                        log(LEVEL_ERROR, 'Error: ' + repr(ex))
                else:
                    remains_msgs.append(msg)
            msg_queues = remains_msgs
        if writable:
            outputs = []

    for addr, sock in connections.iteritems():
        sock.close()
    sock_remote.close()


def parse_arguments(args):
    if len(args) != 2:
        return None
    params = args[1].split(':')
    options = { &quot;agent_port&quot;: 12345 }
    if len(params) == 3:
        options[&quot;bind&quot;] = &quot;127.0.0.1&quot;, int(params[0])
        options[&quot;host&quot;] = params[1], int(params[2])
    elif len(params) == 4:
        options[&quot;bind&quot;] = params[0], int(params[1])
        options[&quot;host&quot;] = params[2], int(params[3])
    else:
        return None
    return options


def usage():
    print &quot;Usage: forward.py [bind_ip:]bind_port:host_ip:host_port&quot;
    exit(1)


def main():
    options = parse_arguments(sys.argv)
    if options:
        do_forwarding(options)
    else:
        usage()


if __name__ == '__main__':
    main()
</code></pre>
<p><code>Server</code> ç«¯ç›‘å¬éœ€è¦è½¬å‘çš„ç«¯å£ï¼Œå¹¶æ¥å—å¤šæ¡è¿æ¥ï¼Œå»ºç«‹è¡¨ç»´æŠ¤è¿æ¥ä¿¡æ¯ï¼Œåœ¨æ¥æ”¶åˆ°æ•°æ®æ—¶è¿å¸¦è¿æ¥ä¿¡æ¯å‘é€ç»™è¿æ¥åˆ° <code>Server</code> ç«¯çš„ <code>Client</code> ç«¯ã€‚</p>
<h2 id="é—®é¢˜-1"><a class="header" href="#é—®é¢˜-1">é—®é¢˜</a></h2>
<p>åœ¨å¯åŠ¨ <code>dontstarve_dedicated_server_nullrenderer</code> è¿›ç¨‹æ—¶ï¼Œå¯èƒ½é‡åˆ°å¦‚ä¸‹é”™è¯¯ï¼š</p>
<ul>
<li>
<p><code>[S_API FAIL] SteamAPI_Init() failed; SteamAPI_IsSteamRunning() failed.</code> å¿½ç•¥å³å¯ã€‚</p>
</li>
<li>
<p><code>Segmentation fault (core dumped)</code> å¯èƒ½æ˜¯æ¸¸æˆä¸­çš„ <code>steamclient.so</code> åº“æ–‡ä»¶ä¸ <code>SteamCMD</code> ä¸­çš„ <code>steamclient.so</code> æ–‡ä»¶ç‰ˆæœ¬ä¸åŒ¹é…å¯¼è‡´ã€‚åˆ é™¤è¯¥æ–‡ä»¶ï¼Œå¹¶å°† <code>SteamCMD</code> ä¸­çš„è¯¥æ–‡ä»¶é“¾æ¥åˆ°æ¸¸æˆä¸­è¯¥æ–‡ä»¶ã€‚</p>
<pre><code class="language-shell"># å°†æ¸¸æˆä¸­çš„ steamclient.so å¤‡ä»½ä¸º steamclient.so.bak åå°† SteamCMD ä¸­çš„ steamclient.so é“¾æ¥åˆ°æ¸¸æˆä¸­å¯¹åº”çš„ä½ç½®
# ä¸‹é¢å‘½ä»¤å‡å®š SteamCMD å®‰è£…åœ¨ /home/steam/Steamï¼Œé¥¥è’è”æœºç‰ˆå®‰è£…åœ¨ /home/steam/dstserver
cd /home/steam/dstserver/bin/lib32 mv steamclient.so{,.bak}
ln -s /home/steam/SteamCMD/linux32/steamclient.so /home/steam/dstserver/bin/lib32/steamclient.so
# è‹¥æ— æ³•è§£å†³é—®é¢˜ï¼Œåˆ™å¯ä»¥é€šè¿‡å¦‚ä¸‹å‘½ä»¤æ¢å¤
mv /home/steam/dstserver/bin/lib32/steamclient.so.bak /home/steam/dstserver/bin/lib32/steamclient.so
</code></pre>
<p>è‹¥è¿è¡Œä¸Šè¿°å‘½ä»¤è§£å†³é—®é¢˜åï¼Œåˆ™åº”å°†ä¸–ç•Œå¯åŠ¨è„šæœ¬ä¸­çš„æ›´æ–°æŒ‡ä»¤ç§»é™¤ã€‚è‹¥ä¸ç§»é™¤ï¼Œæ¸¸æˆçš„æ›´æ–°ã€æ ¡éªŒéƒ½ä¼šå°†ä¸Šè¿°ä¿®æ”¹è¦†ç›–ï¼Œä»è€Œå¯¼è‡´æ¸¸æˆæ— æ³•è¿è¡Œã€‚</p>
<pre><code class="language-shell"># åœ¨è„šæœ¬ä¸­æ‰¾åˆ°ä¸‹é¢è¿™ä¸€è¡Œï¼Œå¹¶å°†å…¶æ³¨é‡Š
#~/Steam/steamcmd.sh +force_install_dir &quot;$install_dir&quot; +login anonymous +app_update 343050 validate +quit
</code></pre>
</li>
</ul>
<h2 id="backup--restore"><a class="header" href="#backup--restore">Backup &amp; Restore</a></h2>
<h3 id="backup"><a class="header" href="#backup">Backup</a></h3>
<pre><code class="language-shell"># è¿›å…¥å­˜æ¡£ç›®å½•
cd /home/steam/.klei/DoNotStarveTogether/GlxinWorld

# å»ºç«‹å­˜æ¡£å¤‡ä»½ç›®å½•
mkdir ../backup

# æ‰§è¡Œå¤‡ä»½
zip -r ../backup.$(date +%Y%m%d%H%M%S).zip .
</code></pre>
<h3 id="restore"><a class="header" href="#restore">Restore</a></h3>
<pre><code class="language-shell"># è¿›å…¥å­˜æ¡£ç›®å½•
cd /home/steam/.klei/DoNotStarveTogether/GlxinWorld

# åˆ—å‡ºå­˜æ¡£åˆ—è¡¨ï¼Œå¹¶æ‰¾å‡ºéœ€è¦æ¢å¤çš„å­˜æ¡£
ls ../backup

# æ¢å¤å­˜æ¡£
find . -delete &amp;&amp; unzip ../backup/backup.20180614173011.zip
</code></pre>
<h3 id="automatically-backup"><a class="header" href="#automatically-backup">Automatically backup</a></h3>
<p>åœ¨åŸºäº Systemd çš„ Linux ç³»ç»Ÿä¸Šï¼Œåˆ›å»ºå¦‚ä¸‹ä¸¤ä¸ªæ–‡ä»¶å®ç°æ¯ 3h å¯¹å­˜æ¡£åšä¸€æ¬¡å¤‡ä»½ã€‚ç”±äºåœ¨æ¸¸æˆè¿è¡ŒçŠ¶æ€ä¸­ï¼Œå­˜æ¡£ç›®å½•ä¼šåŒ…å«è®¸å¤šä¸´æ—¶æ–‡ä»¶ï¼Œ</p>
<p><code>/usr/lib/systemd/system/dst-backup.service</code>ï¼š</p>
<pre><code class="language-conf">[Unit]
Description=Don't Starve Together Backup

[Service]
Type=oneshot
ExecStart=/bin/bash -c 'cd /home/steam/.klei/DoNotStarveTogether/GlxinWorld &amp;&amp; zip -r ../backup/backup.$(date +%%Y%%m%%d%%H%%M%%S).zip .'
User=steam
</code></pre>
<p><code>/usr/lib/systemd/system/dst-auto-backup.timer</code>ï¼š</p>
<pre><code class="language-conf">[Unit]
Description=Don't Starve Together Auto Backup

[Timer]
OnUnitActiveSec=3h
Unit=dst-backup.service

[Install]
WantedBy=multi-user.target
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="chrome-æ—¶ä»£çš„æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•"><a class="header" href="#chrome-æ—¶ä»£çš„æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•">Chrome æ—¶ä»£çš„æµè§ˆå™¨å…¼å®¹æ€§æµ‹è¯•</a></h1>
<p>å¯¹äºè¿™ä¸ªæ ‡é¢˜ï¼Œæˆ‘æƒ³æœ‰ä¸€äº›äººæ˜¯å¾ˆæœ‰ç–‘æƒ‘çš„ï¼Œå¯¹äº <code>IE</code> æ—¶ä»£æ¥è¯´ï¼Œç¡®å®éœ€è¦å»ç ”ç©¶æµè§ˆå™¨çš„å…¼å®¹æ€§ï¼Œä½†æ˜¯å¯¹äºæµè§ˆå™¨ä¸­çš„è€å¤§ <code>Chrome</code>ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘å®ƒçš„å…¼å®¹æ€§å—ï¼Ÿ</p>
<p>å°±æˆ‘ç›®å‰åšçš„é¡¹ç›®ï¼Œç›®æ ‡ç”¨æˆ·éƒ½æ˜¯ä½¿ç”¨ <code>Chrome</code> æµè§ˆå™¨ï¼Œä½†æ˜¯ä»ç„¶åœ¨å·¥ä½œä¸­ç¢°åˆ°å¾ˆå¤šå…³äº <code>Chrome</code> çš„é—®é¢˜ï¼Œæ¯”å¦‚ï¼š</p>
<ul>
<li>ç”¨æˆ·åé¦ˆä½ ä»¬çš„è½¯ä»¶å¼€äº†ä¸€å¤©å°±å¡çš„ä¸è¡Œï¼Œæœ‰æ—¶å€™åŠå¤©ä¸åˆ°å°±ä¼šå´©æºƒï¼Œç„¶åä½ å­å“§å­å“§å»è§£å†³å†…å­˜æ³„æ¼çš„ç‚¹ï¼Œç„¶åè‡ªå·±æµ‹è¯•å‘ç°æ²¡é—®é¢˜ï¼Œä½†æ˜¯ä¸€ä¸Šçº¿ï¼Œå®¢æˆ·åˆåé¦ˆå¡å¡å¡ï¼ˆæµè§ˆå™¨å†…å­˜æ³„æ¼ï¼‰ï¼›</li>
<li>ç”¨æˆ·æœºå™¨ä¸Šï¼Œè¡¨æ ¼çš„æ¸²æŸ“æœ‰æ—¶ç¼ºä¸€æŸä¸€æ¡è¾¹æ¡†ï¼Œæœ‰æ—¶å€™æœ‰çš„è¾¹æ¡†ç‰¹åˆ«ç²—ï¼›</li>
<li>æ˜æ˜æ²¡æœ‰è®¾ç½® <code>z-index</code>ï¼Œæˆ–è€…è®¾ç½®äº†è¾ƒå°çš„ <code>z-index</code>ï¼Œä½†æ˜¯æ»šåŠ¨åˆ°å®¹å™¨ä¸‹é¢çš„æ—¶å€™ï¼Œè¢«é®ä½çš„é‚£éƒ¨åˆ†æ»šåŠ¨æ¡å´çªç ´äº†å®¹å™¨æ˜¾ç¤ºå‡ºæ¥äº†ï¼›</li>
<li>å¼€å‘æ—¶æ²¡è€ƒè™‘ <code>API</code> å…¼å®¹æ€§ï¼Œç”¨äº† <code>replaceAll</code>ï¼Œç„¶ååœ¨ç”¨æˆ·æœºå™¨ä¸ŠæŒ‚æ‰äº†ï¼›</li>
<li>å› ä¸ºè¦åµŒå…¥ç¬¬ä¸‰æ–¹é¡µé¢ï¼Œè€ƒè™‘åˆ° <code>Chrome</code> å˜æ›´äº† <code>SameSite</code> ç­–ç•¥ï¼Œé»˜è®¤ä¸º <code>None</code>ï¼Œéœ€è¦å…¼å®¹æ–°æ—§ç‰ˆæœ¬çš„ <code>Chrome</code>ï¼›</li>
<li><code>Chrome</code> åˆ é™¤äº† <code>/deep/</code> çš„æ”¯æŒï¼Œå¯¼è‡´é¡¹ç›®ä¸­é”™è¯¯ä½¿ç”¨ <code>/deep/</code> çš„åœ°æ–¹æ ·å¼å´©æºƒï¼›</li>
<li><code>Chrome</code> åœ¨æŸä¸ªç‰ˆæœ¬åˆ é™¤äº† <code>Event.path</code> çš„æ”¯æŒï¼Œç„¶åç”¨è¿™ä¸ªçš„åœ°æ–¹ä¹Ÿéƒ½å´©äº†ã€‚</li>
</ul>
<p>ä¸Šè¿°æƒ…å†µæœ‰äº›æ˜¯å±äº <code>bug</code>ï¼Œæœ‰äº›æ˜¯æµè§ˆå™¨æ›´æ–°å¤ªå¿«è€Œå¼€å‘äººå‘˜çŸ¥è¯†æ²¡æœ‰è·Ÿä¸Šï¼Œè¿˜æœ‰äº›å°±æ˜¯å•çº¯çš„å¼€å‘äººå‘˜çš„å¤±è¯¯ã€‚</p>
<p>åƒ <code>Event.path</code> å®é™…ä¸Šæ˜¯ä¸€ä¸ªéæ ‡å‡†å±æ€§ï¼Œåœ¨ <code>Chrome 100</code> ä¸Šè¿˜å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œåœ¨ <code>Chrome 101</code> çš„æ—¶å€™ï¼Œå¦‚æœä½ ä½¿ç”¨è¿™ä¸ªå±æ€§ï¼Œä¼šåœ¨ <code>Issues</code> é‡Œè¾“å‡ºä¸€ä¸ª <code>Deprecated Feature Used</code> çš„è­¦å‘Šã€‚ç„¶ååœ¨ <code>Chrome 104</code> é‡Œå°±ä¸èƒ½ç”¨äº†ã€‚ç„¶è€Œä½ é«˜å¼ºåº¦å¼€å‘çš„æ—¶å€™ï¼ŒçœŸçš„ä¼šåœ¨æ„è¿™ä¸ªè­¦å‘Šå—ï¼Ÿ</p>
<p>æ‰€ä»¥ï¼Œæµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜ä¸€ç›´éƒ½åœ¨ï¼Œåªä¸è¿‡ï¼Œä»å…¼å®¹ <code>IE</code> å˜æ¢ä¸ºå…¼å®¹è€ç‰ˆæœ¬ <code>Chrome</code> å’Œå…¼å®¹æ–°ç‰ˆæœ¬ <code>Chrome</code>ï¼Œä»¥åŠå…¼å®¹ç‰¹å®šç‰ˆæœ¬ <code>Chrome</code>ã€‚</p>
<p>å› æ­¤ï¼Œä½ å¯èƒ½ä¼šéœ€è¦é¢‘ç¹çš„ä¸‹è½½ä¸åŒç‰ˆæœ¬çš„ <code>Chrome</code> æ¥åšå„ç§å…¼å®¹æ€§æµ‹è¯•ï¼Œè¿™ä¹‹å‰å¯¹æˆ‘æ¥è¯´æ˜¯ä¸ªæ¯”è¾ƒéº»çƒ¦çš„äº‹ï¼Œæˆ‘ä¸å–œæ¬¢é€šè¿‡ç¬¬ä¸‰æ–¹ç½‘ç«™ä¸‹è½½çš„å®‰è£…åŒ…ï¼Œé€šè¿‡å®˜æ–¹ <code>Chromium</code> ç»™å‡ºçš„æ–¹æ³•åˆå¤ªéº»çƒ¦ã€‚</p>
<p>åæ¥æ— æ„é—´çœ‹åˆ°è¿™ä¸ªä»“åº“ï¼š<a href="https://github.com/google/fetchchromium">google/fetchchromium</a>ï¼Œä½†æ˜¯è¿™ä¸ªå·¥å…·éœ€è¦æä¾› <code>revision</code>ï¼Œä¸èƒ½é€šè¿‡ç‰ˆæœ¬å·ä¸‹è½½ï¼Œç„¶åæˆ‘å°±è‡ªå·±æäº†ä¸€ä¸ª <a href="https://github.com/hamflx/fetchbrowser">hamflx/fetchbrowser</a>ï¼Œå¯ä»¥é€šè¿‡ç»™å®šç‰ˆæœ¬å·ä¸‹è½½ç‰¹å®šçš„ <code>Chromium</code> æµè§ˆå™¨ï¼Œå¦å¤–ï¼Œä¹Ÿæ”¯æŒä¸‹è½½ <code>Firefox</code>ã€‚</p>
<h2 id="fetchbrowser"><a class="header" href="#fetchbrowser">fetchbrowser</a></h2>
<p>ä»“åº“åœ°å€ï¼š<a href="https://github.com/hamflx/fetchbrowser">https://github.com/hamflx/fetchbrowser</a>ï¼Œæ¬¢è¿ <code>star</code> (âÂ´â—¡`â)ã€‚</p>
<p>å®‰è£…æ–¹å¼ï¼š</p>
<pre><code class="language-powershell">irm https://raw.githubusercontent.com/hamflx/fetchbrowser/master/install.ps1 | iex
</code></pre>
<p>ä¸‹è½½ <code>Chromium 98</code>ï¼š</p>
<pre><code class="language-powershell">fb 98
</code></pre>
<p><strong>æ³¨æ„ï¼šåœ¨ç‰¹å®šå¹³å°ç¬¬ä¸€æ¬¡ä¸‹è½½ <code>Chromium</code> ä¼šæ¯”è¾ƒæ…¢ï¼Œå› ä¸ºä¼šè”æœºæŸ¥æ‰¾ç‰ˆæœ¬ä¿¡æ¯ï¼Œåç»­ä¼šä½¿ç”¨ç¼“å­˜çš„æ•°æ®ã€‚</strong></p>
<p>ä¸‹è½½ <code>Chromium 109.0.5414.120</code>ï¼š</p>
<pre><code class="language-powershell">fb 109.0.5414.120
</code></pre>
<p>ä¸‹è½½ <code>Firefox 98</code>ï¼š</p>
<pre><code class="language-powershell">fb --firefox 98
</code></pre>
<p>å¯¹ <code>Firefox</code> çš„æ”¯æŒå¯èƒ½ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸º <code>Firefox</code> å®˜æ–¹åªæä¾›äº†å®‰è£…åŒ…çš„å®‰è£…å½¢å¼ï¼Œè¿™é‡Œæ˜¯ä¸‹è½½äº†å®˜æ–¹çš„å®‰è£…åŒ…åè§£å‹å®ç°çš„ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
                <script>
                
                    document.body.querySelector('main').insertAdjacentHTML('beforeend', `
                        <div id="disqus_thread"></div>
                    `);
                    /**
                    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
                    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
                
                    var disqus_config = function () {
                    this.page.url = undefined;  // Replace PAGE_URL with your page's canonical URL variable
                    this.page.identifier = 'print.md'; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
                    };
                
                    (function() { // DON'T EDIT BELOW THIS LINE
                    var d = document, s = d.createElement('script');
                    s.src = 'https://hamflx-blog.disqus.com/embed.js';
                    s.setAttribute('data-timestamp', +new Date());
                    (d.head || d.body).appendChild(s);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                
                <!-- Global site tag (gtag.js) - Google Analytics -->
                <script async src="https://www.googletagmanager.com/gtag/js?id=G-8V723V89LY"></script>
                <script>
                  window.dataLayer = window.dataLayer || [];
                  function gtag(){dataLayer.push(arguments);}
                  gtag('js', new Date());
                
                  gtag('config', 'G-8V723V89LY');
                </script>
                
                <div class="icp">
                  <a class="icp-link" href="https://beian.miit.gov.cn/" target="_blank">çš–ICPå¤‡16015010å·-2</a>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
